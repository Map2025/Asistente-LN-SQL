-- Vista: GVA12_VENTAS
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, GVA12.COD_CLIENT AS COD_CLIENT, GVA12.COD_SUCURS AS COD_SUCURS, GVA12.COND_VTA AS COND_VTA, GVA12.T_COMP AS T_COMP, GVA12.N_COMP AS N_COMP, GVA12.IMPORTE AS IMPORTE, GVA12.PROPINA AS PROPINA, GVA12.COD_VENDED AS COD_VENDED, GVA12.COD_TRANSP AS COD_TRANSP, YEAR(GVA12.FECHA_EMIS) AS ANO, CASE WHEN MONTH(GVA12.FECHA_EMIS) = '1' THEN '01 Enero' WHEN MONTH(GVA12.FECHA_EMIS) = '2' THEN '02 Febrero' WHEN MONTH(GVA12.FECHA_EMIS) = '3' THEN '03 Marzo' WHEN MONTH(GVA12.FECHA_EMIS) = '4' THEN '04 Abril' WHEN MONTH(GVA12.FECHA_EMIS) = '5' THEN '05 Mayo' WHEN MONTH(GVA12.FECHA_EMIS) = '6' THEN '06 Junio' WHEN MONTH(GVA12.FECHA_EMIS) = '7' THEN '07 Julio' WHEN MONTH(GVA12.FECHA_EMIS) = '8' THEN '08 Agosto' WHEN MONTH(GVA12.FECHA_EMIS) = '9' THEN '09 Septiembre' WHEN MONTH(GVA12.FECHA_EMIS) = '10' THEN '10 Octubre' WHEN MONTH(GVA12.FECHA_EMIS) = '11' THEN '11 Noviembre' WHEN MONTH(GVA12.FECHA_EMIS) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA12.FECHA_EMIS) AS DIA, SUM(CASE WHEN GVA12.T_COMP <> 'FAC' AND GVA15.TIPO_COMP = 'C' THEN (-1) ELSE (1) END * CANTIDAD) AS UNIDADES, SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE (GVA53.IMP_NETO_P * GVA12.COTIZ) END)) AS TOTAL, CASE WHEN SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END)) < 0 THEN 0 ELSE SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END)) END AS TOTAL_BRUTO
FROM
    STA11
INNER JOIN
    GVA53
    ON GVA53.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    GVA12
    ON GVA53.T_COMP = GVA12.T_COMP AND GVA53.N_COMP = GVA12.N_COMP
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA12.T_COMP
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA22 DEPO_R
    ON GVA53.COD_DEPOSI = DEPO_R.COD_SUCURS
LEFT JOIN
    STA22 DEPO_E
    ON GVA12.COD_SUCURS = DEPO_E.COD_SUCURS
LEFT JOIN
    STA29 FAMILIA_ART
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    GVA81
    ON GVA81.COD_CLASIF = GVA53.COD_CLASIF
LEFT JOIN
    GVA81 CLASIFICACION_COMP
    ON CLASIFICACION_COMP.COD_CLASIF = GVA12.COD_CLASIF
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA12.ID_DIRECCION_ENTREGA
WHERE
    (GVA15.VENT_ART_C = 1) AND (GVA53.RENGL_PADR = 0 OR GVA53.INSUMO_KIT_SEPARADO = 1)
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, GVA12.COD_CLIENT, GVA12.COD_SUCURS, GVA12.COND_VTA, GVA12.T_COMP, GVA12.N_COMP, GVA12.IMPORTE, GVA12.PROPINA, GVA12.COD_VENDED, GVA12.FECHA_EMIS, GVA12.COD_TRANSP

GO

-- Vista: GVA12_CORRIENTE_VENTAS
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, GVA12.COD_CLIENT AS COD_CLIENT, GVA12.COD_SUCURS AS COD_SUCURS, GVA12.COND_VTA AS COND_VTA, GVA12.T_COMP AS T_COMP, GVA12.N_COMP AS N_COMP, GVA12.IMPORTE AS IMPORTE, GVA12.PROPINA AS PROPINA, GVA12.COD_VENDED AS COD_VENDED, GVA12.COD_TRANSP AS COD_TRANSP, YEAR(GVA12.FECHA_EMIS) AS ANO, CASE WHEN MONTH(GVA12.FECHA_EMIS) = '1' THEN '01 Enero' WHEN MONTH(GVA12.FECHA_EMIS) = '2' THEN '02 Febrero' WHEN MONTH(GVA12.FECHA_EMIS) = '3' THEN '03 Marzo' WHEN MONTH(GVA12.FECHA_EMIS) = '4' THEN '04 Abril' WHEN MONTH(GVA12.FECHA_EMIS) = '5' THEN '05 Mayo' WHEN MONTH(GVA12.FECHA_EMIS) = '6' THEN '06 Junio' WHEN MONTH(GVA12.FECHA_EMIS) = '7' THEN '07 Julio' WHEN MONTH(GVA12.FECHA_EMIS) = '8' THEN '08 Agosto' WHEN MONTH(GVA12.FECHA_EMIS) = '9' THEN '09 Septiembre' WHEN MONTH(GVA12.FECHA_EMIS) = '10' THEN '10 Octubre' WHEN MONTH(GVA12.FECHA_EMIS) = '11' THEN '11 Noviembre' WHEN MONTH(GVA12.FECHA_EMIS) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA12.FECHA_EMIS) AS DIA, SUM(CASE WHEN GVA12.T_COMP <> 'FAC' AND GVA15.TIPO_COMP = 'C' THEN (-1) ELSE (1) END * CANTIDAD) AS UNIDADES, SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END)) AS TOTAL, CASE WHEN SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END)) < 0 THEN 0 ELSE SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END)) END AS TOTAL_BRUTO
FROM
    STA11
INNER JOIN
    GVA53
    ON GVA53.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    GVA12
    ON GVA53.T_COMP = GVA12.T_COMP AND GVA53.N_COMP = GVA12.N_COMP
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA12.T_COMP
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA22 DEPO_R
    ON GVA53.COD_DEPOSI = DEPO_R.COD_SUCURS
LEFT JOIN
    STA22 DEPO_E
    ON GVA12.COD_SUCURS = DEPO_E.COD_SUCURS
LEFT JOIN
    STA29 FAMILIA_ART
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    GVA81
    ON GVA81.COD_CLASIF = GVA53.COD_CLASIF
LEFT JOIN
    GVA81 CLASIFICACION_COMP
    ON CLASIFICACION_COMP.COD_CLASIF = GVA12.COD_CLASIF
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA12.ID_DIRECCION_ENTREGA
WHERE
    (GVA15.VENT_ART_C = 1) AND (GVA53.RENGL_PADR = 0 OR GVA53.INSUMO_KIT_SEPARADO = 1) AND YEAR(GVA12.FECHA_EMIS) >= YEAR(GETDATE())
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, GVA12.COD_CLIENT, GVA12.COD_SUCURS, GVA12.COND_VTA, GVA12.T_COMP, GVA12.N_COMP, GVA12.IMPORTE, GVA12.PROPINA, GVA12.COD_VENDED, GVA12.FECHA_EMIS, GVA12.COD_TRANSP

GO

-- Vista: GVA12_FACTURAS_PENDIENTES_REMITIR
SELECT GVA12.COD_CLIENT AS COD_CLIENT, CASE GVA12.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, GVA12.T_COMP AS T_COMP, GVA12.N_COMP AS N_COMP, GVA12.TALONARIO AS TALONARIO, GVA12.FECHA_EMIS AS FECHA_EMIS, YEAR(GVA12.FECHA_EMIS) AS ANO, CASE WHEN MONTH(GVA12.FECHA_EMIS) = '1' THEN '01 Enero' WHEN MONTH(GVA12.FECHA_EMIS) = '2' THEN '02 Febrero' WHEN MONTH(GVA12.FECHA_EMIS) = '3' THEN '03 Marzo' WHEN MONTH(GVA12.FECHA_EMIS) = '4' THEN '04 Abril' WHEN MONTH(GVA12.FECHA_EMIS) = '5' THEN '05 Mayo' WHEN MONTH(GVA12.FECHA_EMIS) = '6' THEN '06 Junio' WHEN MONTH(GVA12.FECHA_EMIS) = '7' THEN '07 Julio' WHEN MONTH(GVA12.FECHA_EMIS) = '8' THEN '08 Agosto' WHEN MONTH(GVA12.FECHA_EMIS) = '9' THEN '09 Septiembre' WHEN MONTH(GVA12.FECHA_EMIS) = '10' THEN '10 Octubre' WHEN MONTH(GVA12.FECHA_EMIS) = '11' THEN '11 Noviembre' WHEN MONTH(GVA12.FECHA_EMIS) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA12.FECHA_EMIS) AS DIA, GVA12.COD_VENDED AS COD_VENDED, GVA23.NOMBRE_VEN AS NOMBRE_VEN, GVA12.COD_TRANSP AS COD_TRANSP, GVA24.NOMBRE_TRA AS NOMBRE_TRA, GVA14.COD_ZONA AS COD_ZONA, GVA05.NOMBRE_ZON AS NOMBRE_ZON, SUM(CASE Gva12.TComp_In_V WHEN 'CC' THEN (-1) ELSE 1 END * Gva53.Faltan_Rem * (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.PRECIO_NET ELSE (GVA53.PRECIO_NET * GVA12.Cotiz) END)) AS TOTAL_PENDIENTE
FROM
    GVA12
INNER JOIN
    GVA53
    ON GVA12.N_COMP = Gva53.N_Comp AND GVA12.T_COMP = Gva53.T_Comp
LEFT JOIN
    GVA81
    ON GVA81.COD_CLASIF = GVA12.COD_CLASIF
LEFT JOIN
    GVA14
    ON GVA12.COD_CLIENT <> '000000' AND GVA14.COD_CLIENT = GVA12.COD_CLIENT
LEFT JOIN
    GVA38
    ON GVA12.COD_CLIENT = '000000' AND GVA38.T_COMP = GVA12.T_COMP AND GVA38.N_COMP = GVA12.N_COMP
LEFT JOIN
    GVA18
    ON (GVA12.COD_CLIENT <> '000000' AND GVA14.COD_PROVIN = GVA18.COD_PROVIN) OR (GVA12.COD_CLIENT = '000000' AND GVA38.COD_PROVIN = GVA18.COD_PROVIN)
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
INNER JOIN
    GVA43
    ON GVA12.TALONARIO = Gva43.Talonario
LEFT JOIN
    GVA23
    ON Gva12.Cod_vended = GVA23.COD_VENDED
INNER JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
INNER JOIN
    GVA24
    ON GVA12.COD_TRANSP = GVA24.COD_TRANSP
INNER JOIN
    STA22
    ON GVA12.COD_SUCURS = STA22.COD_SUCURS
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA12.ID_DIRECCION_ENTREGA
WHERE
    GVA53.T_COMP = 'FAC' AND (GVA53.Faltan_Rem <> 0) AND ((GVA53.COD_ARTICU <> GVA53.COD_ARTICU_KIT) OR (GVA53.COD_ARTICU_KIT IS NULL))
GROUP BY
    GVA12.Cod_client, CASE GVA12.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END, GVA12.T_COMP, GVA12.N_COMP, GVA12.TALONARIO, GVA12.FECHA_EMIS, GVA12.COD_VENDED, GVA23.NOMBRE_VEN, GVA12.COD_TRANSP, GVA24.NOMBRE_TRA, GVA14.COD_ZONA, GVA05.NOMBRE_ZON, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA, GVA12.N_COMP

GO

-- Vista: GVA12_DETALLE_COMPROBANTES_VENTAS
SELECT GVA12.FECHA_EMIS AS FECHA_EMIS, YEAR(GVA12.FECHA_EMIS) AS ANO, CASE WHEN MONTH(GVA12.FECHA_EMIS) = '1' THEN '01 Enero' WHEN MONTH(GVA12.FECHA_EMIS) = '2' THEN '02 Febrero' WHEN MONTH(GVA12.FECHA_EMIS) = '3' THEN '03 Marzo' WHEN MONTH(GVA12.FECHA_EMIS) = '4' THEN '04 Abril' WHEN MONTH(GVA12.FECHA_EMIS) = '5' THEN '05 Mayo' WHEN MONTH(GVA12.FECHA_EMIS) = '6' THEN '06 Junio' WHEN MONTH(GVA12.FECHA_EMIS) = '7' THEN '07 Julio' WHEN MONTH(GVA12.FECHA_EMIS) = '8' THEN '08 Agosto' WHEN MONTH(GVA12.FECHA_EMIS) = '9' THEN '09 Septiembre' WHEN MONTH(GVA12.FECHA_EMIS) = '10' THEN '10 Octubre' WHEN MONTH(GVA12.FECHA_EMIS) = '11' THEN '11 Noviembre' WHEN MONTH(GVA12.FECHA_EMIS) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA12.FECHA_EMIS) AS DIA, GVA53.T_COMP AS T_COMP, GVA53.N_COMP AS N_COMP, GVA12.COD_VENDED AS COD_VENDED, CASE GVA12.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END AS NOMBRE_VEN, GVA12.COD_CLIENT AS COD_CLIENT, CASE GVA12.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, GVA53.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * GVA53.CANTIDAD) AS CANTIDAD, SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * CASE GVA12.Cotiz WHEN 0 THEN 0 ELSE CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END) WHEN 'BIORIGEN' THEN (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P / GVA12.COTIZ ELSE GVA53.IMP_NETO_P END) WHEN 'BICOTIZ' THEN (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P / 1 ELSE GVA53.IMP_NETO_P * GVA12.COTIZ / 1 END) END END) AS TOTAL
FROM
    GVA12(NOLOCK)
INNER JOIN
    GVA53(NOLOCK)
    ON GVA53.T_COMP = GVA12.T_COMP AND GVA53.N_COMP = GVA12.N_COMP
INNER JOIN
    GVA23(NOLOCK)
    ON GVA12.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    GVA14(NOLOCK)
    ON GVA12.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    STA11(NOLOCK)
    ON GVA53.COD_ARTICU = STA11.Cod_Articu
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA12.T_COMP
WHERE
    (GVA53.COD_ARTICU <> 'Art. Ajuste') AND (GVA53.COD_ARTICU <> '') AND (GVA53.RENGL_PADR = 0 OR GVA53.INSUMO_KIT_SEPARADO = 1)
GROUP BY
    GVA12.FECHA_EMIS, GVA53.T_Comp, GVA53.N_Comp, GVA12.COD_VENDED, CASE GVA12.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END, GVA12.COD_CLIENT, CASE GVA12.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END, GVA53.COD_ARTICU, STA11.DESCRIPCIO

GO

-- Vista: GVA12_DETALLE_COMPROBANTES_CORRIENTE_VENTAS
SELECT GVA12.FECHA_EMIS AS FECHA_EMIS, YEAR(GVA12.FECHA_EMIS) AS ANO, CASE WHEN MONTH(GVA12.FECHA_EMIS) = '1' THEN '01 Enero' WHEN MONTH(GVA12.FECHA_EMIS) = '2' THEN '02 Febrero' WHEN MONTH(GVA12.FECHA_EMIS) = '3' THEN '03 Marzo' WHEN MONTH(GVA12.FECHA_EMIS) = '4' THEN '04 Abril' WHEN MONTH(GVA12.FECHA_EMIS) = '5' THEN '05 Mayo' WHEN MONTH(GVA12.FECHA_EMIS) = '6' THEN '06 Junio' WHEN MONTH(GVA12.FECHA_EMIS) = '7' THEN '07 Julio' WHEN MONTH(GVA12.FECHA_EMIS) = '8' THEN '08 Agosto' WHEN MONTH(GVA12.FECHA_EMIS) = '9' THEN '09 Septiembre' WHEN MONTH(GVA12.FECHA_EMIS) = '10' THEN '10 Octubre' WHEN MONTH(GVA12.FECHA_EMIS) = '11' THEN '11 Noviembre' WHEN MONTH(GVA12.FECHA_EMIS) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA12.FECHA_EMIS) AS DIA, GVA53.T_COMP AS T_COMP, GVA53.N_COMP AS N_COMP, GVA12.COD_VENDED AS COD_VENDED, CASE GVA12.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END AS NOMBRE_VEN, GVA12.COD_CLIENT AS COD_CLIENT, CASE GVA12.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, GVA53.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * GVA53.CANTIDAD) AS CANTIDAD, SUM(CASE WHEN GVA12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * CASE GVA12.Cotiz WHEN 0 THEN 0 ELSE CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P ELSE GVA53.IMP_NETO_P * GVA12.COTIZ END) WHEN 'BIORIGEN' THEN (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P / GVA12.COTIZ ELSE GVA53.IMP_NETO_P END) WHEN 'BICOTIZ' THEN (CASE GVA12.MON_CTE WHEN 1 THEN GVA53.IMP_NETO_P / 1 ELSE GVA53.IMP_NETO_P * GVA12.COTIZ / 1 END) END END) AS TOTAL
FROM
    GVA12(NOLOCK)
INNER JOIN
    GVA53(NOLOCK)
    ON GVA53.T_COMP = GVA12.T_COMP AND GVA53.N_COMP = GVA12.N_COMP
INNER JOIN
    GVA23(NOLOCK)
    ON GVA12.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    GVA14(NOLOCK)
    ON GVA12.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    STA11(NOLOCK)
    ON GVA53.COD_ARTICU = STA11.Cod_Articu
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA12.T_COMP
WHERE
    (GVA53.COD_ARTICU <> 'Art. Ajuste') AND (GVA53.COD_ARTICU <> '') AND (YEAR(GVA12.FECHA_EMIS) >= YEAR(GETDATE())) AND (GVA53.RENGL_PADR = 0 OR GVA53.INSUMO_KIT_SEPARADO = 1)
GROUP BY
    GVA12.FECHA_EMIS, GVA53.T_Comp, GVA53.N_Comp, GVA12.COD_VENDED, CASE GVA12.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END, GVA12.COD_CLIENT, CASE GVA12.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END, GVA53.COD_ARTICU, STA11.DESCRIPCIO

GO

-- Vista: GVA38_REMITOS_PENDIENTES_FACTURAR
SELECT GVA14.COD_CLIENT AS COD_CLIENT, CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, Sta14.TALONARIO AS TALONARIO, Sta14.T_Comp AS T_Comp, Sta14.N_Comp AS N_Comp, STA14.FECHA_MOV AS FECHA_MOV, YEAR(STA14.FECHA_MOV) AS ANO, CASE WHEN MONTH(STA14.FECHA_MOV) = '1' THEN '01 Enero' WHEN MONTH(STA14.FECHA_MOV) = '2' THEN '02 Febrero' WHEN MONTH(STA14.FECHA_MOV) = '3' THEN '03 Marzo' WHEN MONTH(STA14.FECHA_MOV) = '4' THEN '04 Abril' WHEN MONTH(STA14.FECHA_MOV) = '5' THEN '05 Mayo' WHEN MONTH(STA14.FECHA_MOV) = '6' THEN '06 Junio' WHEN MONTH(STA14.FECHA_MOV) = '7' THEN '07 Julio' WHEN MONTH(STA14.FECHA_MOV) = '8' THEN '08 Agosto' WHEN MONTH(STA14.FECHA_MOV) = '9' THEN '09 Septiembre' WHEN MONTH(STA14.FECHA_MOV) = '10' THEN '10 Octubre' WHEN MONTH(STA14.FECHA_MOV) = '11' THEN '11 Noviembre' WHEN MONTH(STA14.FECHA_MOV) = '12' THEN '12 Diciembre' END AS MES, DAY(STA14.FECHA_MOV) AS DIA, STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, ISNULL(STA20.COD_DEPOSI, '') AS COD_DEPOSI, ISNULL(GVA24.NOMBRE_TRA, 'SIN TRANSPORTE') AS [Desc. transporte], GVA24.COD_TRANSP AS COD_TRANSP, SUM(STA20.CANTIDAD) AS CANTIDAD, SUM(Sta20.Cant_Pend - Sta20.Cant_Dev) AS CANTIDAD_PENDIENTE, SUM(STA20.CANTIDAD_2) AS CANTIDAD_2, SUM(Sta20.Cant_Pend_2 - Sta20.Cant_Dev_2) AS CANTIDAD_PENDIENTE_2, SUM((ISNULL(STA12.PRECIO_REP, 0) * (Sta20.Cant_Pend - Sta20.Cant_Dev))) AS PRECIO_REPOSICION, SUM((ISNULL(STA12.PRECIO_U_L, 0) * (Sta20.Cant_Pend - Sta20.Cant_Dev))) AS PRECIO_ULTIMA_COMPRA
FROM
    STA14
LEFT JOIN
    GVA14
    ON STA14.COD_PRO_CL <> '000000' AND STA14.COD_PRO_CL = GVA14.COD_CLIENT
LEFT JOIN
    GVA38
    ON STA14.COD_PRO_CL = '000000' AND GVA38.T_COMP = STA14.T_COMP AND GVA38.N_COMP = STA14.N_COMP
INNER JOIN
    GVA43
    ON STA14.TALONARIO = Gva43.Talonario
INNER JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
INNER JOIN
    GVA18
    ON (STA14.COD_PRO_CL <> '000000' AND GVA14.COD_PROVIN = GVA18.COD_PROVIN) OR (STA14.COD_PRO_CL = '000000' AND GVA38.COD_PROVIN = GVA18.COD_PROVIN)
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
LEFT JOIN
    GVA24
    ON STA14.COD_TRANSP = GVA24.COD_TRANSP
INNER JOIN
    STA20
    ON (Sta20.TComp_In_S = Sta14.TComp_In_S) AND (Sta20.NComp_In_S = Sta14.NComp_In_S)
INNER JOIN
    STA11
    ON STA11.COD_ARTICU = STA20.COD_ARTICU
LEFT JOIN
    STA12
    ON STA12.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    STA22
    ON STA22.COD_SUCURS = STA20.COD_DEPOSI
LEFT JOIN
    GVA12
    ON GVA12.T_COMP = STA14.T_COMP AND GVA12.N_COMP = STA14.N_COMP
LEFT JOIN
    GVA81
    ON STA14.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    GVA81 AS GVA81R
    ON GVA81R.COD_CLASIF = STA20.COD_CLASIF
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = STA20.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = STA20.ID_MEDIDA_STOCK_2
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = STA14.ID_DIRECCION_ENTREGA
WHERE
    (STA14.Estado_mov = 'P') AND ((Sta20.Cant_Pend - Sta20.Cant_Dev) <> 0) AND (Sta14.TComp_In_S = 'RE') AND (Sta14.Exportado = 0) AND STA20.RENGL_PADR = 0
GROUP BY
    GVA14.COD_CLIENT, CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END, Sta14.TALONARIO, GVA24.COD_TRANSP, Sta14.T_Comp, Sta14.N_Comp, STA14.FECHA_MOV, STA11.COD_ARTICU, STA11.DESCRIPCIO, ISNULL(STA20.COD_DEPOSI, ''), ISNULL(GVA24.NOMBRE_TRA, 'SIN TRANSPORTE')

GO

-- Vista: GVA12_RANKING_MOROSOS
SELECT GVA12.COD_CLIENT AS COD_CLIENT, GVA14.RAZON_SOCI AS RAZON_SOCI, GVA14.TELEFONO_1 AS TELEFONO_1, GVA14.COD_ZONA AS COD_ZONA, GVA05.NOMBRE_ZON AS NOMBRE_ZON, CASE 'BICLAUSU' WHEN 'BIMONCTE' THEN SUM(GVA46.IMPORTE_VT + ISNULL(IMPUTACIONES, 0)) WHEN 'BICLAUSU' THEN SUM(CASE GVA14.CLAUSULA WHEN 0 THEN GVA46.IMPORTE_VT + ISNULL(IMPUTACIONES, 0) ELSE 0 END) ELSE 0 END AS IMPORTE_PENDIENTE_MON_CTE, CASE 'BICLAUSU' WHEN 'BIORIGEN' THEN SUM(CASE WHEN GVA46.ESTADO_VTO <> 'PAG' THEN GVA46.IMP_VT_UNI + ISNULL(IMPUTACIONES_UNI, 0) ELSE 0 END) WHEN 'BICOTIZ' THEN SUM(CASE WHEN GVA46.ESTADO_VTO <> 'PAG' THEN CASE GVA14.CLAUSULA WHEN 1 THEN GVA46.IMP_VT_UNI + ISNULL(IMPUTACIONES_UNI, 0) ELSE DBO.SUMGVA12IMPORTES('BICOTIZ', GVA12.COTIZ, 1, CASE GVA14.CLAUSULA WHEN 1 THEN 'S' ELSE 'N' END, 'S', GVA15.TIPO_COMP, CASE GVA12.MON_CTE WHEN 1 THEN 'S' ELSE 'N' END, 0, 0, 6, GVA46.IMPORTE_VT + ISNULL(IMPUTACIONES, 0)) END ELSE 0 END) WHEN 'BICLAUSU' THEN SUM(CASE WHEN GVA46.ESTADO_UNI <> 'PAG' THEN CASE GVA14.CLAUSULA WHEN 1 THEN GVA46.IMP_VT_UNI + ISNULL(IMPUTACIONES_UNI, 0) ELSE 0 END ELSE 0 END) ELSE 0 END AS IMPORTE_PENDIENTE_MON_EXT
FROM
    GVA12
INNER JOIN
    GVA46
    ON GVA46.N_COMP = GVA12.N_COMP AND GVA46.T_COMP = GVA12.T_COMP
INNER JOIN
    GVA14
    ON GVA14.COD_CLIENT = GVA12.COD_CLIENT
LEFT JOIN
    GVA27
    ON GVA14.COD_CLIENT = GVA27.COD_CLIENT AND DEFECTO = 'S'
LEFT JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
LEFT JOIN
    GVA18
    ON GVA14.COD_PROVIN = GVA18.COD_PROVIN
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON COND.COND_VTA = GVA12.COND_VTA
LEFT JOIN
    GVA62
    ON GVA62.GRUPO_EMPR = GVA14.GRUPO_EMPR
LEFT JOIN
    (SELECT GVA07.T_COMP, GVA07.N_COMP, GVA07.FECHA_VTO, SUM(CASE GVA07.T_COMP_CAN WHEN 'REC' THEN -(GVA07.IMPORT_CAN) ELSE CASE GVA15.TIPO_COMP WHEN 'D' THEN +(GVA07.IMPORT_CAN) ELSE -(GVA07.IMPORT_CAN) END END) AS IMPUTACIONES, SUM(CASE GVA07.T_COMP_CAN WHEN 'REC' THEN -(GVA07.IMP_CAN_UN) ELSE CASE GVA15.TIPO_COMP WHEN 'D' THEN +(GVA07.IMP_CAN_UN) ELSE -(GVA07.IMP_CAN_UN) END END) AS IMPUTACIONES_UNI
FROM
    GVA07
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA07.T_COMP_CAN
GROUP BY
    GVA07.T_COMP, GVA07.N_COMP, GVA07.FECHA_VTO) AS IMPU
    ON IMPU.T_COMP = GVA12.T_COMP AND IMPU.N_COMP = GVA12.N_COMP AND IMPU.FECHA_VTO = GVA46.FECHA_VTO
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA12.T_COMP
LEFT JOIN
    SUCURSAL
    ON (GVA12.NRO_SUCURS = 0 AND SUCURSAL.NRO_SUCURSAL = (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) ) OR GVA12.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
WHERE
    ((GVA14.CLAUSULA = 0 AND GVA12.ESTADO = 'PEN') OR (GVA14.CLAUSULA = 1 AND GVA12.ESTADO_UNI = 'PEN')) AND ((GVA14.CLAUSULA = 0 AND GVA46.ESTADO_VTO <> 'PAG') OR (GVA14.CLAUSULA = 1 AND GVA46.ESTADO_UNI <> 'PAG')) AND GVA46.FECHA_VTO < CAST(CAST(CAST(GETDATE() AS real) AS int) AS datetime)
GROUP BY
    GVA12.COD_CLIENT, GVA14.RAZON_SOCI, GVA14.TELEFONO_1, GVA14.COD_ZONA, GVA05.NOMBRE_ZON

GO

-- Vista: GVA12_RANKING_DEUDORES_VENTAS
SELECT GVA12.COD_CLIENT AS COD_CLIENT, GVA14.RAZON_SOCI AS RAZON_SOCI, GVA14.TELEFONO_1 AS TELEFONO_1, GVA14.COD_ZONA AS COD_ZONA, GVA05.NOMBRE_ZON AS NOMBRE_ZON, CASE 'BICLAUSU' WHEN 'BIMONCTE' THEN SUM(GVA46.IMPORTE_VT + ISNULL(IMPUTACIONES, 0)) WHEN 'BICLAUSU' THEN SUM(CASE GVA14.CLAUSULA WHEN 0 THEN GVA46.IMPORTE_VT + ISNULL(IMPUTACIONES, 0) ELSE 0 END) ELSE 0 END AS IMPORTE_PENDIENTE_MON_CTE, CASE 'BICLAUSU' WHEN 'BIORIGEN' THEN SUM(CASE WHEN GVA46.ESTADO_VTO <> 'PAG' THEN GVA46.IMP_VT_UNI + ISNULL(IMPUTACIONES_UNI, 0) ELSE 0 END) WHEN 'BICOTIZ' THEN SUM(CASE WHEN GVA46.ESTADO_VTO <> 'PAG' THEN CASE GVA14.CLAUSULA WHEN 1 THEN GVA46.IMP_VT_UNI + ISNULL(IMPUTACIONES_UNI, 0) ELSE DBO.SUMGVA12IMPORTES('BICOTIZ', GVA12.COTIZ, 1, CASE GVA14.CLAUSULA WHEN 1 THEN 'S' ELSE 'N' END, 'S', GVA15.TIPO_COMP, CASE GVA12.MON_CTE WHEN 1 THEN 'S' ELSE 'N' END, 0, 0, 6, GVA46.IMPORTE_VT + ISNULL(IMPUTACIONES, 0)) END ELSE 0 END) WHEN 'BICLAUSU' THEN SUM(CASE WHEN GVA46.ESTADO_UNI <> 'PAG' THEN CASE GVA14.CLAUSULA WHEN 1 THEN GVA46.IMP_VT_UNI + ISNULL(IMPUTACIONES_UNI, 0) ELSE 0 END ELSE 0 END) ELSE 0 END AS IMPORTE_PENDIENTE_MON_EXT
FROM
    GVA12
INNER JOIN
    GVA46
    ON GVA46.N_COMP = GVA12.N_COMP AND GVA46.T_COMP = GVA12.T_COMP
INNER JOIN
    GVA14
    ON GVA14.COD_CLIENT = GVA12.COD_CLIENT
LEFT JOIN
    GVA27
    ON GVA14.COD_CLIENT = GVA27.COD_CLIENT AND DEFECTO = 'S'
LEFT JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
LEFT JOIN
    GVA18
    ON GVA14.COD_PROVIN = GVA18.COD_PROVIN
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON COND.COND_VTA = GVA12.COND_VTA
LEFT JOIN
    GVA62
    ON GVA62.GRUPO_EMPR = GVA14.GRUPO_EMPR
LEFT JOIN
    (SELECT GVA07.T_COMP, GVA07.N_COMP, GVA07.FECHA_VTO, SUM(CASE GVA07.T_COMP_CAN WHEN 'REC' THEN -(GVA07.IMPORT_CAN) ELSE CASE GVA15.TIPO_COMP WHEN 'D' THEN +(GVA07.IMPORT_CAN) ELSE -(GVA07.IMPORT_CAN) END END) AS IMPUTACIONES, SUM(CASE GVA07.T_COMP_CAN WHEN 'REC' THEN -(GVA07.IMP_CAN_UN) ELSE CASE GVA15.TIPO_COMP WHEN 'D' THEN +(GVA07.IMP_CAN_UN) ELSE -(GVA07.IMP_CAN_UN) END END) AS IMPUTACIONES_UNI
FROM
    GVA07
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA07.T_COMP_CAN
GROUP BY
    GVA07.T_COMP, GVA07.N_COMP, GVA07.FECHA_VTO) AS IMPU
    ON IMPU.T_COMP = GVA12.T_COMP AND IMPU.N_COMP = GVA12.N_COMP AND IMPU.FECHA_VTO = GVA46.FECHA_VTO
LEFT JOIN
    GVA15
    ON GVA15.IDENT_COMP = GVA12.T_COMP
LEFT JOIN
    SUCURSAL
    ON (GVA12.NRO_SUCURS = 0 AND SUCURSAL.NRO_SUCURSAL = (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) ) OR GVA12.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
WHERE
    ((GVA14.CLAUSULA = 0 AND GVA12.ESTADO = 'PEN') OR (GVA14.CLAUSULA = 1 AND GVA12.ESTADO_UNI = 'PEN')) AND ((GVA14.CLAUSULA = 0 AND GVA46.ESTADO_VTO <> 'PAG') OR (GVA14.CLAUSULA = 1 AND GVA46.ESTADO_UNI <> 'PAG'))
GROUP BY
    GVA12.COD_CLIENT, GVA14.RAZON_SOCI, GVA14.TELEFONO_1, GVA14.COD_ZONA, GVA05.NOMBRE_ZON

GO

-- Vista: SBA05_COBRANZAS_POR_MEDIO
SELECT CASE WHEN SBA01.TIPO = 'O' THEN 'Efectivo' WHEN SBA01.TIPO = 'T' THEN 'Tarjeta' WHEN SBA01.TIPO = 'C' THEN 'Cheque de Terceros' WHEN SBA01.TIPO = 'B' THEN 'Bancos' END AS MEDIO_PAGO, SUM(CASE SBA05.D_H WHEN 'D' THEN SBA05.MONTO ELSE -1 * SBA05.MONTO END) AS TOTAL_MON_CTE, SUM(CASE SBA05.D_H WHEN 'D' THEN SBA05.UNIDADES ELSE -1 * SBA05.UNIDADES END) AS TOTAL_MON_EXT
FROM
    SBA05 JOIN SBA01
    ON (SBA01.COD_CTA = SBA05.COD_CTA) JOIN GVA12
    ON (GVA12.T_COMP = SBA05.COD_COMP AND GVA12.N_COMP = SBA05.N_COMP)
LEFT JOIN
    GVA14
    ON (GVA12.COD_CLIENT = GVA14.COD_CLIENT)
LEFT JOIN
    BANCO
    ON (BANCO.ID_BANCO = SBA01.ID_BANCO)
LEFT JOIN
    GVA16
    ON 1 = 1
LEFT JOIN
    GVA28 FAMILIA (NOLOCK)
    ON SUBSTRING(GVA14.COD_CLIENT, 1, GVA16.LONG_FAM_C) = FAMILIA.COD_AGR
LEFT JOIN
    GVA28 GRUPO (NOLOCK)
    ON SUBSTRING(GVA14.COD_CLIENT, 0, GVA16.LONG_FAM_C + GVA16.LON_GRUP_C + 1) = GRUPO.COD_AGR
LEFT JOIN
    GVA81
    ON (GVA81.COD_CLASIF = GVA12.COD_CLASIF)
WHERE
    SBA05.RENGLON <> 0 AND GVA12.TCOMP_IN_V IN ('FC', 'FR', 'CC', 'DC', 'RC') AND (GVA12.ESTADO <> 'ANU') AND (SBA01.TIPO = 'T' OR SBA01.TIPO = 'C' OR (SBA01.TIPO = 'O' AND SBA01.FONDO = '1') OR (SBA01.TIPO = 'B' AND SBA01.CC_CA <> 'D'))
GROUP BY
    CASE WHEN SBA01.TIPO = 'O' THEN 'Efectivo' WHEN SBA01.TIPO = 'T' THEN 'Tarjeta' WHEN SBA01.TIPO = 'C' THEN 'Cheque de Terceros' WHEN SBA01.TIPO = 'B' THEN 'Bancos' END

GO

-- Vista: GVA21_PEDIDOS_PENDIENTES_FACTURAR_VENTAS
SELECT GVA21.Talon_Ped AS Talon_Ped, GVA21.Nro_Pedido AS Nro_Pedido, GVA21.COD_CLIENT AS COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END AS RAZON_SOCIAL, GVA21.FECHA_PEDI AS FECHA_PEDI, GVA21.COD_TRANSP AS COD_TRANSP, GVA24.NOMBRE_TRA AS NOMBRE_TRA, GVA21.COD_VENDED AS COD_VENDED, YEAR(GVA21.FECHA_PEDI) AS ANO, CASE WHEN MONTH(GVA21.FECHA_PEDI) = '1' THEN '01 Enero' WHEN MONTH(GVA21.FECHA_PEDI) = '2' THEN '02 Febrero' WHEN MONTH(GVA21.FECHA_PEDI) = '3' THEN '03 Marzo' WHEN MONTH(GVA21.FECHA_PEDI) = '4' THEN '04 Abril' WHEN MONTH(GVA21.FECHA_PEDI) = '5' THEN '05 Mayo' WHEN MONTH(GVA21.FECHA_PEDI) = '6' THEN '06 Junio' WHEN MONTH(GVA21.FECHA_PEDI) = '7' THEN '07 Julio' WHEN MONTH(GVA21.FECHA_PEDI) = '8' THEN '08 Agosto' WHEN MONTH(GVA21.FECHA_PEDI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA21.FECHA_PEDI) = '10' THEN '10 Octubre' WHEN MONTH(GVA21.FECHA_PEDI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA21.FECHA_PEDI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA21.FECHA_PEDI) AS DIA, CASE GVA21.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END AS NOMBRE_VEN, GVA14.COD_ZONA AS COD_ZONA, ISNULL(GVA05.NOMBRE_ZON, '(SIN ZONA ASIGNADA)') AS [Descripción Zona], SUM((PEDIDO.Precio * (1 - PEDIDO.Descuento / 100) * PEDIDO.Cant_Pen_F) * CASE WHEN Gva10.Mon_Cte <> 1 THEN GVA21.Cotiz ELSE 1 END * (1 - gva21.porc_desc / 100)) AS TOTAL
FROM
    GVA21
INNER JOIN
    (SELECT GVA03.*, STA11.ID_MEDIDA_STOCK AS MEDIDA_STOCK, STA11.ID_MEDIDA_CONTROL_STOCK, (CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 AND GVA03.CANT_PEN_F_2 > 0 THEN GVA03.CANT_PEN_F_2 WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK AND GVA03.CANT_PEN_F > 0 THEN GVA03.CANT_PEN_F END) AS CANTIDAD_PENDIENTE_FACTURAR
FROM
    STA11, GVA03
WHERE
    GVA03.COD_ARTICU = STA11.COD_ARTICU) AS PEDIDO
    ON PEDIDO.Nro_Pedido = GVA21.Nro_Pedido AND PEDIDO.Talon_Ped = GVA21.Talon_Ped
INNER JOIN
    GVA10
    ON GVA21.N_Lista = GVA10.Nro_de_Lis
LEFT JOIN
    (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA
FROM
    GVA126
GROUP BY
    TALON_PED, NRO_PEDIDO) AS TEMP
    ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON COND.COND_VTA = GVA21.COND_VTA
INNER JOIN
    GVA23
    ON GVA21.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    GVA81
    ON GVA81.COD_CLASIF = GVA21.COD_CLASIF
INNER JOIN
    GVA24
    ON GVA21.COD_TRANSP = GVA24.COD_TRANSP
LEFT JOIN
    GVA14
    ON GVA21.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
LEFT JOIN
    GVA18
    ON GVA14.COD_PROVIN = GVA18.COD_PROVIN
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
INNER JOIN
    GVA43
    ON GVA43.TALONARIO = GVA21.TALON_PED
INNER JOIN
    STA22
    ON GVA21.COD_SUCURS = STA22.COD_SUCURS
LEFT JOIN
    DIRECCION_ENTREGA
    ON GVA21.ID_DIRECCION_ENTREGA = DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA
LEFT JOIN
    (SELECT gva03.nro_pedido, gva03.talon_ped
FROM
    gva03
LEFT JOIN
    STA11
    ON STA11.COD_ARTICU = GVA03.COD_ARTICU
WHERE
    (((Sta11.ID_MEDIDA_STOCK = STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_f > 0)) OR ((Sta11.ID_MEDIDA_STOCK <> STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_f_2 > 0))) AND (((Sta11.ID_MEDIDA_STOCK = STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_d <> gva03.cant_pedid)) OR ((Sta11.ID_MEDIDA_STOCK <> STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_d_2 <> gva03.cant_pedid_2))) AND (((Sta11.ID_MEDIDA_STOCK = STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_f > gva03.cant_pen_d)) OR ((Sta11.ID_MEDIDA_STOCK <> STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_f_2 > gva03.cant_pen_d_2)))
GROUP BY
    GVA03.NRO_PEDIDO, GVA03.TALON_PED) AS REMITIDO
    ON REMITIDO.TALON_PED = GVA21.TALON_PED AND REMITIDO.NRO_PEDIDO = GVA21.NRO_PEDIDO
LEFT JOIN
    (SELECT gva03.NRO_PEDIDO, GVA03.TALON_PED, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 AND GVA03.CANT_PEN_F_2 > 0 THEN GVA03.CANT_PEN_F_2 WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK AND GVA03.CANT_PEN_F > 0 THEN GVA03.CANT_PEN_F END) AS CANTIDAD_PENDIENTE_FACTURAR
FROM
    GVA03
INNER JOIN
    STA11
    ON GVA03.COD_ARTICU = STA11.COD_ARTICU
GROUP BY
    GVA03.NRO_PEDIDO, GVA03.TALON_PED) AS PEDIDO_PENDIENTE
    ON PEDIDO_PENDIENTE.NRO_PEDIDO = GVA21.NRO_PEDIDO AND PEDIDO_PENDIENTE.TALON_PED = GVA21.TALON_PED
WHERE
    GVA21.Estado NOT IN (4, 5) AND EXISTS (SELECT TOP 1 GVA03.NRO_PEDIDO
FROM
    GVA03
WHERE
    GVA03.Talon_Ped = GVA21.Talon_Ped AND GVA03.Nro_Pedido = GVA21.Nro_Pedido AND PEDIDO_PENDIENTE.CANTIDAD_PENDIENTE_FACTURAR > 0)
GROUP BY
    GVA21.Talon_Ped, GVA21.Nro_Pedido, GVA21.COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END, GVA21.FECHA_PEDI, GVA21.COD_TRANSP, GVA24.NOMBRE_TRA, GVA21.COD_VENDED, CASE GVA21.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END, GVA14.COD_ZONA, ISNULL(GVA05.NOMBRE_ZON, '(SIN ZONA ASIGNADA)')

GO

-- Vista: GVA21_PEDIDOS_PENDIENTES_REMITIR
SELECT GVA21.Talon_Ped AS Talon_Ped, GVA21.Nro_Pedido AS Nro_Pedido, GVA21.COD_CLIENT AS COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END AS RAZON_SOCIAL, CASE WHEN GVA21.FECHA_PEDI = '01/01/1800' THEN NULL ELSE GVA21.FECHA_PEDI END AS FECHA_PEDIDO, YEAR(GVA21.FECHA_PEDI) AS ANO, CASE WHEN MONTH(GVA21.FECHA_PEDI) = '1' THEN '01 Enero' WHEN MONTH(GVA21.FECHA_PEDI) = '2' THEN '02 Febrero' WHEN MONTH(GVA21.FECHA_PEDI) = '3' THEN '03 Marzo' WHEN MONTH(GVA21.FECHA_PEDI) = '4' THEN '04 Abril' WHEN MONTH(GVA21.FECHA_PEDI) = '5' THEN '05 Mayo' WHEN MONTH(GVA21.FECHA_PEDI) = '6' THEN '06 Junio' WHEN MONTH(GVA21.FECHA_PEDI) = '7' THEN '07 Julio' WHEN MONTH(GVA21.FECHA_PEDI) = '8' THEN '08 Agosto' WHEN MONTH(GVA21.FECHA_PEDI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA21.FECHA_PEDI) = '10' THEN '10 Octubre' WHEN MONTH(GVA21.FECHA_PEDI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA21.FECHA_PEDI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA21.FECHA_PEDI) AS DIA, GVA21.COD_TRANSP AS COD_TRANSP, GVA24.NOMBRE_TRA AS NOMBRE_TRA, GVA21.COD_VENDED AS COD_VENDED, CASE GVA21.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END AS NOMBRE_VEN, GVA14.COD_ZONA AS COD_ZONA, ISNULL(GVA05.NOMBRE_ZON, '(SIN ZONA ASIGNADA)') AS [Descripción Zona], SUM((PEDIDO.Precio * (1 - PEDIDO.Descuento / 100) * PEDIDO.Cant_Pen_D) * CASE WHEN Gva10.Mon_Cte <> 1 THEN GVA21.Cotiz ELSE 1 END * (1 - gva21.porc_desc / 100)) AS TOTAL, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA AS COD_DIRECCION_ENTREGA
FROM
    GVA21
INNER JOIN
    GVA10
    ON GVA21.N_Lista = GVA10.Nro_de_Lis
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON COND.COND_VTA = GVA21.COND_VTA
INNER JOIN
    GVA23
    ON GVA21.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA
FROM
    GVA126
GROUP BY
    TALON_PED, NRO_PEDIDO) AS TEMP
    ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO
LEFT JOIN
    GVA81
    ON GVA81.COD_CLASIF = GVA21.COD_CLASIF
LEFT JOIN
    GVA24
    ON GVA21.COD_TRANSP = GVA24.COD_TRANSP
LEFT JOIN
    GVA14
    ON GVA21.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
LEFT JOIN
    GVA18
    ON GVA14.COD_PROVIN = GVA18.COD_PROVIN
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
INNER JOIN
    GVA43
    ON GVA43.TALONARIO = GVA21.TALON_PED
INNER JOIN
    STA22
    ON GVA21.COD_SUCURS = STA22.COD_SUCURS
INNER JOIN
    (SELECT GVA03.*, STA11.ID_MEDIDA_STOCK AS MEDIDA_STOCK, STA11.ID_MEDIDA_CONTROL_STOCK, (CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 AND (GVA03.CANT_PEN_D_2 > 0) THEN GVA03.CANT_PEN_D_2 WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK AND (GVA03.CANT_PEN_D > 0) THEN GVA03.CANT_PEN_D END) AS CANTIDAD_PENDIENTE_DESCARGAR
FROM
    STA11, GVA03
WHERE
    GVA03.COD_ARTICU = STA11.COD_ARTICU) AS PEDIDO
    ON PEDIDO.Nro_Pedido = GVA21.Nro_Pedido AND PEDIDO.Talon_Ped = GVA21.Talon_Ped
LEFT JOIN
    DIRECCION_ENTREGA
    ON GVA21.ID_DIRECCION_ENTREGA = DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA
LEFT JOIN
    (SELECT gva03.nro_pedido, gva03.talon_ped
FROM
    gva03
LEFT JOIN
    STA11
    ON STA11.COD_ARTICU = GVA03.COD_ARTICU
WHERE
    (((Sta11.ID_MEDIDA_STOCK = STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_d > 0)) OR ((Sta11.ID_MEDIDA_STOCK <> STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_d_2 > 0))) AND (((Sta11.ID_MEDIDA_STOCK = STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_f <> gva03.cant_pedid)) OR ((Sta11.ID_MEDIDA_STOCK <> STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_f_2 <> gva03.cant_pedid_2))) AND (((Sta11.ID_MEDIDA_STOCK = STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_d > gva03.cant_pen_f)) OR ((Sta11.ID_MEDIDA_STOCK <> STA11.ID_MEDIDA_CONTROL_STOCK) AND (gva03.cant_pen_d_2 > gva03.cant_pen_f_2)))
GROUP BY
    GVA03.NRO_PEDIDO, GVA03.TALON_PED) AS FACTURADO
    ON FACTURADO.TALON_PED = GVA21.TALON_PED AND FACTURADO.NRO_PEDIDO = GVA21.NRO_PEDIDO
WHERE
    GVA21.Estado NOT IN (4, 5) AND EXISTS (SELECT TOP 1 GVA03.NRO_PEDIDO
FROM
    GVA03
WHERE
    GVA03.Talon_Ped = GVA21.Talon_Ped AND GVA03.Nro_Pedido = GVA21.Nro_Pedido AND PEDIDO.CANTIDAD_PENDIENTE_DESCARGAR > 0)
GROUP BY
    GVA21.Talon_Ped, GVA21.Nro_Pedido, GVA21.COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END, GVA21.FECHA_PEDI, GVA21.COD_TRANSP, GVA24.NOMBRE_TRA, GVA21.COD_VENDED, CASE GVA21.COD_VENDED WHEN '**' THEN 'CONTADO' ELSE GVA23.NOMBRE_VEN END, GVA14.COD_ZONA, ISNULL(GVA05.NOMBRE_ZON, '(SIN ZONA ASIGNADA)'), DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA

GO

-- Vista: GVA21_PEDIDOS_PENDIENTES_APROBACION
SELECT GVA21.Talon_Ped AS Talon_Ped, GVA21.Nro_Pedido AS Nro_Pedido, GVA21.COD_CLIENT AS COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END AS RAZON_SOCIAL, GVA21.FECHA_PEDI AS FECHA_PEDI, YEAR(GVA21.FECHA_PEDI) AS ANO, CASE WHEN MONTH(GVA21.FECHA_PEDI) = '1' THEN '01 Enero' WHEN MONTH(GVA21.FECHA_PEDI) = '2' THEN '02 Febrero' WHEN MONTH(GVA21.FECHA_PEDI) = '3' THEN '03 Marzo' WHEN MONTH(GVA21.FECHA_PEDI) = '4' THEN '04 Abril' WHEN MONTH(GVA21.FECHA_PEDI) = '5' THEN '05 Mayo' WHEN MONTH(GVA21.FECHA_PEDI) = '6' THEN '06 Junio' WHEN MONTH(GVA21.FECHA_PEDI) = '7' THEN '07 Julio' WHEN MONTH(GVA21.FECHA_PEDI) = '8' THEN '08 Agosto' WHEN MONTH(GVA21.FECHA_PEDI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA21.FECHA_PEDI) = '10' THEN '10 Octubre' WHEN MONTH(GVA21.FECHA_PEDI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA21.FECHA_PEDI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA21.FECHA_PEDI) AS DIA, GVA21.COD_TRANSP AS COD_TRANSP, GVA24.NOMBRE_TRA AS NOMBRE_TRA, GVA21.COD_VENDED AS COD_VENDED, GVA23.NOMBRE_VEN AS NOMBRE_VEN, GVA14.COD_ZONA AS COD_ZONA, ISNULL(GVA05.NOMBRE_ZON, '(SIN ZONA ASIGNADA)') AS DESC_ZONA, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA AS COD_DIRECCION_ENTREGA, SUM(((CASE GVA10.MON_CTE WHEN 1 THEN GVA03.PRECIO ELSE (GVA03.PRECIO * GVA21.Cotiz) END) * (1 - (GVA03.DESCUENTO) / 100)) * (GVA03.Cant_Pedid) * (1 - gva21.porc_desc / 100)) AS TOTAL_SIN_IMPUESTOS
FROM
    GVA21
INNER JOIN
    GVA10
    ON GVA21.N_Lista = GVA10.Nro_de_Lis
INNER JOIN
    GVA23
    ON GVA21.COD_VENDED = GVA23.COD_VENDED
INNER JOIN
    GVA24
    ON GVA21.COD_TRANSP = GVA24.COD_TRANSP
LEFT JOIN
    (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA
FROM
    GVA126
GROUP BY
    TALON_PED, NRO_PEDIDO) AS TEMP
    ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO
LEFT JOIN
    GVA81
    ON GVA81.COD_CLASIF = GVA21.COD_CLASIF
LEFT JOIN
    GVA14
    ON GVA21.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    GVA05
    ON GVA14.COD_ZONA = GVA05.COD_ZONA
LEFT JOIN
    GVA18
    ON GVA14.COD_PROVIN = GVA18.COD_PROVIN
LEFT JOIN
    GVA133
    ON GVA18.COD_PAIS = GVA133.COD_PAIS
INNER JOIN
    GVA43
    ON GVA43.TALONARIO = GVA21.TALON_PED
INNER JOIN
    STA22
    ON GVA21.COD_SUCURS = STA22.COD_SUCURS
INNER JOIN
    GVA03
    ON (GVA21.TALON_PED = GVA03.TALON_PED AND GVA21.NRO_PEDIDO = GVA03.NRO_PEDIDO)
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON COND.COND_VTA = GVA21.COND_VTA
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA21.ID_DIRECCION_ENTREGA
WHERE
    GVA21.Estado IN (1, 6, 7)
GROUP BY
    GVA21.Talon_Ped, GVA21.Nro_Pedido, GVA21.COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END, GVA21.FECHA_PEDI, GVA21.COD_TRANSP, GVA24.NOMBRE_TRA, GVA21.COD_VENDED, GVA23.NOMBRE_VEN, GVA14.COD_ZONA, ISNULL(GVA05.NOMBRE_ZON, '(SIN ZONA ASIGNADA)'), DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA

GO

-- Vista: GVA03_PEDIDOS_DETALLE_VENTAS
SELECT GVA03.TALON_PED AS [GVA03.TALON_PED], GVA21.TALON_PED AS TALON_PED, GVA43.DESCRIP AS DESCRIP, GVA21.NRO_PEDIDO AS NRO_PEDIDO, CASE WHEN GVA21.FECHA_PEDI = '01/01/1800' THEN NULL ELSE GVA21.FECHA_PEDI END AS FECHA_PEDI, YEAR(GVA21.FECHA_PEDI) AS ANO, CASE WHEN MONTH(GVA21.FECHA_PEDI) = '1' THEN '01 Enero' WHEN MONTH(GVA21.FECHA_PEDI) = '2' THEN '02 Febrero' WHEN MONTH(GVA21.FECHA_PEDI) = '3' THEN '03 Marzo' WHEN MONTH(GVA21.FECHA_PEDI) = '4' THEN '04 Abril' WHEN MONTH(GVA21.FECHA_PEDI) = '5' THEN '05 Mayo' WHEN MONTH(GVA21.FECHA_PEDI) = '6' THEN '06 Junio' WHEN MONTH(GVA21.FECHA_PEDI) = '7' THEN '07 Julio' WHEN MONTH(GVA21.FECHA_PEDI) = '8' THEN '08 Agosto' WHEN MONTH(GVA21.FECHA_PEDI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA21.FECHA_PEDI) = '10' THEN '10 Octubre' WHEN MONTH(GVA21.FECHA_PEDI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA21.FECHA_PEDI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA21.FECHA_PEDI) AS DIA, GVA21.COND_VTA AS COND_VTA, COND.DESC_COND AS DESC_COND, GVA21.COD_VENDED AS COD_VENDED, CASE GVA21.COD_VENDED WHEN '**' THEN 'Contado' ELSE GVA23.NOMBRE_VEN END AS NOMBRE_VEN, GVA21.COD_CLIENT AS COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN '' ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, GVA21.COD_TRANSP AS COD_TRANSP, GVA24.NOMBRE_TRA AS NOMBRE_TRA, GVA03.COD_ARTICU AS COD_ARTICU, ISNULL(GVA45.[DESC], STA11.DESCRIPCIO) AS DESCRIPCIO, SUM(GVA03.CANT_PEDID) AS CANT_PEDID, SUM(GVA03.CANT_PEN_D) AS CANT_PEN_D, SUM(GVA03.CANT_PEN_F) AS CANT_PEN_F, SUM(CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN ((CASE GVA10.MON_CTE WHEN 1 THEN GVA03.PRECIO ELSE (GVA03.PRECIO * GVA21.Cotiz) END) * (1 - (GVA03.DESCUENTO) / 100) * (CASE WHEN GVA21.ESTADO IN (3, 4, 5) THEN 0 ELSE GVA03.Cant_Pen_F END) * (1 - gva21.porc_desc / 100)) WHEN 'BIORIGEN' THEN ((CASE GVA10.MON_CTE WHEN 1 THEN (GVA03.PRECIO / GVA21.COTIZ) ELSE GVA03.PRECIO END) * ((1 - (GVA03.DESCUENTO) / 100)) * (CASE WHEN GVA21.ESTADO IN (3, 4, 5) THEN 0 ELSE GVA03.Cant_Pen_F END) * (1 - gva21.porc_desc / 100)) WHEN 'BICOTIZ' THEN ((CASE GVA10.MON_CTE WHEN 1 THEN (GVA03.PRECIO / CASE WHEN 1 = 0 THEN 1 ELSE 1 END) ELSE GVA03.PRECIO * GVA21.COTIZ / CASE WHEN 1 = 0 THEN 1 ELSE 1 END END) * ((1 - (GVA03.DESCUENTO) / 100)) * (CASE WHEN GVA21.ESTADO IN (3, 4, 5) THEN 0 ELSE GVA03.Cant_Pen_F END) * (1 - gva21.porc_desc / 100)) END) AS TOTAL
FROM
    GVA03(NOLOCK) JOIN GVA21
    ON GVA03.NRO_PEDIDO = GVA21.NRO_PEDIDO AND GVA03.TALON_PED = GVA21.TALON_PED
LEFT JOIN
    GVA16
    ON 1 = 1
LEFT JOIN
    GVA10
    ON GVA10.NRO_DE_LIS = GVA21.N_Lista
LEFT JOIN
    (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA
FROM
    GVA126
GROUP BY
    TALON_PED, NRO_PEDIDO) AS TEMP
    ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO
LEFT JOIN
    GVA43(NOLOCK)
    ON GVA21.TALON_PED = GVA43.TALONARIO
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON GVA21.COND_VTA = COND.COND_VTA
LEFT JOIN
    GVA23(NOLOCK)
    ON GVA21.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    GVA14(NOLOCK)
    ON GVA21.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    GVA28 FAMILIA (NOLOCK)
    ON SUBSTRING(GVA21.COD_CLIENT, 1, GVA16.LONG_FAM_C) = FAMILIA.COD_AGR
LEFT JOIN
    GVA28 GRUPO (NOLOCK)
    ON SUBSTRING(GVA21.COD_CLIENT, 0, GVA16.LONG_FAM_C + LON_GRUP_C + 1) = GRUPO.COD_AGR
LEFT JOIN
    GVA24(NOLOCK)
    ON GVA21.COD_TRANSP = GVA24.COD_TRANSP
LEFT JOIN
    GVA81(NOLOCK)
    ON GVA03.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    STA16
    ON 1 = 1 FULL OUTER JOIN STA11(NOLOCK)
    ON GVA03.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    GVA45(NOLOCK)
    ON GVA45.TALONARIO = GVA03.TALON_PED AND GVA45.N_COMP = GVA03.NRO_PEDIDO AND GVA45.N_RENGLON = GVA03.N_RENGLON
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, STA16.LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA21.ID_DIRECCION_ENTREGA
WHERE
    GVA03.COD_ARTICU <> '' AND GVA03.RENGL_PADR = 0
GROUP BY
    GVA03.TALON_PED, GVA21.TALON_PED, GVA43.DESCRIP, GVA21.COD_VENDED, GVA21.FECHA_PEDI, GVA21.NRO_PEDIDO, CASE WHEN GVA21.FECHA_PEDI = '01/01/1800' THEN NULL ELSE GVA21.FECHA_PEDI END, GVA21.COND_VTA, COND.DESC_COND, CASE GVA21.COD_VENDED WHEN '**' THEN 'Contado' ELSE GVA23.NOMBRE_VEN END, GVA21.COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN '' ELSE GVA14.RAZON_SOCI END, FAMILIA.NOM_AGR, GRUPO.NOM_AGR, GVA21.COD_TRANSP, GVA24.NOMBRE_TRA, GVA21.COD_CLASIF, GVA03.COD_CLASIF, GVA81.DESCRIP, GVA03.COD_ARTICU, ISNULL(GVA45.[DESC], STA11.DESCRIPCIO), FAMILIA_ART.NOM_AGR, GRUPO_ART.NOM_AGR

GO

-- Vista: GVA03_PEDIDOS_DETALLE_CORRIENTE
SELECT GVA03.TALON_PED AS [GVA03.TALON_PED], GVA21.TALON_PED AS TALON_PED, GVA43.DESCRIP AS DESCRIP, GVA21.NRO_PEDIDO AS NRO_PEDIDO, CASE WHEN GVA21.FECHA_PEDI = '01/01/1800' THEN NULL ELSE GVA21.FECHA_PEDI END AS FECHA_PEDI, YEAR(GVA21.FECHA_PEDI) AS ANO, CASE WHEN MONTH(GVA21.FECHA_PEDI) = '1' THEN '01 Enero' WHEN MONTH(GVA21.FECHA_PEDI) = '2' THEN '02 Febrero' WHEN MONTH(GVA21.FECHA_PEDI) = '3' THEN '03 Marzo' WHEN MONTH(GVA21.FECHA_PEDI) = '4' THEN '04 Abril' WHEN MONTH(GVA21.FECHA_PEDI) = '5' THEN '05 Mayo' WHEN MONTH(GVA21.FECHA_PEDI) = '6' THEN '06 Junio' WHEN MONTH(GVA21.FECHA_PEDI) = '7' THEN '07 Julio' WHEN MONTH(GVA21.FECHA_PEDI) = '8' THEN '08 Agosto' WHEN MONTH(GVA21.FECHA_PEDI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA21.FECHA_PEDI) = '10' THEN '10 Octubre' WHEN MONTH(GVA21.FECHA_PEDI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA21.FECHA_PEDI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA21.FECHA_PEDI) AS DIA, GVA21.COND_VTA AS COND_VTA, COND.DESC_COND AS DESC_COND, GVA21.COD_VENDED AS COD_VENDED, CASE GVA21.COD_VENDED WHEN '**' THEN 'Contado' ELSE GVA23.NOMBRE_VEN END AS NOMBRE_VEN, GVA21.COD_CLIENT AS COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN '' ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, GVA21.COD_TRANSP AS COD_TRANSP, GVA24.NOMBRE_TRA AS NOMBRE_TRA, GVA03.COD_ARTICU AS COD_ARTICU, ISNULL(GVA45.[DESC], STA11.DESCRIPCIO) AS DESCRIPCIO, SUM(GVA03.CANT_PEDID) AS CANT_PEDID, SUM(GVA03.CANT_PEN_D) AS CANT_PEN_D, SUM(GVA03.CANT_PEN_F) AS CANT_PEN_F, SUM(CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN ((CASE GVA10.MON_CTE WHEN 1 THEN GVA03.PRECIO ELSE (GVA03.PRECIO * GVA21.Cotiz) END) * (1 - (GVA03.DESCUENTO) / 100) * (CASE WHEN GVA21.ESTADO IN (3, 4, 5) THEN 0 ELSE GVA03.Cant_Pen_F END) * (1 - gva21.porc_desc / 100)) WHEN 'BIORIGEN' THEN ((CASE GVA10.MON_CTE WHEN 1 THEN (GVA03.PRECIO / GVA21.COTIZ) ELSE GVA03.PRECIO END) * ((1 - (GVA03.DESCUENTO) / 100)) * (CASE WHEN GVA21.ESTADO IN (3, 4, 5) THEN 0 ELSE GVA03.Cant_Pen_F END) * (1 - gva21.porc_desc / 100)) WHEN 'BICOTIZ' THEN ((CASE GVA10.MON_CTE WHEN 1 THEN (GVA03.PRECIO / CASE WHEN 1 = 0 THEN 1 ELSE 1 END) ELSE GVA03.PRECIO * GVA21.COTIZ / CASE WHEN 1 = 0 THEN 1 ELSE 1 END END) * ((1 - (GVA03.DESCUENTO) / 100)) * (CASE WHEN GVA21.ESTADO IN (3, 4, 5) THEN 0 ELSE GVA03.Cant_Pen_F END) * (1 - gva21.porc_desc / 100)) END) AS TOTAL
FROM
    GVA03(NOLOCK) JOIN GVA21
    ON GVA03.NRO_PEDIDO = GVA21.NRO_PEDIDO AND GVA03.TALON_PED = GVA21.TALON_PED
LEFT JOIN
    GVA16
    ON 1 = 1
LEFT JOIN
    GVA10
    ON GVA10.NRO_DE_LIS = GVA21.N_Lista
LEFT JOIN
    (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA
FROM
    GVA126
GROUP BY
    TALON_PED, NRO_PEDIDO) AS TEMP
    ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO
LEFT JOIN
    GVA43(NOLOCK)
    ON GVA21.TALON_PED = GVA43.TALONARIO
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON GVA21.COND_VTA = COND.COND_VTA
LEFT JOIN
    GVA23(NOLOCK)
    ON GVA21.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    GVA14(NOLOCK)
    ON GVA21.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    GVA28 FAMILIA (NOLOCK)
    ON SUBSTRING(GVA21.COD_CLIENT, 1, GVA16.LONG_FAM_C) = FAMILIA.COD_AGR
LEFT JOIN
    GVA28 GRUPO (NOLOCK)
    ON SUBSTRING(GVA21.COD_CLIENT, 0, GVA16.LONG_FAM_C + LON_GRUP_C + 1) = GRUPO.COD_AGR
LEFT JOIN
    GVA24(NOLOCK)
    ON GVA21.COD_TRANSP = GVA24.COD_TRANSP
LEFT JOIN
    GVA81(NOLOCK)
    ON GVA03.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    STA16
    ON 1 = 1 FULL OUTER JOIN STA11(NOLOCK)
    ON GVA03.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    GVA45(NOLOCK)
    ON GVA45.TALONARIO = GVA03.TALON_PED AND GVA45.N_COMP = GVA03.NRO_PEDIDO AND GVA45.N_RENGLON = GVA03.N_RENGLON
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, STA16.LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA21.ID_DIRECCION_ENTREGA
WHERE
    GVA03.COD_ARTICU <> '' AND GVA03.RENGL_PADR = 0 AND (YEAR(GVA21.FECHA_PEDI) >= YEAR(GETDATE()))
GROUP BY
    GVA03.TALON_PED, GVA21.TALON_PED, GVA43.DESCRIP, GVA21.COD_VENDED, GVA21.FECHA_PEDI, GVA21.NRO_PEDIDO, CASE WHEN GVA21.FECHA_PEDI = '01/01/1800' THEN NULL ELSE GVA21.FECHA_PEDI END, GVA21.COND_VTA, COND.DESC_COND, CASE GVA21.COD_VENDED WHEN '**' THEN 'Contado' ELSE GVA23.NOMBRE_VEN END, GVA21.COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN '' ELSE GVA14.RAZON_SOCI END, FAMILIA.NOM_AGR, GRUPO.NOM_AGR, GVA21.COD_TRANSP, GVA24.NOMBRE_TRA, GVA21.COD_CLASIF, GVA03.COD_CLASIF, GVA81.DESCRIP, GVA03.COD_ARTICU, ISNULL(GVA45.[DESC], STA11.DESCRIPCIO), FAMILIA_ART.NOM_AGR, GRUPO_ART.NOM_AGR

GO

-- Vista: GVA03_ENTREGAS_PACTADAS_STOCK
SELECT GVA03.TALON_PED AS TALON_PED, GVA43.DESCRIP AS DESCRIP, GVA03.NRO_PEDIDO AS NRO_PEDIDO, GVA03.N_RENGLON AS N_RENGLON, GVA03.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, GVA21.COD_VENDED AS COD_VENDED, GVA21.COD_CLIENT AS COD_CLIENT, YEAR(GVA21.FECHA_PEDI) AS ANO, CASE WHEN MONTH(GVA21.FECHA_PEDI) = '1' THEN '01 Enero' WHEN MONTH(GVA21.FECHA_PEDI) = '2' THEN '02 Febrero' WHEN MONTH(GVA21.FECHA_PEDI) = '3' THEN '03 Marzo' WHEN MONTH(GVA21.FECHA_PEDI) = '4' THEN '04 Abril' WHEN MONTH(GVA21.FECHA_PEDI) = '5' THEN '05 Mayo' WHEN MONTH(GVA21.FECHA_PEDI) = '6' THEN '06 Junio' WHEN MONTH(GVA21.FECHA_PEDI) = '7' THEN '07 Julio' WHEN MONTH(GVA21.FECHA_PEDI) = '8' THEN '08 Agosto' WHEN MONTH(GVA21.FECHA_PEDI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA21.FECHA_PEDI) = '10' THEN '10 Octubre' WHEN MONTH(GVA21.FECHA_PEDI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA21.FECHA_PEDI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA21.FECHA_PEDI) AS DIA, CASE GVA21.COD_CLIENT WHEN '000000' THEN GVA38.RAZON_SOCI ELSE GVA14.RAZON_SOCI END AS RAZON_SOCI, SUCURSAL.NRO_SUCURSAL AS NRO_SUCURSAL, SUM(CASE WHEN STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN (CASE WHEN GVA03.UNIDAD_MEDIDA_SELECCIONADA = 'V' THEN PLAN_ENT.CANT_PACTADA * GVA03.CAN_EQUI_V ELSE PLAN_ENT.CANT_PACTADA END) ELSE (CASE WHEN GVA03.UNIDAD_MEDIDA_SELECCIONADA = 'V' THEN PLAN_ENT.CANT_PACTADA * GVA03.CAN_EQUI_V * STA11.EQUIVALENCIA_STOCK_2 * (GVA03.CANT_PEDID / (CASE WHEN GVA03.CANT_PEDID_2 = 0 THEN 1 ELSE GVA03.CANT_PEDID_2 END)) WHEN GVA03.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PLAN_ENT.CANT_PACTADA * STA11.EQUIVALENCIA_STOCK_2 ELSE PLAN_ENT.CANT_PACTADA END) END) AS CANTIDAD_PACTADA, SUM(PLAN_ENT.CANT_REMITIDA) AS CANTIDAD_REMITIDA, CASE WHEN GVA21.FECHA_ENTR <> '01/01/1800' THEN GVA21.FECHA_ENTR ELSE CASE WHEN TEMP.FECHA_MINIMA <> '01/01/1800' THEN TEMP.FECHA_MINIMA ELSE NULL END END AS FECHA_ENTREGA, CASE WHEN TEMP.FECHA_MINIMA <> '01/01/1800' THEN 'Ver detalle' ELSE '' END AS PLAN_DE_ENTREGA, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA AS COD_DIRECCION_ENTREGA
FROM
    GVA03
INNER JOIN
    (SELECT GVA126.TALON_PED AS [TALON_PED], GVA126.NRO_PEDIDO, GVA126.N_RENGLON, GVA126.CANTIDAD AS [CANT_PACTADA], GVA126.FEC_ENTREG AS [FECHA_ENTREGA], 0000.00000000 AS [CANT_REMITIDA], 0000.00000000 AS [CANT_REMITIDA_2]
FROM
    GVA126 UNION
SELECT
    GVA106.TALON_PED AS [TALON_PED], GVA106.NRO_PEDIDO, GVA106.N_RENG_PED AS [N_RENGLON], 000000.00000 AS [CANT_PACTADA], GVA106.FECHA_REM AS [FECHA_ENTREGA], GVA106.CANT_REM AS [CANT_REMITIDA], GVA106.CANTIDAD_REM_2 AS [CANT_REMITIDA_2]
FROM
    GVA106) AS PLAN_ENT
    ON (PLAN_ENT.TALON_PED = GVA03.TALON_PED AND PLAN_ENT.NRO_PEDIDO = GVA03.NRO_PEDIDO AND PLAN_ENT.N_RENGLON = GVA03.N_RENGLON)
LEFT JOIN
    GVA21
    ON (GVA03.TALON_PED = GVA21.TALON_PED AND GVA03.NRO_PEDIDO = GVA21.NRO_PEDIDO)
LEFT JOIN
    (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA
FROM
    GVA126
GROUP BY
    TALON_PED, NRO_PEDIDO) AS TEMP
    ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO
LEFT JOIN
    GVA43(NOLOCK)
    ON GVA21.TALON_PED = GVA43.TALONARIO
LEFT JOIN
    STA11
    ON (GVA03.COD_ARTICU = STA11.COD_ARTICU)
LEFT JOIN
    GVA14
    ON (GVA21.COD_CLIENT = GVA14.COD_CLIENT)
LEFT JOIN
    GVA38
    ON (GVA03.NRO_PEDIDO = GVA38.N_COMP AND GVA38.T_COMP = 'PED')
LEFT JOIN
    GVA23
    ON (GVA21.COD_VENDED = GVA23.COD_VENDED)
LEFT JOIN
    STA22
    ON (GVA21.COD_SUCURS = STA22.COD_SUCURS)
LEFT JOIN
    SUCURSAL
    ON ((GVA21.NRO_SUCURS = 0 AND SUCURSAL.ID_SUCURSAL = (SELECT EMPRESA.ID_SUCURSAL
FROM
    EMPRESA) ) OR GVA21.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL)
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = GVA03.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = GVA03.ID_MEDIDA_STOCK_2
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA21.ID_DIRECCION_ENTREGA
GROUP BY
    GVA03.TALON_PED, GVA43.DESCRIP, GVA03.NRO_PEDIDO, GVA03.N_RENGLON, GVA03.COD_ARTICU, STA11.DESCRIPCIO, GVA21.FECHA_PEDI, GVA21.COD_VENDED, GVA21.COD_CLIENT, CASE GVA21.COD_CLIENT WHEN '000000' THEN GVA38.RAZON_SOCI ELSE GVA14.RAZON_SOCI END, SUCURSAL.NRO_SUCURSAL, CASE WHEN GVA21.FECHA_ENTR <> '01/01/1800' THEN GVA21.FECHA_ENTR ELSE CASE WHEN TEMP.FECHA_MINIMA <> '01/01/1800' THEN TEMP.FECHA_MINIMA ELSE NULL END END, CASE WHEN TEMP.FECHA_MINIMA <> '01/01/1800' THEN 'Ver detalle' ELSE '' END, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA

GO

-- Vista: GVA17_PRECIOS_VENTAS
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, GVA17.PRECIO AS PRECIO, GVA10.NRO_DE_LIS AS NRO_DE_LIS, GVA10.NOMBRE_LIS AS NOMBRE_LIS, CASE GVA10.MON_CTE WHEN 1 THEN 'CORRIENTE' ELSE 'EXTRANJERA' END AS MON_CTE, CASE WHEN GVA10.INCLUY_IMP = 1 THEN 'INCLUYE IMPUESTO' ELSE 'NO INCLUYE IMPUESTO' END AS INCLUY_IMP, CASE WHEN GVA10.INCLUY_IVA = 1 THEN 'INCLUYE IVA' ELSE 'NO INCLUYE IVA' END AS INCLUY_IVA, GVA17.FECHA_MODI AS FECHA_MODI, YEAR(GVA17.FECHA_MODI) AS ANO, CASE WHEN MONTH(GVA17.FECHA_MODI) = '1' THEN '01 Enero' WHEN MONTH(GVA17.FECHA_MODI) = '2' THEN '02 Febrero' WHEN MONTH(GVA17.FECHA_MODI) = '3' THEN '03 Marzo' WHEN MONTH(GVA17.FECHA_MODI) = '4' THEN '04 Abril' WHEN MONTH(GVA17.FECHA_MODI) = '5' THEN '05 Mayo' WHEN MONTH(GVA17.FECHA_MODI) = '6' THEN '06 Junio' WHEN MONTH(GVA17.FECHA_MODI) = '7' THEN '07 Julio' WHEN MONTH(GVA17.FECHA_MODI) = '8' THEN '08 Agosto' WHEN MONTH(GVA17.FECHA_MODI) = '9' THEN '09 Septiembre' WHEN MONTH(GVA17.FECHA_MODI) = '10' THEN '10 Octubre' WHEN MONTH(GVA17.FECHA_MODI) = '11' THEN '11 Noviembre' WHEN MONTH(GVA17.FECHA_MODI) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA17.FECHA_MODI) AS DIA
FROM
    GVA17(nolock)
INNER JOIN
    gva10(nolock)
    ON gva10.NRO_DE_LIS = gva17.NRO_DE_LIS
INNER JOIN
    sta11(nolock)
    ON sta11.COD_ARTICU = gva17.COD_ARTICU
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (CASE sta11.base WHEN '' THEN STA11.COD_ARTICU ELSE STA11.BASE END) = BASE.COD_ARTICU
LEFT JOIN
    MEDIDA
    ON MEDIDA.ID_MEDIDA = STA11.ID_MEDIDA_STOCK
LEFT JOIN
    (SELECT N1.CODE, N1.IDFOLDER, F1.PADRE0, F1.PADRE1, F1.PADRE2, F1.PADRE3, F1.PADRE4, F1.PADRE5, F1.PADRE6, F1.PADRE7, F1.PADRE8, F1.PADRE9, F1.PADRE10, F1.PADRE11
FROM
    STA11ITC N1 JOIN V_LI_CLASIFICADOR_STA11FLD F1
    ON (N1.IDFOLDER = F1.IDFOLDER_V)) AS CLASIF_ITEMS
    ON CLASIF_ITEMS.CODE = STA11.COD_ARTICU
WHERE
    sta11.perfil <> 'N' AND GVA10.HABILITADA = 1
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, GVA17.PRECIO, GVA10.NRO_DE_LIS, GVA10.NOMBRE_LIS, CASE GVA10.MON_CTE WHEN 1 THEN 'CORRIENTE' ELSE 'EXTRANJERA' END, CASE WHEN GVA10.INCLUY_IMP = 1 THEN 'INCLUYE IMPUESTO' ELSE 'NO INCLUYE IMPUESTO' END, CASE WHEN GVA10.INCLUY_IVA = 1 THEN 'INCLUYE IVA' ELSE 'NO INCLUYE IVA' END, GVA17.FECHA_MODI

GO

-- Vista: GVA14_SALDO_CLIENTES_VENTAS
SELECT GVA14.COD_CLIENT AS COD_CLIENT, GVA14.RAZON_SOCI AS RAZON_SOCI, GVA14.NOM_COM AS NOM_COM, GVA14.CUIT AS CUIT, CASE GVA14.CLAUSULA WHEN 1 THEN 'Extranjera' ELSE 'Corriente' END AS CLAUSULA, CASE WHEN GVA14.Clausula = 0 THEN GVA14.SALDO_CC ELSE 0 END AS SALDO_MON_CTE, CASE WHEN GVA14.Clausula = 1 THEN GVA14.SALDO_CC_U ELSE 0 END AS SALDO_MON_EXT
FROM
    GVA14
LEFT JOIN
    GVA05
    ON (GVA14.COD_ZONA = GVA05.COD_ZONA)
LEFT JOIN
    GVA18
    ON (GVA14.COD_PROVIN = GVA18.COD_PROVIN)
LEFT JOIN
    GVA133
    ON (GVA18.COD_PAIS = GVA133.COD_PAIS)
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) COND
    ON (COND.COND_VTA = GVA14.COND_VTA)
LEFT JOIN
    GVA23
    ON (GVA14.COD_VENDED = GVA23.COD_VENDED)
LEFT JOIN
    GVA151
    ON (GVA14.COD_RUBRO = GVA151.COD_RUBRO)
LEFT JOIN
    GVA62
    ON (GVA14.GRUPO_EMPR = GVA62.GRUPO_EMPR)

GO

-- Vista: GVA09_COTIZACIONES
SELECT GVA09.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(GVA09.CANT_TOTAL) AS CANT_TOTAL, SUM(CASE gva08.mon_cte WHEN 1 THEN GVA09.importe ELSE GVA08.COTIZ * GVA09.importe END) AS TOTAL, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA AS COD_DIRECCION_ENTREGA, YEAR(GVA08.FECHA_ALTA) AS ANO, CASE WHEN MONTH(GVA08.FECHA_ALTA) = '1' THEN '01 Enero' WHEN MONTH(GVA08.FECHA_ALTA) = '2' THEN '02 Febrero' WHEN MONTH(GVA08.FECHA_ALTA) = '3' THEN '03 Marzo' WHEN MONTH(GVA08.FECHA_ALTA) = '4' THEN '04 Abril' WHEN MONTH(GVA08.FECHA_ALTA) = '5' THEN '05 Mayo' WHEN MONTH(GVA08.FECHA_ALTA) = '6' THEN '06 Junio' WHEN MONTH(GVA08.FECHA_ALTA) = '7' THEN '07 Julio' WHEN MONTH(GVA08.FECHA_ALTA) = '8' THEN '08 Agosto' WHEN MONTH(GVA08.FECHA_ALTA) = '9' THEN '09 Septiembre' WHEN MONTH(GVA08.FECHA_ALTA) = '10' THEN '10 Octubre' WHEN MONTH(GVA08.FECHA_ALTA) = '11' THEN '11 Noviembre' WHEN MONTH(GVA08.FECHA_ALTA) = '12' THEN '12 Diciembre' END AS MES, DAY(GVA08.FECHA_ALTA) AS DIA
FROM
    GVA09 JOIN GVA08
    ON GVA09.N_COTIZ = GVA08.N_COTIZ AND GVA09.TALONARIO = GVA08.TALONARIO
LEFT JOIN
    STA11
    ON GVA09.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    GVA14
    ON GVA08.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    GVA19
    ON GVA08.COD_CLIENT = GVA19.COD_CLIENT
LEFT JOIN
    GVA23
    ON GVA08.COD_VENDED = GVA23.COD_VENDED
LEFT JOIN
    GVA43
    ON GVA09.TALONARIO = GVA43.TALONARIO
LEFT JOIN
    GVA24
    ON GVA08.COD_TRANSP = GVA24.COD_TRANSP
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    GVA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, STA16.LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    GVA38
    ON GVA38.N_COMP = GVA08.N_COTIZ AND GVA38.T_COMP = 'COT'
LEFT JOIN
    GVA81 AS CLASIF_COMP
    ON GVA08.COD_CLASIF = CLASIF_COMP.COD_CLASIF
LEFT JOIN
    GVA81
    ON GVA09.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    (SELECT DISTINCT COND_VTA, DESC_COND
FROM
    GVA01) AS COND
    ON GVA08.COND_VTA = COND.COND_VTA
LEFT JOIN
    GVA28 FAMILIA (NOLOCK)
    ON SUBSTRING(GVA08.COD_CLIENT, 1, GVA16.LONG_FAM_C) = FAMILIA.COD_AGR
LEFT JOIN
    GVA28 GRUPO (NOLOCK)
    ON SUBSTRING(GVA08.COD_CLIENT, 0, GVA16.LONG_FAM_C + LON_GRUP_C + 1) = GRUPO.COD_AGR
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = GVA09.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = GVA09.ID_MEDIDA_STOCK_2
LEFT JOIN
    DIRECCION_ENTREGA
    ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA08.ID_DIRECCION_ENTREGA
WHERE
    GVA09.COD_ARTICU <> ''
GROUP BY
    GVA09.COD_ARTICU, GVA08.FECHA_ALTA, STA11.DESCRIPCIO, DIRECCION_ENTREGA.COD_DIRECCION_ENTREGA

GO

-- Vista: STA11_SALDOS_ARTICULOS_STOCK
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, STA22.COD_SUCURS AS COD_SUCURS, STA22.NOMBRE_SUC AS NOMBRE_SUC, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END AS UM_MEDIDA_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END) AS SALDO_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_COMP_2 ELSE CANT_COMP END) AS CANTIDAD_COMPROMETIDA_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_PEND_2 ELSE CANT_PEND END) AS CANTIDAD_A_RECIBIR_CONTROL, SUM(Sta11.PTO_PEDIDO) AS PUNTO_DE_PEDIDO, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END - Sta11.PTO_PEDIDO) AS DIFERENCIA
FROM
    STA11
INNER JOIN
    STA19
    ON STA11.COD_ARTICU = STA19.COD_ARTICU
INNER JOIN
    STA22
    ON STA19.COD_DEPOSI = STA22.COD_SUCURS
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK
    ON STA11.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK_2
    ON STA11.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA
WHERE
    STA11.Stock = 1
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, STA22.COD_SUCURS, STA22.NOMBRE_SUC, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END

GO

-- Vista: STA11_STOCK_FALTANTE
SELECT TMP.COD_ARTICU AS COD_ARTICU, TMP.DESCRIPCIO AS DESCRIPCIO, valor2 AS VALOR_DE_LA_ESCALA_2, CASE WHEN ID_MEDIDA_CONTROL_STOCK = ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END AS MEDIDA_STOCK, [SALDO_CONTROL] AS SALDO_CONTROL, [CANTIDAD_COMPROMETIDA_CONTROL] AS CANTIDAD_COMPROMETIDA_CONTROL, [CANTIDAD_A_RECIBIR_CONTROL] AS CANTIDAD_A_RECIBIR_CONTROL, [Punto_Pedido] AS PUNTO_DE_PEDIDO, [Diferencia] AS DIFERENCIA
FROM
    (SELECT STA11.cod_articu, STA11.DESCRIPCIO, STA11.DESC_ADIC, STA11.SINONIMO, (CASE STA11.PROMO_MENU WHEN 'A' THEN 'Simple' WHEN 'M' THEN 'Fórmula' WHEN 'P' THEN 'Kit' END) AS [Tipo_articulo], (CASE STA11.USA_ESC WHEN 'S' THEN 'Es combinación' WHEN 'N' THEN 'No usa' WHEN 'B' THEN 'Es base' END) AS [usa_Escala], STA11.BASE, STA11.VALOR1, STA11.VALOR2, STA11.ESCALA_1, STA11.ESCALA_2, SUM(STA19.CANT_STOCK) AS [CANTIDAD], SUM(CANT_COMP) AS [Cantidad_Comp], SUM(CANT_PEND) AS [Cantidad_rec], ID_MEDIDA_STOCK, SUM(STA19.CANT_STOCK_2) AS [CANTIDAD_2], SUM(CANT_COMP_2) AS [Cantidad_Comp_2], SUM(CANT_PEND_2) AS [Cantidad_rec_2], ID_MEDIDA_STOCK_2, ID_MEDIDA_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END) AS [SALDO_CONTROL], SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_COMP_2 ELSE CANT_COMP END) AS [CANTIDAD_COMPROMETIDA_CONTROL], SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_PEND_2 ELSE CANT_PEND END) AS [CANTIDAD_A_RECIBIR_CONTROL], STA11.STOCK_MINI AS [StocK_Minimo], STA11.STOCK_MAXI AS [Stock_Maximo], STA11.PTO_PEDIDO AS [Punto_Pedido], STA11.PTO_PEDIDO - SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END) AS [Diferencia]
FROM
    STA11
LEFT JOIN
    STA19
    ON Sta11.Cod_Articu = Sta19.Cod_Articu
LEFT JOIN
    STA22
    ON STA22.COD_SUCURS = STA19.COD_DEPOSI
WHERE
    STA11.Stock = 1 AND STA11.PERFIL <> 'N'
GROUP BY
    STA11.Cod_Articu, STA11.Descripcio, Desc_Adic, SINONIMO, usa_esc, base, valor1, valor2, escala_1, escala_2, (CASE sta11.base WHEN '' THEN STA11.cod_articu ELSE STA11.BASE END), ID_MEDIDA_STOCK, STA11.PROMO_MENU, STA11.ID_MEDIDA_STOCK_2, STA11.ID_MEDIDA_CONTROL_STOCK, STA11.STOCK_MINI, STA11.STOCK_MAXI, STA11.PTO_PEDIDO HAVING (STA11.PTO_PEDIDO - SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END)) > 0) AS TMP
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = TMP.BASE)
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON TMP.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON TMP.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA

GO

-- Vista: STA11_SALDO_ARTICULO_CLIENTE
SELECT GVA11.COD_CLIENT AS COD_CLIENT, ISNULL(GVA14.RAZON_SOCI, 'Sin asignar') AS RAZON_SOCI, STA11.COD_ARTICU AS COD_ARTICU, sta11.DESCRIPCIO AS DESCRIPCIO, STA11.valor2 AS VALOR_DE_LA_ESCALA_2, STA22.COD_SUCURS AS COD_SUCURS, STA22.NOMBRE_SUC AS NOMBRE_SUC, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END AS UM_MEDIDA_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END) AS SALDO_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_COMP_2 ELSE CANT_COMP END) AS CANTIDAD_COMPROMETIDA_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_PEND_2 ELSE CANT_PEND END) AS CANTIDAD_A_RECIBIR_CONTROL, SUM(CANT_STOCK) AS SALDO_STOCK, SUM(PTO_PEDIDO) AS PUNTO_DE_PEDIDO, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END - Sta11.PTO_PEDIDO) AS DIFERENCIA
FROM
    STA11
INNER JOIN
    STA19
    ON STA11.COD_ARTICU = STA19.COD_ARTICU
INNER JOIN
    STA22
    ON STA19.COD_DEPOSI = STA22.COD_SUCURS
LEFT JOIN
    GVA11
    ON GVA11.COD_ARTICU = STA19.COD_ARTICU
LEFT JOIN
    GVA14
    ON GVA11.COD_CLIENT = GVA14.COD_CLIENT
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK
    ON STA11.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK_2
    ON STA11.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA
WHERE
    STA11.STOCK = 1
GROUP BY
    GVA11.COD_CLIENT, ISNULL(GVA14.RAZON_SOCI, 'Sin asignar'), STA22.COD_SUCURS, STA11.Cod_Articu, sta11.Descripcio, STA11.valor2, STA22.NOMBRE_SUC, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END

GO

-- Vista: STA11_SALDO_ARTICULO_PROVEEDOR
SELECT CPA15.COD_PROVEE AS COD_PROVEE, ISNULL(CPA01.NOM_PROVEE, 'Sin asignar') AS [Razón social], STA11.COD_ARTICU AS COD_ARTICU, Sta11.DESCRIPCIO AS DESCRIPCIO, STA11.valor2 AS VALOR_DE_LA_ESCALA_2, STA22.COD_SUCURS AS COD_SUCURS, STA22.NOMBRE_SUC AS NOMBRE_SUC, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END AS UM_MEDIDA_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END) AS SALDO_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_COMP_2 ELSE CANT_COMP END) AS CANTIDAD_COMPROMETIDA_CONTROL_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_PEND_2 ELSE CANT_PEND END) AS CANTIDAD_A_RECIBIR_CONTROL, SUM(CANT_STOCK) AS SALDO_STOCK, SUM(PTO_PEDIDO) AS PUNTO_DE_PEDIDO, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN CANT_STOCK_2 ELSE CANT_STOCK END - Sta11.PTO_PEDIDO) AS DIFERENCIA
FROM
    STA11
INNER JOIN
    STA19
    ON STA11.COD_ARTICU = STA19.COD_ARTICU
INNER JOIN
    STA22
    ON STA19.COD_DEPOSI = STA22.COD_SUCURS
LEFT JOIN
    CPA15
    ON CPA15.COD_ARTICU = STA19.COD_ARTICU
LEFT JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA15.COD_PROVEE
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK
    ON STA11.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK_2
    ON STA11.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA
WHERE
    STA11.STOCK = 1
GROUP BY
    CPA15.Cod_Provee, STA22.COD_SUCURS, ISNULL(CPA01.NOM_PROVEE, 'Sin asignar'), STA11.Cod_Articu, Sta11.Descripcio, STA11.valor2, STA22.NOMBRE_SUC, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK_2 THEN MEDIDA_STOCK_2.SIGLA_MEDIDA ELSE MEDIDA_STOCK.SIGLA_MEDIDA END

GO

-- Vista: STA20_RESUMEN_MOVIMIENTOS_STOCK
SELECT STA20.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, YEAR(STA14.FECHA_MOV) AS ANO, CASE WHEN MONTH(STA14.FECHA_MOV) = '1' THEN '01 Enero' WHEN MONTH(STA14.FECHA_MOV) = '2' THEN '02 Febrero' WHEN MONTH(STA14.FECHA_MOV) = '3' THEN '03 Marzo' WHEN MONTH(STA14.FECHA_MOV) = '4' THEN '04 Abril' WHEN MONTH(STA14.FECHA_MOV) = '5' THEN '05 Mayo' WHEN MONTH(STA14.FECHA_MOV) = '6' THEN '06 Junio' WHEN MONTH(STA14.FECHA_MOV) = '7' THEN '07 Julio' WHEN MONTH(STA14.FECHA_MOV) = '8' THEN '08 Agosto' WHEN MONTH(STA14.FECHA_MOV) = '9' THEN '09 Septiembre' WHEN MONTH(STA14.FECHA_MOV) = '10' THEN '10 Octubre' WHEN MONTH(STA14.FECHA_MOV) = '11' THEN '11 Noviembre' WHEN MONTH(STA14.FECHA_MOV) = '12' THEN '12 Diciembre' END AS MES, DAY(STA14.FECHA_MOV) AS DIA, CASE TIPO_MOV WHEN 'S' THEN 'Salida' WHEN 'E' THEN 'Entrada' END AS TIPO_MOV, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN MEDIDA_MOVI.SIGLA_MEDIDA ELSE MEDIDA_2_MOVI.SIGLA_MEDIDA END AS UM_MEDIDA_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN (CASE TIPO_MOV WHEN 'E' THEN ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD ELSE STA20.CANTIDAD END), STA20.CANTIDAD) ELSE -ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD ELSE STA20.CANTIDAD END), STA20.CANTIDAD) END) ELSE (CASE TIPO_MOV WHEN 'E' THEN ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD_2 ELSE STA20.CANTIDAD_2 END), STA20.CANTIDAD_2) ELSE -ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD_2 ELSE STA20.CANTIDAD_2 END), STA20.CANTIDAD_2) END) END) AS CANTIDAD_CONTROL_STOCK
FROM
    STA20 JOIN STA14
    ON STA14.TCOMP_IN_S = STA20.TCOMP_IN_S AND STA14.NCOMP_IN_S = STA20.NCOMP_IN_S
LEFT JOIN
    STA17
    ON STA14.TALONARIO = STA17.TALONARIO
LEFT JOIN
    GVA14
    ON STA14.COD_PRO_CL = GVA14.COD_CLIENT
LEFT JOIN
    CPA01
    ON STA14.COD_PRO_CL = CPA01.COD_PROVEE
LEFT JOIN
    STA22
    ON STA20.COD_DEPOSI = STA22.COD_SUCURS
LEFT JOIN
    STA11
    ON STA20.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, STA16.LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    SUCURSAL
    ON (STA14.NRO_SUCURS = 0 AND SUCURSAL.NRO_SUCURSAL = (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) ) OR STA14.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    GVA81
    ON STA20.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    STA32
    ON STA11.ESCALA_1 = STA32.COD_ESCALA
LEFT JOIN
    STA32 ESCALA2
    ON STA11.ESCALA_2 = ESCALA2.COD_ESCALA
LEFT JOIN
    STA33
    ON STA11.VALOR1 = STA33.COD_VALOR AND (STA32.COD_ESCALA = STA33.COD_ESCALA)
LEFT JOIN
    STA33 STA33_E2
    ON STA11.VALOR2 = STA33_E2.COD_VALOR AND (ESCALA2.COD_ESCALA = STA33_E2.COD_ESCALA)
LEFT JOIN
    STA09
    ON STA20.NCOMP_IN_S = STA09.NCOMP_IN_S AND STA20.TCOMP_IN_S = STA09.TCOMP_IN_S AND STA20.N_RENGL_S = STA09.N_RENGL_S
LEFT JOIN
    STA08
    ON STA08.N_PARTIDA = STA09.N_PARTIDA
LEFT JOIN
    STA13
    ON STA14.T_COMP = STA13.T_COMP
LEFT JOIN
    (SELECT COD_SUCURS, DIR_SUCURS, NOMBRE_SUC
FROM
    STA22) DDE
    ON STA20.DEPOSI_DDE = DDE.COD_SUCURS CROSS JOIN GVA16
LEFT JOIN
    GVA28 FAMILIA (NOLOCK)
    ON SUBSTRING(GVA14.COD_CLIENT, 1, LONG_FAM_C) = FAMILIA.COD_AGR
LEFT JOIN
    GVA28 GRUPO (NOLOCK)
    ON SUBSTRING(GVA14.COD_CLIENT, 0, LONG_FAM_C + LON_GRUP_C + 1) = GRUPO.COD_AGR
LEFT JOIN
    CPA10
    ON 1 = 1
LEFT JOIN
    CPA03 FAMILIA_P (NOLOCK)
    ON SUBSTRING(CPA01.COD_PROVEE, 1, LONG_FAM_P) = FAMILIA_P.COD_AGR
LEFT JOIN
    CPA03 GRUPO_P (NOLOCK)
    ON SUBSTRING(CPA01.COD_PROVEE, 0 + LONG_FAM_P, LONG_GRU_P + 1) = GRUPO_P.COD_AGR
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') BASE
    ON BASE.COD_ARTICU = STA11.BASE
LEFT JOIN
    STA_ARTICULO_UNIDAD_COMPRA
    ON STA11.ID_STA11 = STA_ARTICULO_UNIDAD_COMPRA.ID_STA11 AND HABITUAL = 1
LEFT JOIN
    MEDIDA AS MEDIDA_VENTAS
    ON (STA11.ID_MEDIDA_VENTAS = MEDIDA_VENTAS.ID_MEDIDA)
LEFT JOIN
    MEDIDA AS MEDIDA_COMPRA
    ON (STA_ARTICULO_UNIDAD_COMPRA.ID_MEDIDA_COMPRA = MEDIDA_COMPRA.ID_MEDIDA)
LEFT JOIN
    MEDIDA AS MEDIDA_MOVI
    ON (STA20.ID_MEDIDA_STOCK = MEDIDA_MOVI.ID_MEDIDA)
LEFT JOIN
    MEDIDA AS MEDIDA_2_MOVI
    ON (STA20.ID_MEDIDA_STOCK_2 = MEDIDA_2_MOVI.ID_MEDIDA)
LEFT JOIN
    SUCURSAL SUC_ORI
    ON STA14.SUC_ORIG = SUC_ORI.NRO_SUCURSAL
LEFT JOIN
    CPA04
    ON CPA04.T_COMP = STA14.T_COMP AND CPA04.N_COMP = STA14.N_COMP
WHERE
    STA20.TIPO_MOV <> 'X' AND STA20.COD_ARTICU <> ''
GROUP BY
    STA20.COD_ARTICU, STA14.FECHA_MOV, STA11.DESCRIPCIO, CASE TIPO_MOV WHEN 'S' THEN 'Salida' WHEN 'E' THEN 'Entrada' END, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN MEDIDA_MOVI.SIGLA_MEDIDA ELSE MEDIDA_2_MOVI.SIGLA_MEDIDA END

GO

-- Vista: STA20_RESUMEN_MOVIMIENTOS_CORRIENTE
SELECT STA20.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, YEAR(STA14.FECHA_MOV) AS ANO, CASE WHEN MONTH(STA14.FECHA_MOV) = '1' THEN '01 Enero' WHEN MONTH(STA14.FECHA_MOV) = '2' THEN '02 Febrero' WHEN MONTH(STA14.FECHA_MOV) = '3' THEN '03 Marzo' WHEN MONTH(STA14.FECHA_MOV) = '4' THEN '04 Abril' WHEN MONTH(STA14.FECHA_MOV) = '5' THEN '05 Mayo' WHEN MONTH(STA14.FECHA_MOV) = '6' THEN '06 Junio' WHEN MONTH(STA14.FECHA_MOV) = '7' THEN '07 Julio' WHEN MONTH(STA14.FECHA_MOV) = '8' THEN '08 Agosto' WHEN MONTH(STA14.FECHA_MOV) = '9' THEN '09 Septiembre' WHEN MONTH(STA14.FECHA_MOV) = '10' THEN '10 Octubre' WHEN MONTH(STA14.FECHA_MOV) = '11' THEN '11 Noviembre' WHEN MONTH(STA14.FECHA_MOV) = '12' THEN '12 Diciembre' END AS MES, DAY(STA14.FECHA_MOV) AS DIA, CASE TIPO_MOV WHEN 'S' THEN 'Salida' WHEN 'E' THEN 'Entrada' END AS TIPO_MOV, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN MEDIDA_MOVI.SIGLA_MEDIDA ELSE MEDIDA_2_MOVI.SIGLA_MEDIDA END AS UM_MEDIDA_STOCK, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN (CASE TIPO_MOV WHEN 'E' THEN ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD ELSE STA20.CANTIDAD END), STA20.CANTIDAD) ELSE -ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD ELSE STA20.CANTIDAD END), STA20.CANTIDAD) END) ELSE (CASE TIPO_MOV WHEN 'E' THEN ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD_2 ELSE STA20.CANTIDAD_2 END), STA20.CANTIDAD_2) ELSE -ISNULL((CASE STA11.USA_PARTID WHEN 1 THEN STA09.CANTIDAD_2 ELSE STA20.CANTIDAD_2 END), STA20.CANTIDAD_2) END) END) AS CANTIDAD_CONTROL_STOCK
FROM
    STA20 JOIN STA14
    ON STA14.TCOMP_IN_S = STA20.TCOMP_IN_S AND STA14.NCOMP_IN_S = STA20.NCOMP_IN_S
LEFT JOIN
    STA17
    ON STA14.TALONARIO = STA17.TALONARIO
LEFT JOIN
    GVA14
    ON STA14.COD_PRO_CL = GVA14.COD_CLIENT
LEFT JOIN
    CPA01
    ON STA14.COD_PRO_CL = CPA01.COD_PROVEE
LEFT JOIN
    STA22
    ON STA20.COD_DEPOSI = STA22.COD_SUCURS
LEFT JOIN
    STA11
    ON STA20.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, STA16.LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    SUCURSAL
    ON (STA14.NRO_SUCURS = 0 AND SUCURSAL.NRO_SUCURSAL = (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) ) OR STA14.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    GVA81
    ON STA20.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    STA32
    ON STA11.ESCALA_1 = STA32.COD_ESCALA
LEFT JOIN
    STA32 ESCALA2
    ON STA11.ESCALA_2 = ESCALA2.COD_ESCALA
LEFT JOIN
    STA33
    ON STA11.VALOR1 = STA33.COD_VALOR AND (STA32.COD_ESCALA = STA33.COD_ESCALA)
LEFT JOIN
    STA33 STA33_E2
    ON STA11.VALOR2 = STA33_E2.COD_VALOR AND (ESCALA2.COD_ESCALA = STA33_E2.COD_ESCALA)
LEFT JOIN
    STA09
    ON STA20.NCOMP_IN_S = STA09.NCOMP_IN_S AND STA20.TCOMP_IN_S = STA09.TCOMP_IN_S AND STA20.N_RENGL_S = STA09.N_RENGL_S
LEFT JOIN
    STA08
    ON STA08.N_PARTIDA = STA09.N_PARTIDA
LEFT JOIN
    STA13
    ON STA14.T_COMP = STA13.T_COMP
LEFT JOIN
    (SELECT COD_SUCURS, DIR_SUCURS, NOMBRE_SUC
FROM
    STA22) DDE
    ON STA20.DEPOSI_DDE = DDE.COD_SUCURS CROSS JOIN GVA16
LEFT JOIN
    GVA28 FAMILIA (NOLOCK)
    ON SUBSTRING(GVA14.COD_CLIENT, 1, LONG_FAM_C) = FAMILIA.COD_AGR
LEFT JOIN
    GVA28 GRUPO (NOLOCK)
    ON SUBSTRING(GVA14.COD_CLIENT, 0, LONG_FAM_C + LON_GRUP_C + 1) = GRUPO.COD_AGR
LEFT JOIN
    CPA10
    ON 1 = 1
LEFT JOIN
    CPA03 FAMILIA_P (NOLOCK)
    ON SUBSTRING(CPA01.COD_PROVEE, 1, LONG_FAM_P) = FAMILIA_P.COD_AGR
LEFT JOIN
    CPA03 GRUPO_P (NOLOCK)
    ON SUBSTRING(CPA01.COD_PROVEE, 0 + LONG_FAM_P, LONG_GRU_P + 1) = GRUPO_P.COD_AGR
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') BASE
    ON BASE.COD_ARTICU = STA11.BASE
LEFT JOIN
    STA_ARTICULO_UNIDAD_COMPRA
    ON STA11.ID_STA11 = STA_ARTICULO_UNIDAD_COMPRA.ID_STA11 AND HABITUAL = 1
LEFT JOIN
    MEDIDA AS MEDIDA_VENTAS
    ON (STA11.ID_MEDIDA_VENTAS = MEDIDA_VENTAS.ID_MEDIDA)
LEFT JOIN
    MEDIDA AS MEDIDA_COMPRA
    ON (STA_ARTICULO_UNIDAD_COMPRA.ID_MEDIDA_COMPRA = MEDIDA_COMPRA.ID_MEDIDA)
LEFT JOIN
    MEDIDA AS MEDIDA_MOVI
    ON (STA20.ID_MEDIDA_STOCK = MEDIDA_MOVI.ID_MEDIDA)
LEFT JOIN
    MEDIDA AS MEDIDA_2_MOVI
    ON (STA20.ID_MEDIDA_STOCK_2 = MEDIDA_2_MOVI.ID_MEDIDA)
LEFT JOIN
    SUCURSAL SUC_ORI
    ON STA14.SUC_ORIG = SUC_ORI.NRO_SUCURSAL
LEFT JOIN
    CPA04
    ON CPA04.T_COMP = STA14.T_COMP AND CPA04.N_COMP = STA14.N_COMP
WHERE
    STA20.TIPO_MOV <> 'X' AND STA20.COD_ARTICU <> '' AND (YEAR(STA14.FECHA_MOV) >= YEAR(GETDATE()))
GROUP BY
    STA20.COD_ARTICU, STA14.FECHA_MOV, STA11.DESCRIPCIO, CASE TIPO_MOV WHEN 'S' THEN 'Salida' WHEN 'E' THEN 'Entrada' END, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN MEDIDA_MOVI.SIGLA_MEDIDA ELSE MEDIDA_2_MOVI.SIGLA_MEDIDA END

GO

-- Vista: STA11_INDICE_ROTACION_STOCK
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, CASE ((ISNULL((SELECT SUM(SALDO_ANT)
FROM
    STA19
WHERE
    STA11.COD_ARTICU = STA19.COD_ARTICU), 0) + ISNULL((SELECT SUM(CASE WHEN TIPO_MOV = 'S' THEN (CANTIDAD * -1) WHEN TIPO_MOV = 'E' THEN CANTIDAD END)
FROM
    STA20
WHERE
    COD_ARTICU = STA11.COD_ARTICU AND FECHA_MOV <= DATEADD(yy, DATEDIFF(yy,0,getdate()), 0)), 0)) + (ISNULL((SELECT SUM(SALDO_ANT)
FROM
    STA19
WHERE
    STA11.COD_ARTICU = STA19.COD_ARTICU), 0) + ISNULL((SELECT SUM(CASE WHEN TIPO_MOV = 'S' THEN (CANTIDAD * -1) WHEN TIPO_MOV = 'E' THEN CANTIDAD END)
FROM
    STA20
WHERE
    COD_ARTICU = STA11.COD_ARTICU AND FECHA_MOV <= DATEADD(yy, DATEDIFF(yy,0,getdate()) + 1, -1)), 0))) WHEN 0 THEN 0 ELSE ISNULL((SELECT SUM(CASE TIPO_MOV WHEN 'E' THEN STA20.CANTIDAD ELSE -1 * STA20.CANTIDAD END)
FROM
    STA20
WHERE
    TCOMP_IN_S IN ('FC', 'FR', 'CC', 'DC', 'RC', 'RE', 'DR') AND STA20.FECHA_MOV BETWEEN DATEADD(yy, DATEDIFF(yy,0,getdate()), 0) AND DATEADD(yy, DATEDIFF(yy,0,getdate()) + 1, -1) AND STA20.COD_ARTICU = STA11.COD_ARTICU), 0) / (((ISNULL((SELECT SUM(SALDO_ANT)
FROM
    STA19
WHERE
    STA11.COD_ARTICU = STA19.COD_ARTICU), 0) + ISNULL((SELECT SUM(CASE WHEN TIPO_MOV = 'S' THEN (CANTIDAD * -1) WHEN TIPO_MOV = 'E' THEN CANTIDAD END)
FROM
    STA20
WHERE
    COD_ARTICU = STA11.COD_ARTICU AND FECHA_MOV <= DATEADD(yy, DATEDIFF(yy,0,getdate()), 0)), 0)) + (ISNULL((SELECT SUM(SALDO_ANT)
FROM
    STA19
WHERE
    STA11.COD_ARTICU = STA19.COD_ARTICU), 0) + ISNULL((SELECT SUM(CASE WHEN TIPO_MOV = 'S' THEN (CANTIDAD * -1) WHEN TIPO_MOV = 'E' THEN CANTIDAD END)
FROM
    STA20
WHERE
    COD_ARTICU = STA11.COD_ARTICU AND FECHA_MOV <= DATEADD(yy, DATEDIFF(yy,0,getdate()) + 1, -1)), 0))) / 2) END AS INDICE_ROTACION
FROM
    STA11
INNER JOIN
    STA19
    ON STA11.COD_ARTICU = STA19.COD_ARTICU
INNER JOIN
    STA22
    ON STA19.COD_DEPOSI = STA22.COD_SUCURS
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
INNER JOIN
    (SELECT GETDATE() AS FECHA) AS TMP
    ON (1 = 1)
WHERE
    STA11.STOCK = 1 AND STA11.PERFIL <> 'N' AND (((1 = 1)))
GROUP BY
    STA11.Cod_Articu, Sta11.Descripcio

GO

-- Vista: STA09_PARTIDAS_MOVIMIENTOS
SELECT STA08.N_PARTIDA AS N_PARTIDA, STA08.N_DESPACHO AS N_DESPACHO, CASE STA08.FECHA_VTO WHEN '01/01/1800' THEN NULL ELSE STA08.FECHA_VTO END AS FECHA_VTO, STA09.COD_DEPOSI AS COD_DEPOSI, STA20.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN 'VENTAS' WHEN 'FR' THEN 'VENTAS' WHEN 'CC' THEN 'VENTAS' WHEN 'DC' THEN 'VENTAS' WHEN 'RC' THEN 'VENTAS' WHEN 'RE' THEN 'VENTAS' WHEN 'DR' THEN 'VENTAS' WHEN 'FP' THEN 'COMPRAS' WHEN 'FS' THEN 'COMPRAS' WHEN 'CP' THEN 'COMPRAS' WHEN 'DP' THEN 'COMPRAS' WHEN 'OP' THEN 'COMPRAS' WHEN 'RP' THEN 'COMPRAS' WHEN 'DS' THEN 'COMPRAS' WHEN 'AJ' THEN 'STOCK' WHEN 'AR' THEN 'STOCK' WHEN 'TI' THEN 'STOCK' WHEN 'VS' THEN 'STOCK' WHEN 'VE' THEN 'STOCK' WHEN 'ME' THEN 'RESTÔ' WHEN 'CR' THEN 'RESTÔ' END AS MODULO, YEAR(STA08.FECHA_VTO) AS ANO, CASE WHEN MONTH(STA08.FECHA_VTO) = '1' THEN '01 Enero' WHEN MONTH(STA08.FECHA_VTO) = '2' THEN '02 Febrero' WHEN MONTH(STA08.FECHA_VTO) = '3' THEN '03 Marzo' WHEN MONTH(STA08.FECHA_VTO) = '4' THEN '04 Abril' WHEN MONTH(STA08.FECHA_VTO) = '5' THEN '05 Mayo' WHEN MONTH(STA08.FECHA_VTO) = '6' THEN '06 Junio' WHEN MONTH(STA08.FECHA_VTO) = '7' THEN '07 Julio' WHEN MONTH(STA08.FECHA_VTO) = '8' THEN '08 Agosto' WHEN MONTH(STA08.FECHA_VTO) = '9' THEN '09 Septiembre' WHEN MONTH(STA08.FECHA_VTO) = '10' THEN '10 Octubre' WHEN MONTH(STA08.FECHA_VTO) = '11' THEN '11 Noviembre' WHEN MONTH(STA08.FECHA_VTO) = '12' THEN '12 Diciembre' END AS MES, DAY(STA08.FECHA_VTO) AS DIA, STA14.COD_PRO_CL AS COD_PRO_CL, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RE' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FP' THEN CPA01.NOM_PROVEE WHEN 'FS' THEN CPA01.NOM_PROVEE WHEN 'CP' THEN CPA01.NOM_PROVEE WHEN 'DP' THEN CPA01.NOM_PROVEE WHEN 'OP' THEN CPA01.NOM_PROVEE WHEN 'RP' THEN CPA01.NOM_PROVEE WHEN 'DS' THEN CPA01.NOM_PROVEE WHEN 'AJ' THEN '' WHEN 'AR' THEN '' WHEN 'TI' THEN '' WHEN 'VE' THEN '' WHEN 'VS' THEN '' WHEN ' ' THEN 'STOCK' WHEN ' ' THEN 'STOCK' WHEN 'ME' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) END AS RAZON_SOCI, SUCURSAL.DESC_SUCURSAL AS DESC_SUCURSAL, CASE STA20.TIPO_MOV WHEN 'E' THEN 'Entrada' WHEN 'S' THEN 'Salida' WHEN 'X' THEN 'No genere movimiento' END AS TIPO_MOV, SUM(CASE WHEN STA20.TIPO_MOV = 'E' THEN STA09.CANTIDAD ELSE STA09.CANTIDAD * -1 END) AS CANTIDAD, CASE WHEN STA14.TCOMP_IN_S IN ('DR', 'DS') THEN STA14.N_REMITO END AS REMITO, MEDIDA_STOCK.SIGLA_MEDIDA AS UM_MEDIDA_STOCK, MEDIDA_STOCK_2.SIGLA_MEDIDA AS UM_MEDIDA_STOCK_2, SUM(CASE WHEN STA20.TIPO_MOV = 'E' THEN STA09.CANTIDAD_2 ELSE STA09.CANTIDAD_2 * -1 END) AS CANTIDAD_2, STA14.TCOMP_IN_S AS TCOMP_IN_S, STA14.NCOMP_IN_S AS NCOMP_IN_S, STA20.N_RENGL_S AS N_RENGL_S, CPA04.COD_PROVEE AS COD_PROVEE, GVA12.COD_CLIENT AS COD_CLIENT, STA14.NRO_SUCURS AS NRO_SUCURS, CPA04.TCOMP_IN_C AS TCOMP_IN_C, CPA04.NCOMP_IN_C AS NCOMP_IN_C
FROM
    STA09
LEFT JOIN
    STA20
    ON STA20.TCOMP_IN_S = STA09.TCOMP_IN_S AND STA20.NCOMP_IN_S = STA09.NCOMP_IN_S AND STA20.N_RENGL_S = STA09.N_RENGL_S
LEFT JOIN
    STA08
    ON STA08.N_PARTIDA = STA09.N_PARTIDA
LEFT JOIN
    STA14
    ON STA14.TCOMP_IN_S = STA20.TCOMP_IN_S AND STA14.NCOMP_IN_S = STA20.NCOMP_IN_S
LEFT JOIN
    GVA12
    ON GVA12.T_COMP = STA14.T_COMP AND GVA12.N_COMP = STA14.N_COMP
LEFT JOIN
    CPA04
    ON CPA04.T_COMP = STA14.T_COMP AND CPA04.N_COMP = STA14.N_COMP AND CPA04.COD_PROVEE = STA14.COD_PRO_CL
LEFT JOIN
    GVA14
    ON STA14.COD_PRO_CL = GVA14.COD_CLIENT
LEFT JOIN
    CPA01
    ON STA14.COD_PRO_CL = CPA01.COD_PROVEE
LEFT JOIN
    SUCURSAL
    ON (STA14.NRO_SUCURS = 0 AND SUCURSAL.NRO_SUCURSAL = (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) ) OR STA14.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    STA11
    ON STA11.COD_ARTICU = STA20.COD_ARTICU
LEFT JOIN
    STA22
    ON STA22.COD_SUCURS = STA20.COD_DEPOSI
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON STA11.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON STA11.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA
GROUP BY
    STA08.N_PARTIDA, STA08.N_DESPACHO, CASE STA08.FECHA_VTO WHEN '01/01/1800' THEN NULL ELSE STA08.FECHA_VTO END, STA09.COD_DEPOSI, STA20.COD_ARTICU, STA11.DESCRIPCIO, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN 'VENTAS' WHEN 'FR' THEN 'VENTAS' WHEN 'CC' THEN 'VENTAS' WHEN 'DC' THEN 'VENTAS' WHEN 'RC' THEN 'VENTAS' WHEN 'RE' THEN 'VENTAS' WHEN 'DR' THEN 'VENTAS' WHEN 'FP' THEN 'COMPRAS' WHEN 'FS' THEN 'COMPRAS' WHEN 'CP' THEN 'COMPRAS' WHEN 'DP' THEN 'COMPRAS' WHEN 'OP' THEN 'COMPRAS' WHEN 'RP' THEN 'COMPRAS' WHEN 'DS' THEN 'COMPRAS' WHEN 'AJ' THEN 'STOCK' WHEN 'AR' THEN 'STOCK' WHEN 'TI' THEN 'STOCK' WHEN 'VS' THEN 'STOCK' WHEN 'VE' THEN 'STOCK' WHEN 'ME' THEN 'RESTÔ' WHEN 'CR' THEN 'RESTÔ' END, STA14.FECHA_MOV, STA08.FECHA_VTO, STA14.T_COMP, STA14.N_COMP, STA14.COD_PRO_CL, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RE' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FP' THEN CPA01.NOM_PROVEE WHEN 'FS' THEN CPA01.NOM_PROVEE WHEN 'CP' THEN CPA01.NOM_PROVEE WHEN 'DP' THEN CPA01.NOM_PROVEE WHEN 'OP' THEN CPA01.NOM_PROVEE WHEN 'RP' THEN CPA01.NOM_PROVEE WHEN 'DS' THEN CPA01.NOM_PROVEE WHEN 'AJ' THEN '' WHEN 'AR' THEN '' WHEN 'TI' THEN '' WHEN 'VE' THEN '' WHEN 'VS' THEN '' WHEN ' ' THEN 'STOCK' WHEN ' ' THEN 'STOCK' WHEN 'ME' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) END, SUCURSAL.DESC_SUCURSAL, CASE STA20.TIPO_MOV WHEN 'E' THEN 'Entrada' WHEN 'S' THEN 'Salida' WHEN 'X' THEN 'No genere movimiento' END, CASE WHEN STA14.TCOMP_IN_S IN ('DR', 'DS') THEN STA14.N_REMITO END, MEDIDA_STOCK.SIGLA_MEDIDA, MEDIDA_STOCK_2.SIGLA_MEDIDA, STA14.TCOMP_IN_S, STA14.NCOMP_IN_S, STA20.N_RENGL_S, CPA04.COD_PROVEE, GVA12.COD_CLIENT, STA14.NRO_SUCURS, CPA04.TCOMP_IN_C, CPA04.NCOMP_IN_C, GVA12.T_COMP, GVA12.N_COMP

GO

-- Vista: STA09_PARTIDAS_MOVIMIENTOS_CORRIENTE
SELECT STA08.N_PARTIDA AS N_PARTIDA, STA08.N_DESPACHO AS N_DESPACHO, CASE STA08.FECHA_VTO WHEN '01/01/1800' THEN NULL ELSE STA08.FECHA_VTO END AS FECHA_VTO, STA09.COD_DEPOSI AS COD_DEPOSI, STA20.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN 'VENTAS' WHEN 'FR' THEN 'VENTAS' WHEN 'CC' THEN 'VENTAS' WHEN 'DC' THEN 'VENTAS' WHEN 'RC' THEN 'VENTAS' WHEN 'RE' THEN 'VENTAS' WHEN 'DR' THEN 'VENTAS' WHEN 'FP' THEN 'COMPRAS' WHEN 'FS' THEN 'COMPRAS' WHEN 'CP' THEN 'COMPRAS' WHEN 'DP' THEN 'COMPRAS' WHEN 'OP' THEN 'COMPRAS' WHEN 'RP' THEN 'COMPRAS' WHEN 'DS' THEN 'COMPRAS' WHEN 'AJ' THEN 'STOCK' WHEN 'AR' THEN 'STOCK' WHEN 'TI' THEN 'STOCK' WHEN 'VS' THEN 'STOCK' WHEN 'VE' THEN 'STOCK' WHEN 'ME' THEN 'RESTÔ' WHEN 'CR' THEN 'RESTÔ' END AS MODULO, YEAR(STA08.FECHA_VTO) AS ANO, CASE WHEN MONTH(STA08.FECHA_VTO) = '1' THEN '01 Enero' WHEN MONTH(STA08.FECHA_VTO) = '2' THEN '02 Febrero' WHEN MONTH(STA08.FECHA_VTO) = '3' THEN '03 Marzo' WHEN MONTH(STA08.FECHA_VTO) = '4' THEN '04 Abril' WHEN MONTH(STA08.FECHA_VTO) = '5' THEN '05 Mayo' WHEN MONTH(STA08.FECHA_VTO) = '6' THEN '06 Junio' WHEN MONTH(STA08.FECHA_VTO) = '7' THEN '07 Julio' WHEN MONTH(STA08.FECHA_VTO) = '8' THEN '08 Agosto' WHEN MONTH(STA08.FECHA_VTO) = '9' THEN '09 Septiembre' WHEN MONTH(STA08.FECHA_VTO) = '10' THEN '10 Octubre' WHEN MONTH(STA08.FECHA_VTO) = '11' THEN '11 Noviembre' WHEN MONTH(STA08.FECHA_VTO) = '12' THEN '12 Diciembre' END AS MES, DAY(STA08.FECHA_VTO) AS DIA, STA14.COD_PRO_CL AS COD_PRO_CL, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RE' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FP' THEN CPA01.NOM_PROVEE WHEN 'FS' THEN CPA01.NOM_PROVEE WHEN 'CP' THEN CPA01.NOM_PROVEE WHEN 'DP' THEN CPA01.NOM_PROVEE WHEN 'OP' THEN CPA01.NOM_PROVEE WHEN 'RP' THEN CPA01.NOM_PROVEE WHEN 'DS' THEN CPA01.NOM_PROVEE WHEN 'AJ' THEN '' WHEN 'AR' THEN '' WHEN 'TI' THEN '' WHEN 'VE' THEN '' WHEN 'VS' THEN '' WHEN ' ' THEN 'STOCK' WHEN ' ' THEN 'STOCK' WHEN 'ME' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) END AS RAZON_SOCI, SUCURSAL.DESC_SUCURSAL AS DESC_SUCURSAL, CASE STA20.TIPO_MOV WHEN 'E' THEN 'Entrada' WHEN 'S' THEN 'Salida' WHEN 'X' THEN 'No genere movimiento' END AS TIPO_MOV, SUM(CASE WHEN STA20.TIPO_MOV = 'E' THEN STA09.CANTIDAD ELSE STA09.CANTIDAD * -1 END) AS CANTIDAD, CASE WHEN STA14.TCOMP_IN_S IN ('DR', 'DS') THEN STA14.N_REMITO END AS REMITO, MEDIDA_STOCK.SIGLA_MEDIDA AS UM_MEDIDA_STOCK, MEDIDA_STOCK_2.SIGLA_MEDIDA AS UM_MEDIDA_STOCK_2, SUM(CASE WHEN STA20.TIPO_MOV = 'E' THEN STA09.CANTIDAD_2 ELSE STA09.CANTIDAD_2 * -1 END) AS CANTIDAD_2, STA14.TCOMP_IN_S AS TCOMP_IN_S, STA14.NCOMP_IN_S AS NCOMP_IN_S, STA20.N_RENGL_S AS N_RENGL_S, CPA04.COD_PROVEE AS COD_PROVEE, GVA12.COD_CLIENT AS COD_CLIENT, STA14.NRO_SUCURS AS NRO_SUCURS, CPA04.TCOMP_IN_C AS TCOMP_IN_C, CPA04.NCOMP_IN_C AS NCOMP_IN_C
FROM
    STA09
LEFT JOIN
    STA20
    ON STA20.TCOMP_IN_S = STA09.TCOMP_IN_S AND STA20.NCOMP_IN_S = STA09.NCOMP_IN_S AND STA20.N_RENGL_S = STA09.N_RENGL_S
LEFT JOIN
    STA08
    ON STA08.N_PARTIDA = STA09.N_PARTIDA
LEFT JOIN
    STA14
    ON STA14.TCOMP_IN_S = STA20.TCOMP_IN_S AND STA14.NCOMP_IN_S = STA20.NCOMP_IN_S
LEFT JOIN
    GVA12
    ON GVA12.T_COMP = STA14.T_COMP AND GVA12.N_COMP = STA14.N_COMP
LEFT JOIN
    CPA04
    ON CPA04.T_COMP = STA14.T_COMP AND CPA04.N_COMP = STA14.N_COMP AND CPA04.COD_PROVEE = STA14.COD_PRO_CL
LEFT JOIN
    GVA14
    ON STA14.COD_PRO_CL = GVA14.COD_CLIENT
LEFT JOIN
    CPA01
    ON STA14.COD_PRO_CL = CPA01.COD_PROVEE
LEFT JOIN
    SUCURSAL
    ON (STA14.NRO_SUCURS = 0 AND SUCURSAL.NRO_SUCURSAL = (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) ) OR STA14.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    STA11
    ON STA11.COD_ARTICU = STA20.COD_ARTICU
LEFT JOIN
    STA22
    ON STA22.COD_SUCURS = STA20.COD_DEPOSI
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON STA11.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON STA11.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA
WHERE
    (YEAR(STA14.FECHA_MOV) >= YEAR(GETDATE()))
GROUP BY
    STA08.N_PARTIDA, STA08.N_DESPACHO, CASE STA08.FECHA_VTO WHEN '01/01/1800' THEN NULL ELSE STA08.FECHA_VTO END, STA09.COD_DEPOSI, STA20.COD_ARTICU, STA11.DESCRIPCIO, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN 'VENTAS' WHEN 'FR' THEN 'VENTAS' WHEN 'CC' THEN 'VENTAS' WHEN 'DC' THEN 'VENTAS' WHEN 'RC' THEN 'VENTAS' WHEN 'RE' THEN 'VENTAS' WHEN 'DR' THEN 'VENTAS' WHEN 'FP' THEN 'COMPRAS' WHEN 'FS' THEN 'COMPRAS' WHEN 'CP' THEN 'COMPRAS' WHEN 'DP' THEN 'COMPRAS' WHEN 'OP' THEN 'COMPRAS' WHEN 'RP' THEN 'COMPRAS' WHEN 'DS' THEN 'COMPRAS' WHEN 'AJ' THEN 'STOCK' WHEN 'AR' THEN 'STOCK' WHEN 'TI' THEN 'STOCK' WHEN 'VS' THEN 'STOCK' WHEN 'VE' THEN 'STOCK' WHEN 'ME' THEN 'RESTÔ' WHEN 'CR' THEN 'RESTÔ' END, STA14.FECHA_MOV, STA08.FECHA_VTO, STA14.T_COMP, STA14.N_COMP, STA14.COD_PRO_CL, CASE STA14.TCOMP_IN_S WHEN 'FC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RC' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'RE' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'DR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'FP' THEN CPA01.NOM_PROVEE WHEN 'FS' THEN CPA01.NOM_PROVEE WHEN 'CP' THEN CPA01.NOM_PROVEE WHEN 'DP' THEN CPA01.NOM_PROVEE WHEN 'OP' THEN CPA01.NOM_PROVEE WHEN 'RP' THEN CPA01.NOM_PROVEE WHEN 'DS' THEN CPA01.NOM_PROVEE WHEN 'AJ' THEN '' WHEN 'AR' THEN '' WHEN 'TI' THEN '' WHEN 'VE' THEN '' WHEN 'VS' THEN '' WHEN ' ' THEN 'STOCK' WHEN ' ' THEN 'STOCK' WHEN 'ME' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) WHEN 'CR' THEN (CASE STA14.COD_PRO_CL WHEN '000000' THEN 'OCASIONAL' ELSE GVA14.RAZON_SOCI END) END, SUCURSAL.DESC_SUCURSAL, CASE STA20.TIPO_MOV WHEN 'E' THEN 'Entrada' WHEN 'S' THEN 'Salida' WHEN 'X' THEN 'No genere movimiento' END, CASE WHEN STA14.TCOMP_IN_S IN ('DR', 'DS') THEN STA14.N_REMITO END, MEDIDA_STOCK.SIGLA_MEDIDA, MEDIDA_STOCK_2.SIGLA_MEDIDA, STA14.TCOMP_IN_S, STA14.NCOMP_IN_S, STA20.N_RENGL_S, CPA04.COD_PROVEE, GVA12.COD_CLIENT, STA14.NRO_SUCURS, CPA04.TCOMP_IN_C, CPA04.NCOMP_IN_C, GVA12.T_COMP, GVA12.N_COMP

GO

-- Vista: STA10_SALDO_PARTIDAS
SELECT STA10.N_PARTIDA AS N_PARTIDA, STA08.n_despacho AS n_despacho, CASE STA10.FECHA_VTO WHEN '01/01/1800' THEN NULL ELSE STA10.FECHA_VTO END AS FECHA_VTO, YEAR(STA10.FECHA_VTO) AS ANO, CASE WHEN MONTH(STA10.FECHA_VTO) = '1' THEN '01 Enero' WHEN MONTH(STA10.FECHA_VTO) = '2' THEN '02 Febrero' WHEN MONTH(STA10.FECHA_VTO) = '3' THEN '03 Marzo' WHEN MONTH(STA10.FECHA_VTO) = '4' THEN '04 Abril' WHEN MONTH(STA10.FECHA_VTO) = '5' THEN '05 Mayo' WHEN MONTH(STA10.FECHA_VTO) = '6' THEN '06 Junio' WHEN MONTH(STA10.FECHA_VTO) = '7' THEN '07 Julio' WHEN MONTH(STA10.FECHA_VTO) = '8' THEN '08 Agosto' WHEN MONTH(STA10.FECHA_VTO) = '9' THEN '09 Septiembre' WHEN MONTH(STA10.FECHA_VTO) = '10' THEN '10 Octubre' WHEN MONTH(STA10.FECHA_VTO) = '11' THEN '11 Noviembre' WHEN MONTH(STA10.FECHA_VTO) = '12' THEN '12 Diciembre' END AS MES, DAY(STA10.FECHA_VTO) AS DIA, STA08.t_comp AS t_comp, STA10.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, STA10.COD_DEPOSI AS COD_DEPOSI, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN MEDIDA_STOCK.SIGLA_MEDIDA ELSE MEDIDA_STOCK_2.SIGLA_MEDIDA END AS UM_MEDIDA_STOCK, STA22.NOMBRE_SUC AS NOMBRE_SUC, STA22.COD_SUCURS AS COD_SUCURS, SUM(CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN STA10.CANTIDAD ELSE STA10.CANTIDAD_2 END) AS SALDO_CONTROL_STOCK, SUM(STA10.Cantidad) AS SALDO_STOCK, SUM(STA10.Cantidad_2) AS SALDO_STOCK_2
FROM
    STA10
INNER JOIN
    STA11
    ON STA11.COD_ARTICU = STA10.COD_ARTICU
INNER JOIN
    STA22
    ON STA22.COD_SUCURS = STA10.COD_DEPOSI
INNER JOIN
    sta08
    ON sta08.n_partida = sta10.n_partida
LEFT JOIN
    cpa01
    ON cpa01.cod_provee = sta08.cod_provee
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK
    ON STA11.ID_MEDIDA_STOCK = MEDIDA_STOCK.ID_MEDIDA
LEFT JOIN
    MEDIDA AS MEDIDA_STOCK_2
    ON STA11.ID_MEDIDA_STOCK_2 = MEDIDA_STOCK_2.ID_MEDIDA
GROUP BY
    STA10.N_PARTIDA, STA08.n_despacho, CASE STA10.FECHA_VTO WHEN '01/01/1800' THEN NULL ELSE STA10.FECHA_VTO END, STA08.t_comp, STA10.COD_ARTICU, STA10.FECHA_VTO, STA11.DESCRIPCIO, STA22.COD_SUCURS, STA10.COD_DEPOSI, CASE WHEN STA11.ID_MEDIDA_CONTROL_STOCK = STA11.ID_MEDIDA_STOCK THEN MEDIDA_STOCK.SIGLA_MEDIDA ELSE MEDIDA_STOCK_2.SIGLA_MEDIDA END, STA22.NOMBRE_SUC

GO

-- Vista: STA11_EXISTENCIAS_REPOSICION
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(ISNULL(CANT_STOCK, 0)) AS SALDO, gva16.cotiz AS COTIZ, ROUND(ISNULL((SELECT TOP 1 (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE WHEN sta12.mon_cte = 1 THEN PRECIO_REP ELSE (PRECIO_REP * CASE WHEN 0.0000 > 0 THEN 0.0000 ELSE GVA16.COTIZ END) END) ELSE (CASE WHEN sta12.mon_cte = 0 THEN PRECIO_REP ELSE (PRECIO_REP / CASE WHEN 0.0000 > 0 THEN 0.0000 ELSE GVA16.COTIZ END) END) END) AS PRECIO
FROM
    STA12
WHERE
    STA12.COD_ARTICU = STA11.COD_ARTICU), 0), ISNULL((SELECT PRECIOS
FROM
    TGANUM), 2)) AS COSTO, SUM(ISNULL(CANT_STOCK, 0) * ISNULL(ROUND((CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE WHEN sta12.mon_cte = 1 THEN PRECIO_REP ELSE (PRECIO_REP * CASE WHEN 0.0000 > 0 THEN 0.0000 ELSE GVA16.COTIZ END) END) ELSE (CASE WHEN sta12.mon_cte = 0 THEN PRECIO_REP ELSE (PRECIO_REP / CASE WHEN 0.0000 > 0 THEN 0.0000 ELSE GVA16.COTIZ END) END) END), PRECIOS), 0)) AS SALDO_VALORIZADO
FROM
    STA11
LEFT JOIN
    STA19
    ON STA11.COD_ARTICU = STA19.COD_ARTICU
LEFT JOIN
    GVA16
    ON 1 = 1
LEFT JOIN
    STA12
    ON STA12.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    TGANUM
    ON 1 = 1
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
WHERE
    STA11.Stock = 1 AND STA11.PERFIL <> 'N'
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, gva16.cotiz

GO

-- Vista: STA11_EXISTENCIAS_ULTIMA_COMPRA
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(ISNULL(CANT_STOCK, 0)) AS SALDO, ROUND(ISNULL((SELECT TOP 1 (CASE WHEN 'BIMONCTE' = 'BIMONCTE' THEN (CASE WHEN 'BIORIGEN' = 'BIORIGEN' THEN ISNULL(STA12.PRECIO_U_L, 0) ELSE (CASE WHEN STA12.MON_CTE_UC = 1 THEN ISNULL(STA12.PRECIO_U_L, 0) ELSE ISNULL(STA12.PRECIO_U_E, 0) * (CASE WHEN 0.0000 = 0 THEN GVA16.COTIZ ELSE 0.0000 END) END) END) ELSE (CASE WHEN 'BIORIGEN' = 'BIORIGEN' THEN ISNULL(STA12.PRECIO_U_E, 0) ELSE (CASE WHEN STA12.MON_CTE_UC = 0 THEN ISNULL(STA12.PRECIO_U_E, 0) ELSE ISNULL(STA12.PRECIO_U_L, 0) / (CASE WHEN 0.0000 = 0 THEN GVA16.COTIZ ELSE 0.0000 END) END) END) END)
FROM
    STA12
WHERE
    STA12.COD_ARTICU = STA11.COD_ARTICU), 0), (ISNULL(TGANUM.PRECIOS, 2))) AS COSTO, SUM(ISNULL(CANT_STOCK, 0) * ROUND(ISNULL((CASE WHEN 'BIMONCTE' = 'BIMONCTE' THEN (CASE WHEN 'BIORIGEN' = 'BIORIGEN' THEN ISNULL(STA12.PRECIO_U_L, 0) ELSE (CASE WHEN STA12.MON_CTE_UC = 1 THEN ISNULL(STA12.PRECIO_U_L, 0) ELSE ISNULL(STA12.PRECIO_U_E, 0) * (CASE WHEN 0.0000 = 0 THEN GVA16.COTIZ ELSE 0.0000 END) END) END) ELSE (CASE WHEN 'BIORIGEN' = 'BIORIGEN' THEN ISNULL(STA12.PRECIO_U_E, 0) ELSE (CASE WHEN STA12.MON_CTE_UC = 0 THEN ISNULL(STA12.PRECIO_U_E, 0) ELSE ISNULL(STA12.PRECIO_U_L, 0) / (CASE WHEN 0.0000 = 0 THEN GVA16.COTIZ ELSE 0.0000 END) END) END) END), 0), ISNULL(TGANUM.PRECIOS, 2))) AS SALDO_VALORIZADO, gva16.cotiz AS COTIZ, TGANUM.IMPORTES AS IMPORTES, TGANUM.UNIDADES AS UNIDADES, TGANUM.PRECIOS AS PRECIOS
FROM
    STA11
LEFT JOIN
    STA19
    ON STA11.COD_ARTICU = STA19.COD_ARTICU
LEFT JOIN
    GVA16
    ON 1 = 1
LEFT JOIN
    TGANUM
    ON 1 = 1
LEFT JOIN
    STA12
    ON STA12.Cod_Articu = STA11.Cod_Articu
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
WHERE
    STA11.Stock = 1 AND STA11.PERFIL <> 'N'
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, gva16.cotiz, TGANUM.IMPORTES, TGANUM.UNIDADES, TGANUM.PRECIOS

GO

-- Vista: STA11_RENTABILIDAD_REPOSICION
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, CASE WHEN ISNULL(PROMO.COD_PROMOCION, '') = '' THEN 'No' ELSE 'Si' END AS EN_PROMOCION, PROMO.DESC_TIPO_PROMOCION AS DESC_TIPO_PROMOCION, PROMO.COD_PROMOCION AS COD_PROMOCION, PROMO.DESC_PROMOCION AS DESC_PROMOCION, PROMO.DESC_PROMOCION_DETALLADA AS DESC_PROMOCION_DETALLADA, dentrodekit AS dentrodekit, SUM(ISNULL(ROUND(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * 0.0000 ELSE (PrecioNet * 0.0000) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / 0.0000 ELSE (PrecioNet / 0.0000) END END) END), (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN TGANUM.IMPORTES ELSE TGANUM.UNIDADES END)), 0)) AS MONTO_VENDIDO, SUM(ISNULL(CantidadVendida, 0)) AS CANTIDAD_VENDIDA, SUM(ISNULL(ROUND(CostoVenta, (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN TGANUM.IMPORTES ELSE TGANUM.UNIDADES END)), 0)) AS COSTO_DE_VENTA, SUM(ISNULL(ROUND(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * 0.0000 ELSE (PrecioNet * 0.0000) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / 0.0000 ELSE (PrecioNet / 0.0000) END END) END), (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN TGANUM.IMPORTES ELSE TGANUM.UNIDADES END)), 0)) - SUM(ISNULL(ROUND(CostoVenta, (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN TGANUM.IMPORTES ELSE TGANUM.UNIDADES END)), 0)) AS DIFERENCIA, SUM(ISNULL(CostoVenta, 0)) / CASE SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * 0.0000 ELSE (PrecioNet * 0.0000) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / 0.0000 ELSE (PrecioNet / 0.0000) END END) END), 1)) WHEN 0 THEN 1 ELSE SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * 0.0000 ELSE (PrecioNet * 0.0000) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / 0.0000 ELSE (PrecioNet / 0.0000) END END) END), 1)) END AS COSTO_POR_VENTA, ROUND((CASE WHEN SUM(CostoVenta) > 0 THEN (SUM(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * 0.0000 ELSE (PrecioNet * 0.0000) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / 0.0000 ELSE (PrecioNet / 0.0000) END END) END)) - SUM(CostoVenta)) / CASE (SUM(CostoVenta)) WHEN 0 THEN 1 ELSE (SUM(CostoVenta)) END ELSE 0 END * 100), ISNULL((SELECT IMPORTES
FROM
    TGANUM), 2)) AS RENTABILIDAD
FROM
    STA11
LEFT JOIN
    tganum
    ON 1 = 1
LEFT JOIN
    (SELECT gva53.fecha_mov, gva12.t_comp, gva12.n_comp, gva53.n_rengl_v, gva15.tipo_comp, gva53.cod_articu, CASE gva53.rengl_padr WHEN 0 THEN 'No' ELSE 'Si' END AS dentrodekit, CASE WHEN gva12.t_comp <> 'FAC' AND gva15.tipo_comp = 'C' THEN (-1) ELSE (1) END AS [EsCredito], gva53.cantidad AS [Cantidad], gva12.mon_cte AS [MonCte], gva53.imp_neto_p AS [ImpNetoP], gva53.precio_net AS [PrecioNet], CASE WHEN gva15.afecta_sto = 'N' THEN 0 WHEN gva12.t_comp <> 'FAC' AND gva15.tipo_comp = 'C' THEN (-1) ELSE (1) END * gva53.cantidad AS cantidadvendida, CASE WHEN gva15.afecta_sto = 'N' THEN 0 WHEN gva12.t_comp <> 'FAC' AND gva15.tipo_comp = 'C' THEN (-1) ELSE (1) END * gva53.cantidad * ROUND(ISNULL((SELECT TOP 1 (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE WHEN mon_cte = 1 THEN precio_rep ELSE precio_rep * (CASE WHEN 0.0000 > 0 THEN 0.0000 ELSE gva12.cotiz END) END) ELSE (CASE WHEN mon_cte = 0 THEN precio_rep ELSE precio_rep / (CASE WHEN 0.0000 > 0 THEN 0.0000 ELSE gva12.cotiz END) END) END) AS precio
FROM
    sta12
WHERE
    sta12.cod_articu = gva53.cod_articu), 0), ISNULL(tganum.unidades, 3)) AS costoventa
FROM
    gva53
LEFT JOIN
    tganum
    ON 1 = 1
INNER JOIN
    gva12
    ON gva12.t_comp = gva53.t_comp AND gva12.n_comp = gva53.n_comp
INNER JOIN
    gva15
    ON gva15.ident_comp = gva12.t_comp
WHERE
    (gva53.promocion = 0)) AS tmp
    ON tmp.cod_articu = sta11.cod_articu
LEFT JOIN
    (SELECT cod_articu, descripcio
FROM
    sta11
WHERE
    usa_esc = 'B') AS base
    ON (base.cod_articu = sta11.base)
LEFT JOIN
    (SELECT T_COMP, N_COMP, N_RENGL_V, DESC_TIPO_PROMOCION, COD_PROMOCION, DESC_PROMOCION, DESC_PROMOCION_DETALLADA
FROM
    RENGLON_FACTURA_PROMOCION) AS PROMO
    ON TMP.T_COMP = PROMO.T_COMP AND TMP.N_COMP = PROMO.N_COMP AND TMP.N_RENGL_V = PROMO.N_RENGL_V
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, CASE WHEN ISNULL(PROMO.COD_PROMOCION, '') = '' THEN 'No' ELSE 'Si' END, PROMO.DESC_TIPO_PROMOCION, PROMO.COD_PROMOCION, PROMO.DESC_PROMOCION, PROMO.DESC_PROMOCION_DETALLADA, dentrodekit

GO

-- Vista: STA11_RENTABILIDAD_ULTIMA_COMPRA
SELECT STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, CASE WHEN ISNULL(PROMO.COD_PROMOCION, '') = '' THEN 'No' ELSE 'Si' END AS EN_PROMOCION, PROMO.DESC_TIPO_PROMOCION AS DESC_TIPO_PROMOCION, PROMO.COD_PROMOCION AS COD_PROMOCION, PROMO.DESC_PROMOCION AS DESC_PROMOCION, PROMO.DESC_PROMOCION_DETALLADA AS DESC_PROMOCION_DETALLADA, dentrodekit AS dentrodekit, SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * tmp.cotiz ELSE (PrecioNet * tmp.cotiz) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / tmp.cotiz ELSE (PrecioNet / tmp.cotiz) END END) END), 0)) AS MONTO_VENDIDO, SUM(ISNULL(CantidadVendida, 0)) AS CANTIDAD_VENDIDA, SUM(ISNULL(CostoVenta, 0)) AS COSTO_DE_VENTA, SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * tmp.cotiz ELSE (PrecioNet * tmp.cotiz) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / tmp.cotiz ELSE (PrecioNet / tmp.cotiz) END END) END), 0)) - SUM(ISNULL(CostoVenta, 0)) AS DIFERENCIA, CASE SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * tmp.cotiz ELSE (PrecioNet * tmp.cotiz) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / tmp.cotiz ELSE (PrecioNet / tmp.cotiz) END END) END), 0)) WHEN 0 THEN 0 ELSE (SUM(ISNULL(CostoVenta, 0)) / SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * tmp.cotiz ELSE (PrecioNet * tmp.cotiz) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / tmp.cotiz ELSE (PrecioNet / tmp.cotiz) END END) END), 1))) END AS COSTO_POR_VENTA, CASE SUM(ISNULL(CostoVenta, 0)) WHEN 0 THEN 0 ELSE (SUM(ISNULL(EsCredito * (CASE WHEN 'NO' = 'SI' THEN 1 ELSE Cantidad END) * (CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN (CASE MonCte WHEN 1 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP * tmp.cotiz ELSE (PrecioNet * tmp.cotiz) END END) ELSE (CASE MonCte WHEN 0 THEN CASE WHEN 'NO' = 'SI' THEN ImpNetoP ELSE PrecioNet END ELSE CASE WHEN 'NO' = 'SI' THEN ImpNetoP / tmp.cotiz ELSE (PrecioNet / tmp.cotiz) END END) END), 0)) - SUM(ISNULL(CostoVenta, 0))) / SUM(ISNULL(CostoVenta, 0)) END * 100 AS RENTABILIDAD
FROM
    sta11
LEFT JOIN
    (SELECT gva53.fecha_mov, gva12.t_comp, gva12.n_comp, gva12.cotiz AS cotiz, gva53.n_rengl_v, gva15.tipo_comp, gva53.cod_articu, CASE gva53.rengl_padr WHEN 0 THEN 'No' ELSE 'Si' END AS dentrodekit, CASE WHEN gva12.t_comp <> 'FAC' AND gva15.tipo_comp = 'C' THEN (-1) ELSE (1) END AS [EsCredito], gva53.cantidad AS [Cantidad], gva12.mon_cte AS [MonCte], gva53.imp_neto_p AS [ImpNetoP], gva53.precio_net AS [PrecioNet], CASE WHEN gva15.afecta_sto = 'N' THEN 0 WHEN gva12.t_comp <> 'FAC' AND gva15.tipo_comp = 'C' THEN (-1) ELSE (1) END * gva53.cantidad AS cantidadvendida, CASE WHEN GVA15.Afecta_sto = 'N' THEN 0 WHEN Gva12.T_Comp <> 'FAC' AND GVA15.Tipo_Comp = 'C' THEN (-1) ELSE (1) END * GVA53.Cantidad * CASE WHEN 'BIMONCTE' = 'BIMONCTE' THEN Gva53.Prec_Ulc_L ELSE Gva53.Prec_Ulc_E END AS CostoVenta
FROM
    gva53
LEFT JOIN
    tganum
    ON 1 = 1
INNER JOIN
    gva12
    ON gva12.t_comp = gva53.t_comp AND gva12.n_comp = gva53.n_comp
INNER JOIN
    gva15
    ON gva15.ident_comp = gva12.t_comp
WHERE
    (gva53.promocion = 0)) AS tmp
    ON tmp.cod_articu = sta11.cod_articu
LEFT JOIN
    (SELECT cod_articu, descripcio
FROM
    sta11
WHERE
    usa_esc = 'B') AS base
    ON (base.cod_articu = sta11.base)
LEFT JOIN
    (SELECT T_COMP, N_COMP, N_RENGL_V, DESC_TIPO_PROMOCION, COD_PROMOCION, DESC_PROMOCION, DESC_PROMOCION_DETALLADA
FROM
    RENGLON_FACTURA_PROMOCION) AS PROMO
    ON TMP.T_COMP = PROMO.T_COMP AND TMP.N_COMP = PROMO.N_COMP AND TMP.N_RENGL_V = PROMO.N_RENGL_V
GROUP BY
    STA11.COD_ARTICU, STA11.DESCRIPCIO, CASE WHEN ISNULL(PROMO.COD_PROMOCION, '') = '' THEN 'No' ELSE 'Si' END, PROMO.DESC_TIPO_PROMOCION, PROMO.COD_PROMOCION, PROMO.DESC_PROMOCION, PROMO.DESC_PROMOCION_DETALLADA, dentrodekit

GO

-- Vista: CPA35_ORDENES_COMPRAS
SELECT CPA35.COD_PROVEE, STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(CPA36.CAN_PEDIDA) AS CAN_PEDIDA, (CASE WHEN cpa35.mon_cte = 1 THEN SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END)) ELSE SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END) * cpa35.cotiz) END) AS TOTAL, CASE CPA35.MON_CTE WHEN 1 THEN 'CORRIENTE' ELSE 'EXTRANJERA' END AS MON_CTE, YEAR(CPA35.FEC_GENER) AS ANO, CASE WHEN MONTH(CPA35.FEC_GENER) = '1' THEN '01 Enero' WHEN MONTH(CPA35.FEC_GENER) = '2' THEN '02 Febrero' WHEN MONTH(CPA35.FEC_GENER) = '3' THEN '03 Marzo' WHEN MONTH(CPA35.FEC_GENER) = '4' THEN '04 Abril' WHEN MONTH(CPA35.FEC_GENER) = '5' THEN '05 Mayo' WHEN MONTH(CPA35.FEC_GENER) = '6' THEN '06 Junio' WHEN MONTH(CPA35.FEC_GENER) = '7' THEN '07 Julio' WHEN MONTH(CPA35.FEC_GENER) = '8' THEN '08 Agosto' WHEN MONTH(CPA35.FEC_GENER) = '9' THEN '09 Septiembre' WHEN MONTH(CPA35.FEC_GENER) = '10' THEN '10 Octubre' WHEN MONTH(CPA35.FEC_GENER) = '11' THEN '11 Noviembre' WHEN MONTH(CPA35.FEC_GENER) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA35.FEC_GENER) AS DIA
FROM
    CPA35
INNER JOIN
    CPA36
    ON CPA36.N_ORDEN_CO = CPA35.N_ORDEN_CO AND CPA36.COD_ARTICU <> ''
INNER JOIN
    STA11
    ON CPA36.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA35.COD_PROVEE
LEFT JOIN
    (SELECT DISTINCT COD_CONDIC, DESC_CONDI
FROM
    CPA49) AS COND
    ON COND.COD_CONDIC = CPA35.COND_COMPR
LEFT JOIN
    CPA50
    ON CPA50.COD_COMPRA = CPA35.COD_COMPRA
INNER JOIN
    CPA56
    ON CPA35.TALONARIO = CPA56.TALONARIO
LEFT JOIN
    CPA43
    ON CPA43.COD_LISTA = CPA35.COD_LISTA
LEFT JOIN
    CPA57
    ON CPA57.COD_PROVIN = CPA01.PROVINCIA
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    GVA81
    ON CPA35.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    GVA81 RENGLONES
    ON CPA36.COD_CLASIF = RENGLONES.COD_CLASIF
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = CPA36.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = CPA36.ID_MEDIDA_STOCK_2
LEFT JOIN
    CPA41
    ON cpa36.N_ORDEN_CO = cpa41.N_ORDEN_CO AND cpa36.N_RENGL_OC = cpa41.N_RENGL_OC
GROUP BY
    CPA35.COD_PROVEE, STA11.COD_ARTICU, STA11.DESCRIPCIO, CPA35.MON_CTE, CPA35.FEC_GENER

GO

-- Vista: CPA35_ORDENES_CORRIENTE_COMPRAS
SELECT CPA35.COD_PROVEE, STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(CPA36.CAN_PEDIDA) AS CAN_PEDIDA, (CASE WHEN cpa35.mon_cte = 1 THEN SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END)) ELSE SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END) * cpa35.cotiz) END) AS TOTAL, CASE CPA35.MON_CTE WHEN 1 THEN 'CORRIENTE' ELSE 'EXTRANJERA' END AS MON_CTE, YEAR(CPA35.FEC_GENER) AS ANO, CASE WHEN MONTH(CPA35.FEC_GENER) = '1' THEN '01 Enero' WHEN MONTH(CPA35.FEC_GENER) = '2' THEN '02 Febrero' WHEN MONTH(CPA35.FEC_GENER) = '3' THEN '03 Marzo' WHEN MONTH(CPA35.FEC_GENER) = '4' THEN '04 Abril' WHEN MONTH(CPA35.FEC_GENER) = '5' THEN '05 Mayo' WHEN MONTH(CPA35.FEC_GENER) = '6' THEN '06 Junio' WHEN MONTH(CPA35.FEC_GENER) = '7' THEN '07 Julio' WHEN MONTH(CPA35.FEC_GENER) = '8' THEN '08 Agosto' WHEN MONTH(CPA35.FEC_GENER) = '9' THEN '09 Septiembre' WHEN MONTH(CPA35.FEC_GENER) = '10' THEN '10 Octubre' WHEN MONTH(CPA35.FEC_GENER) = '11' THEN '11 Noviembre' WHEN MONTH(CPA35.FEC_GENER) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA35.FEC_GENER) AS DIA
FROM
    CPA35
INNER JOIN
    CPA36
    ON CPA36.N_ORDEN_CO = CPA35.N_ORDEN_CO AND CPA36.COD_ARTICU <> ''
INNER JOIN
    STA11
    ON CPA36.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA35.COD_PROVEE
LEFT JOIN
    (SELECT DISTINCT COD_CONDIC, DESC_CONDI
FROM
    CPA49) AS COND
    ON COND.COD_CONDIC = CPA35.COND_COMPR
LEFT JOIN
    CPA50
    ON CPA50.COD_COMPRA = CPA35.COD_COMPRA
INNER JOIN
    CPA56
    ON CPA35.TALONARIO = CPA56.TALONARIO
LEFT JOIN
    CPA43
    ON CPA43.COD_LISTA = CPA35.COD_LISTA
LEFT JOIN
    CPA57
    ON CPA57.COD_PROVIN = CPA01.PROVINCIA
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    GVA81
    ON CPA35.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    GVA81 RENGLONES
    ON CPA36.COD_CLASIF = RENGLONES.COD_CLASIF
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = CPA36.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = CPA36.ID_MEDIDA_STOCK_2
LEFT JOIN
    CPA41
    ON cpa36.N_ORDEN_CO = cpa41.N_ORDEN_CO AND cpa36.N_RENGL_OC = cpa41.N_RENGL_OC
WHERE
    YEAR(CPA35.FEC_GENER) >= YEAR(GETDATE())
GROUP BY
    CPA35.COD_PROVEE, STA11.COD_ARTICU, STA11.DESCRIPCIO, CPA35.MON_CTE, CPA35.FEC_GENER

GO

-- Vista: CPA35_ORDENES_PENDIENTES_AUTORIZAR
SELECT CPA35.TALONARIO AS TALONARIO, CPA35.N_ORDEN_CO AS N_ORDEN_CO, CPA35.COD_PROVEE AS COD_PROVEE, NOM_PROVEE AS NOM_PROVEE, CPA01.PROVINCIA AS PROVINCIA, CPA57.NOM_PROVIN AS NOM_PROVIN, CPA108.COD_PAIS AS COD_PAIS, NOM_PAIS AS NOM_PAIS, CPA35.COND_COMPR AS COND_COMPR, COND.DESC_CONDI AS DESC_CONDI, CPA35.COD_COMPRA AS COD_COMPRA, CPA50.NOM_COMPRA AS NOM_COMPRA, TOTALES.TOTAL AS TOTAL, YEAR(CPA35.FEC_GENER) AS ANO, CASE WHEN MONTH(CPA35.FEC_GENER) = '1' THEN '01 Enero' WHEN MONTH(CPA35.FEC_GENER) = '2' THEN '02 Febrero' WHEN MONTH(CPA35.FEC_GENER) = '3' THEN '03 Marzo' WHEN MONTH(CPA35.FEC_GENER) = '4' THEN '04 Abril' WHEN MONTH(CPA35.FEC_GENER) = '5' THEN '05 Mayo' WHEN MONTH(CPA35.FEC_GENER) = '6' THEN '06 Junio' WHEN MONTH(CPA35.FEC_GENER) = '7' THEN '07 Julio' WHEN MONTH(CPA35.FEC_GENER) = '8' THEN '08 Agosto' WHEN MONTH(CPA35.FEC_GENER) = '9' THEN '09 Septiembre' WHEN MONTH(CPA35.FEC_GENER) = '10' THEN '10 Octubre' WHEN MONTH(CPA35.FEC_GENER) = '11' THEN '11 Noviembre' WHEN MONTH(CPA35.FEC_GENER) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA35.FEC_GENER) AS DIA
FROM
    CPA35
INNER JOIN
    CPA56
    ON CPA35.TALONARIO = CPA56.TALONARIO
INNER JOIN
    (SELECT CPA35.N_ORDEN_CO, SUM(CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN CPA36.CAN_PEDIDA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN CPA36.CAN_PEDIDA_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN CPA36.CAN_PEDIDA_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN CPA36.CAN_PEDIDA / CPA36.CAN_EQUIVA END * (CASE CPA35.MON_CTE WHEN 1 THEN CPA36.PRECIO ELSE (CPA36.PRECIO * CASE WHEN cpa35.cotiz = 0 THEN 1 ELSE cpa35.cotiz END) END)) + (CASE WHEN CPA35.MON_CTE = 1 THEN TOTAL_IVA ELSE TOTAL_IVA * CASE WHEN cpa35.cotiz = 0 THEN 1 ELSE cpa35.cotiz END END) + (CASE WHEN CPA35.MON_CTE = 1 THEN TOTAL_II ELSE TOTAL_II * CASE WHEN cpa35.cotiz = 0 THEN 1 ELSE cpa35.cotiz END END) - (CASE WHEN CPA35.MON_CTE = 1 THEN TOTAL_BONI ELSE TOTAL_BONI * CASE WHEN cpa35.cotiz = 0 THEN 1 ELSE cpa35.cotiz END END) AS [TOTAL]
FROM
    CPA35
INNER JOIN
    CPA36
    ON CPA36.N_ORDEN_CO = CPA35.N_ORDEN_CO
INNER JOIN
    STA11
    ON STA11.COD_ARTICU = CPA36.COD_ARTICU
WHERE
    CPA35.N_ORDEN_CO = CPA36.N_ORDEN_CO
GROUP BY
    CPA35.N_ORDEN_CO, CPA35.MON_CTE, CPA35.TOTAL_IVA, CPA35.COTIZ, CPA35.TOTAL_II, CPA35.TOTAL_BONI) AS TOTALES
    ON CPA35.N_ORDEN_CO = totales.N_ORDEN_CO
INNER JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA35.COD_PROVEE
INNER JOIN
    CPA57
    ON CPA01.PROVINCIA = CPA57.COD_PROVIN
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
LEFT JOIN
    (SELECT DISTINCT COD_CONDIC, DESC_CONDI
FROM
    CPA49) AS COND
    ON COND.COD_CONDIC = CPA35.COND_COMPR
LEFT JOIN
    CPA50
    ON CPA50.COD_COMPRA = CPA35.COD_COMPRA
LEFT JOIN
    GVA81
    ON CPA35.COD_CLASIF = GVA81.COD_CLASIF
WHERE
    CPA35.ESTADO IN ('1', '9')
GROUP BY
    CPA35.TALONARIO, CPA35.N_ORDEN_CO, CPA35.FEC_GENER, CPA35.COD_PROVEE, NOM_PROVEE, CPA01.PROVINCIA, CPA57.NOM_PROVIN, CPA108.COD_PAIS, NOM_PAIS, CPA35.COND_COMPR, COND.DESC_CONDI, CPA35.COD_COMPRA, CPA50.NOM_COMPRA, TOTALES.TOTAL

GO

-- Vista: CPA35_ORDENES_DETALLE_COMPRAS
SELECT CPA35.N_ORDEN_CO AS N_ORDEN_CO, CASE CPA35.FEC_EMISIO WHEN '1800-01-01' THEN NULL ELSE CPA35.FEC_EMISIO END AS FEC_EMISIO, CPA35.COD_PROVEE AS COD_PROVEE, ISNULL(CPA01.NOM_PROVEE, 'OCASIONAL') AS NOM_PROVEE, CPA50.NOM_COMPRA AS NOM_COMPRA, CPA50.COD_COMPRA AS COD_COMPRA, STA11.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, YEAR(CPA35.FEC_EMISIO) AS ANO, CASE WHEN MONTH(CPA35.FEC_EMISIO) = '1' THEN '01 Enero' WHEN MONTH(CPA35.FEC_EMISIO) = '2' THEN '02 Febrero' WHEN MONTH(CPA35.FEC_EMISIO) = '3' THEN '03 Marzo' WHEN MONTH(CPA35.FEC_EMISIO) = '4' THEN '04 Abril' WHEN MONTH(CPA35.FEC_EMISIO) = '5' THEN '05 Mayo' WHEN MONTH(CPA35.FEC_EMISIO) = '6' THEN '06 Junio' WHEN MONTH(CPA35.FEC_EMISIO) = '7' THEN '07 Julio' WHEN MONTH(CPA35.FEC_EMISIO) = '8' THEN '08 Agosto' WHEN MONTH(CPA35.FEC_EMISIO) = '9' THEN '09 Septiembre' WHEN MONTH(CPA35.FEC_EMISIO) = '10' THEN '10 Octubre' WHEN MONTH(CPA35.FEC_EMISIO) = '11' THEN '11 Noviembre' WHEN MONTH(CPA35.FEC_EMISIO) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA35.FEC_EMISIO) AS DIA, CPA36.CAN_PEDIDA AS CAN_PEDIDA, (CASE WHEN cpa35.mon_cte = 1 THEN SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END)) ELSE SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END) * cpa35.cotiz) END) AS TOTAL_RENGLON, TOTAL.total + (CASE WHEN CPA35.MON_CTE = 1 THEN CPA35.TOTAL_IVA ELSE CPA35.TOTAL_IVA * CPA35.COTIZ END) + (CASE WHEN CPA35.MON_CTE = 1 THEN CPA35.TOTAL_II ELSE CPA35.TOTAL_II * CPA35.COTIZ END) - (CASE WHEN CPA35.MON_CTE = 1 THEN CPA35.TOTAL_BONI ELSE CPA35.TOTAL_BONI * CPA35.COTIZ END) AS TOTAL, CASE CPA35.MON_CTE WHEN 1 THEN 'CORRIENTE' ELSE 'EXTRANJERA' END AS MON_CTE
FROM
    CPA35
INNER JOIN
    CPA36
    ON CPA36.N_ORDEN_CO = CPA35.N_ORDEN_CO
INNER JOIN
    STA11
    ON CPA36.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA35.COD_PROVEE
LEFT JOIN
    (SELECT DISTINCT CPA49.COD_CONDIC, CPA49.DESC_CONDI
FROM
    CPA49) AS COND
    ON COND.COD_CONDIC = CPA35.COND_COMPR
LEFT JOIN
    CPA50
    ON CPA50.COD_COMPRA = CPA35.COD_COMPRA
INNER JOIN
    CPA56
    ON CPA35.TALONARIO = CPA56.TALONARIO
LEFT JOIN
    CPA43
    ON CPA43.COD_LISTA = CPA35.COD_LISTA
LEFT JOIN
    CPA57
    ON CPA57.COD_PROVIN = CPA01.PROVINCIA
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART WITH (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, STA16.LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART WITH (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, STA16.LONG_FAM_A + STA16.LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    GVA81
    ON CPA35.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    GVA81 RENGLONES
    ON CPA36.COD_CLASIF = RENGLONES.COD_CLASIF
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = CPA36.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = CPA36.ID_MEDIDA_STOCK_2
LEFT JOIN
    (SELECT (CASE WHEN cpa35.mon_cte = 1 THEN (SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END))) ELSE (SUM(cpa36.can_pedida * (CASE WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'P' THEN PRECIO WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'S' THEN PRECIO / sta11.EQUIVALENCIA_STOCK_2 WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 1 THEN PRECIO / STA11.EQUIVALENCIA_STOCK_2 / CPA36.CAN_EQUIVA WHEN CPA36.UNIDAD_MEDIDA_SELECCIONADA = 'C' AND STA11.LLEVA_DOBLE_UNIDAD_MEDIDA = 0 THEN PRECIO / CPA36.CAN_EQUIVA END) * cpa35.cotiz)) END) AS TOTAL, CPA35.TOTAL_IVA, CPA35.TOTAL_II, CPA35.TOTAL_BONI, CPA35.N_ORDEN_CO
FROM
    CPA35
INNER JOIN
    CPA36
    ON CPA35.N_ORDEN_CO = CPA36.N_ORDEN_CO
INNER JOIN
    STA11
    ON sta11.COD_ARTICU = cpa36.COD_ARTICU
GROUP BY
    CPA35.N_ORDEN_CO, CPA35.TOTAL_IVA, CPA35.MON_CTE, CPA35.COTIZ, CPA35.TOTAL_BONI, CPA35.TOTAL_II) AS TOTAL
    ON TOTAL.N_ORDEN_CO = CPA35.N_ORDEN_CO
GROUP BY
    CPA35.N_ORDEN_CO, CASE CPA35.FEC_EMISIO WHEN '1800-01-01' THEN NULL ELSE CPA35.FEC_EMISIO END, CPA35.COD_PROVEE, CPA35.FEC_EMISIO, ISNULL(CPA01.NOM_PROVEE, 'OCASIONAL'), CPA50.NOM_COMPRA, CPA50.COD_COMPRA, STA11.COD_ARTICU, STA11.DESCRIPCIO, TOTAL.total + (CASE WHEN CPA35.MON_CTE = 1 THEN CPA35.TOTAL_IVA ELSE CPA35.TOTAL_IVA * CPA35.COTIZ END) + (CASE WHEN CPA35.MON_CTE = 1 THEN CPA35.TOTAL_II ELSE CPA35.TOTAL_II * CPA35.COTIZ END) - (CASE WHEN CPA35.MON_CTE = 1 THEN CPA35.TOTAL_BONI ELSE CPA35.TOTAL_BONI * CPA35.COTIZ END), CPA35.MON_CTE, CPA36.CAN_PEDIDA

GO

-- Vista: CPA04_RANKING_COMPRAS
SELECT CPA01.COD_PROVEE AS COD_PROVEE, CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN SUM(CASE WHEN CPA04.COTIZACION = 0 THEN 0 ELSE (CPA04.IMPORTE_NE + CPA04.Importe_EX) * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END END) WHEN 'BICOTIZ' THEN SUM(CASE WHEN 1 = 0 THEN 0 ELSE (CPA04.IMPORTE_NE + CPA04.Importe_EX) * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END / 1 END) WHEN 'BIORIGEN' THEN SUM(CASE WHEN CPA04.COTIZACION = 0 THEN 0 ELSE (CPA04.IMPORTE_NE + CPA04.Importe_EX) * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END * CASE CPA04.MON_CTE WHEN 1 THEN 1 / CPA04.COTIZACION ELSE 1 END END) END AS TOTAL_NETO, CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN SUM(Importe_To * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END) WHEN 'BICOTIZ' THEN SUM(CASE WHEN 1 = 0 THEN 0 ELSE Importe_To * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END / 1 END) WHEN 'BIORIGEN' THEN SUM(Unidades * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END) END AS TOTAL, YEAR(CPA04.fecha_cont) AS ANO, CASE WHEN MONTH(CPA04.fecha_cont) = '1' THEN '01 Enero' WHEN MONTH(CPA04.fecha_cont) = '2' THEN '02 Febrero' WHEN MONTH(CPA04.fecha_cont) = '3' THEN '03 Marzo' WHEN MONTH(CPA04.fecha_cont) = '4' THEN '04 Abril' WHEN MONTH(CPA04.fecha_cont) = '5' THEN '05 Mayo' WHEN MONTH(CPA04.fecha_cont) = '6' THEN '06 Junio' WHEN MONTH(CPA04.fecha_cont) = '7' THEN '07 Julio' WHEN MONTH(CPA04.fecha_cont) = '8' THEN '08 Agosto' WHEN MONTH(CPA04.fecha_cont) = '9' THEN '09 Septiembre' WHEN MONTH(CPA04.fecha_cont) = '10' THEN '10 Octubre' WHEN MONTH(CPA04.fecha_cont) = '11' THEN '11 Noviembre' WHEN MONTH(CPA04.fecha_cont) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA04.fecha_cont) AS DIA
FROM
    CPA04
LEFT JOIN
    CPA01
    ON (CPA01.COD_PROVEE = CPA04.COD_PROVEE)
LEFT JOIN
    CPA21
    ON (CPA21.T_Comp = CPA04.T_Comp)
LEFT JOIN
    CPA57
    ON (CPA01.PROVINCIA = CPA57.COD_PROVIN)
LEFT JOIN
    CPA108
    ON (CPA57.COD_PAIS = CPA108.COD_PAIS)
WHERE
    Estado <> 'ANU' AND (CPA04.TComp_In_C <> 'OP') AND (CPA04.Tipo_Asien <> '**') AND (cpa21.rank_valor = 1)
GROUP BY
    CPA01.COD_PROVEE, CPA04.FECHA_CONT, ISNULL(NOM_PROVEE, 'OCASIONAL')

GO

-- Vista: CPA04_RANKING_COMPRAS_CORRIENTE
SELECT CPA01.COD_PROVEE AS COD_PROVEE, CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN SUM(CASE WHEN CPA04.COTIZACION = 0 THEN 0 ELSE (CPA04.IMPORTE_NE + CPA04.Importe_EX) * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END END) WHEN 'BICOTIZ' THEN SUM(CASE WHEN 1 = 0 THEN 0 ELSE (CPA04.IMPORTE_NE + CPA04.Importe_EX) * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END / 1 END) WHEN 'BIORIGEN' THEN SUM(CASE WHEN CPA04.COTIZACION = 0 THEN 0 ELSE (CPA04.IMPORTE_NE + CPA04.Importe_EX) * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END * CASE CPA04.MON_CTE WHEN 1 THEN 1 / CPA04.COTIZACION ELSE 1 END END) END AS TOTAL_NETO, CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN SUM(Importe_To * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END) WHEN 'BICOTIZ' THEN SUM(CASE WHEN 1 = 0 THEN 0 ELSE Importe_To * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END / 1 END) WHEN 'BIORIGEN' THEN SUM(Unidades * CASE WHEN CRE_DEB = 'C' THEN (-1) ELSE 1 END) END AS TOTAL, YEAR(CPA04.fecha_cont) AS ANO, CASE WHEN MONTH(CPA04.fecha_cont) = '1' THEN '01 Enero' WHEN MONTH(CPA04.fecha_cont) = '2' THEN '02 Febrero' WHEN MONTH(CPA04.fecha_cont) = '3' THEN '03 Marzo' WHEN MONTH(CPA04.fecha_cont) = '4' THEN '04 Abril' WHEN MONTH(CPA04.fecha_cont) = '5' THEN '05 Mayo' WHEN MONTH(CPA04.fecha_cont) = '6' THEN '06 Junio' WHEN MONTH(CPA04.fecha_cont) = '7' THEN '07 Julio' WHEN MONTH(CPA04.fecha_cont) = '8' THEN '08 Agosto' WHEN MONTH(CPA04.fecha_cont) = '9' THEN '09 Septiembre' WHEN MONTH(CPA04.fecha_cont) = '10' THEN '10 Octubre' WHEN MONTH(CPA04.fecha_cont) = '11' THEN '11 Noviembre' WHEN MONTH(CPA04.fecha_cont) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA04.fecha_cont) AS DIA
FROM
    CPA04
LEFT JOIN
    CPA01
    ON (CPA01.COD_PROVEE = CPA04.COD_PROVEE)
LEFT JOIN
    CPA21
    ON (CPA21.T_Comp = CPA04.T_Comp)
LEFT JOIN
    CPA57
    ON (CPA01.PROVINCIA = CPA57.COD_PROVIN)
LEFT JOIN
    CPA108
    ON (CPA57.COD_PAIS = CPA108.COD_PAIS)
WHERE
    Estado <> 'ANU' AND (CPA04.TComp_In_C <> 'OP') AND (CPA04.Tipo_Asien <> '**') AND (cpa21.rank_valor = 1) AND (YEAR(Cpa04.fecha_cont) >= YEAR(GETDATE()))
GROUP BY
    CPA01.COD_PROVEE, CPA04.FECHA_CONT, ISNULL(NOM_PROVEE, 'OCASIONAL')

GO

-- Vista: STA11_RANKING_ARTICULOS_STOCK
SELECT CPA46.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(CASE CPA04.TComp_In_C WHEN 'CP' THEN -Cpa46.Cantidad ELSE Cpa46.Cantidad END) AS CANTIDAD, SUM(CASE CPA04.TComp_In_C WHEN 'CP' THEN -Cpa46.Cantidad ELSE Cpa46.Cantidad END * (CASE CPA04.MON_CTE WHEN 1 THEN Cpa46.Precio_Net ELSE Cpa46.Precio_Net * CPA04.COTIZACION END)) AS TOTAL, YEAR(CPA04.fecha_cont) AS ANO, CASE WHEN MONTH(CPA04.fecha_cont) = '1' THEN '01 Enero' WHEN MONTH(CPA04.fecha_cont) = '2' THEN '02 Febrero' WHEN MONTH(CPA04.fecha_cont) = '3' THEN '03 Marzo' WHEN MONTH(CPA04.fecha_cont) = '4' THEN '04 Abril' WHEN MONTH(CPA04.fecha_cont) = '5' THEN '05 Mayo' WHEN MONTH(CPA04.fecha_cont) = '6' THEN '06 Junio' WHEN MONTH(CPA04.fecha_cont) = '7' THEN '07 Julio' WHEN MONTH(CPA04.fecha_cont) = '8' THEN '08 Agosto' WHEN MONTH(CPA04.fecha_cont) = '9' THEN '09 Septiembre' WHEN MONTH(CPA04.fecha_cont) = '10' THEN '10 Octubre' WHEN MONTH(CPA04.fecha_cont) = '11' THEN '11 Noviembre' WHEN MONTH(CPA04.fecha_cont) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA04.fecha_cont) AS DIA
FROM
    STA11
INNER JOIN
    CPA46
    ON CPA46.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    CPA04
    ON Cpa46.TComp_In_C = Cpa04.TComp_In_C AND Cpa46.NComp_In_C = Cpa04.NComp_In_C
INNER JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA04.COD_PROVEE
LEFT JOIN
    CPA21
    ON CPA21.T_Comp = CPA04.T_Comp
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    GVA81
    ON CPA04.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    GVA81 RENGLONES
    ON CPA46.COD_CLASIF = RENGLONES.COD_CLASIF
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = CPA46.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = CPA46.ID_MEDIDA_STOCK_2
LEFT JOIN
    MEDIDA MEDIDA_COMPRA
    ON MEDIDA_COMPRA.ID_MEDIDA = CPA46.ID_MEDIDA_COMPRA
WHERE
    Estado <> 'ANU' AND (CPA04.TComp_In_C <> 'OP') AND (CPA04.Tipo_Asien <> '**') AND CPA21.RANK_CANTI = 1
GROUP BY
    CPA46.COD_ARTICU, STA11.DESCRIPCIO, CPA04.FECHA_CONT
ORDER BY
    TOTAL DESC

GO

-- Vista: STA11_RANKING_ARTICULOS_STOCK_CORRIENTE
SELECT CPA46.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, SUM(CASE CPA04.TComp_In_C WHEN 'CP' THEN -Cpa46.Cantidad ELSE Cpa46.Cantidad END) AS CANTIDAD, SUM(CASE CPA04.TComp_In_C WHEN 'CP' THEN -Cpa46.Cantidad ELSE Cpa46.Cantidad END * (CASE CPA04.MON_CTE WHEN 1 THEN Cpa46.Precio_Net ELSE Cpa46.Precio_Net * CPA04.COTIZACION END)) AS TOTAL, YEAR(CPA04.fecha_cont) AS ANO, CASE WHEN MONTH(CPA04.fecha_cont) = '1' THEN '01 Enero' WHEN MONTH(CPA04.fecha_cont) = '2' THEN '02 Febrero' WHEN MONTH(CPA04.fecha_cont) = '3' THEN '03 Marzo' WHEN MONTH(CPA04.fecha_cont) = '4' THEN '04 Abril' WHEN MONTH(CPA04.fecha_cont) = '5' THEN '05 Mayo' WHEN MONTH(CPA04.fecha_cont) = '6' THEN '06 Junio' WHEN MONTH(CPA04.fecha_cont) = '7' THEN '07 Julio' WHEN MONTH(CPA04.fecha_cont) = '8' THEN '08 Agosto' WHEN MONTH(CPA04.fecha_cont) = '9' THEN '09 Septiembre' WHEN MONTH(CPA04.fecha_cont) = '10' THEN '10 Octubre' WHEN MONTH(CPA04.fecha_cont) = '11' THEN '11 Noviembre' WHEN MONTH(CPA04.fecha_cont) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA04.fecha_cont) AS DIA
FROM
    STA11
INNER JOIN
    CPA46
    ON CPA46.COD_ARTICU = STA11.COD_ARTICU
INNER JOIN
    CPA04
    ON Cpa46.TComp_In_C = Cpa04.TComp_In_C AND Cpa46.NComp_In_C = Cpa04.NComp_In_C
INNER JOIN
    CPA01
    ON CPA01.COD_PROVEE = CPA04.COD_PROVEE
LEFT JOIN
    CPA21
    ON CPA21.T_Comp = CPA04.T_Comp
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
LEFT JOIN
    (SELECT COD_ARTICU, DESCRIPCIO
FROM
    STA11
WHERE
    USA_ESC = 'B') AS BASE
    ON (BASE.COD_ARTICU = STA11.BASE)
LEFT JOIN
    GVA81
    ON CPA04.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    GVA81 RENGLONES
    ON CPA46.COD_CLASIF = RENGLONES.COD_CLASIF
LEFT JOIN
    MEDIDA MEDIDA_STOCK
    ON MEDIDA_STOCK.ID_MEDIDA = CPA46.ID_MEDIDA_STOCK
LEFT JOIN
    MEDIDA MEDIDA_STOCK_2
    ON MEDIDA_STOCK_2.ID_MEDIDA = CPA46.ID_MEDIDA_STOCK_2
LEFT JOIN
    MEDIDA MEDIDA_COMPRA
    ON MEDIDA_COMPRA.ID_MEDIDA = CPA46.ID_MEDIDA_COMPRA
WHERE
    Estado <> 'ANU' AND (CPA04.TComp_In_C <> 'OP') AND (CPA04.Tipo_Asien <> '**') AND CPA21.RANK_CANTI = 1 AND (YEAR(Cpa04.fecha_cont) >= YEAR(GETDATE()))
GROUP BY
    CPA46.COD_ARTICU, STA11.DESCRIPCIO, CPA04.FECHA_CONT
ORDER BY
    TOTAL DESC

GO

-- Vista: CPA04_DETALLE_COMPROBANTES_COMPRAS
SELECT CPA04.FECHA_EMIS AS FECHA_EMIS, CPA04.T_COMP AS T_COMP, CPA04.N_COMP AS N_COMP, COND.DESC_CONDI AS DESC_CONDI, CPA51.DESC_SECTO AS DESC_SECTO, CPA04.COD_PROVEE AS COD_PROVEE, CASE CPA04.COD_PROVEE WHEN '000000' THEN CASE CPA20.RAZON_SOCI WHEN '' THEN 'OCASIONAL' ELSE CPA20.RAZON_SOCI END ELSE CPA01.NOM_PROVEE END AS NOM_PROVEE, CPA57.NOM_PROVIN AS NOM_PROVIN, CPA70.DESC_GASTO AS DESC_GASTO, RENGLONES.COD_ARTICU AS COD_ARTICU, STA11.DESCRIPCIO AS DESCRIPCIO, RENGLONES.COD_CONCEP AS COD_CONCEP, RENGLONES.DESC_CONCE AS DESC_CONCE, YEAR(CPA04.FECHA_EMIS) AS ANO, CASE WHEN MONTH(CPA04.FECHA_EMIS) = '1' THEN '01 Enero' WHEN MONTH(CPA04.FECHA_EMIS) = '2' THEN '02 Febrero' WHEN MONTH(CPA04.FECHA_EMIS) = '3' THEN '03 Marzo' WHEN MONTH(CPA04.FECHA_EMIS) = '4' THEN '04 Abril' WHEN MONTH(CPA04.FECHA_EMIS) = '5' THEN '05 Mayo' WHEN MONTH(CPA04.FECHA_EMIS) = '6' THEN '06 Junio' WHEN MONTH(CPA04.FECHA_EMIS) = '7' THEN '07 Julio' WHEN MONTH(CPA04.FECHA_EMIS) = '8' THEN '08 Agosto' WHEN MONTH(CPA04.FECHA_EMIS) = '9' THEN '09 Septiembre' WHEN MONTH(CPA04.FECHA_EMIS) = '10' THEN '10 Octubre' WHEN MONTH(CPA04.FECHA_EMIS) = '11' THEN '11 Noviembre' WHEN MONTH(CPA04.FECHA_EMIS) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA04.FECHA_EMIS) AS DIA, SUM(CASE RENGLONES.COD_ARTICU WHEN '' THEN 0 ELSE CASE Cpa04.TComp_In_C WHEN 'CP' THEN -RENGLONES.Cantidad ELSE RENGLONES.Cantidad END END) AS CANTIDAD, SUM(CASE 'BIMONCTE' WHEN 'BICOTIZ' THEN (CASE WHEN 1 = 0 THEN 0 ELSE (RENGLONES.Precio_Net) * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END / 1 END) WHEN 'BIMONCTE' THEN ((RENGLONES.Precio_Net) * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END) WHEN 'BIORIGEN' THEN (CASE WHEN CPA04.COTIZACION = 0 THEN 0 ELSE (RENGLONES.Precio_Net) * CASE CPA04.MON_CTE WHEN 1 THEN 1 / CPA04.COTIZACION ELSE 1 END END) END) AS PRECIO_NETO, SUM(CASE Cpa04.TComp_In_C WHEN 'CP' THEN -1 ELSE 1 END * CASE 'BIMONCTE' WHEN 'BICOTIZ' THEN (CASE WHEN 1 = 0 THEN 0 ELSE (RENGLONES.IMP_NETO_P) * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END / 1 END) WHEN 'BIMONCTE' THEN ((RENGLONES.IMP_NETO_P) * CASE CPA04.MON_CTE WHEN 1 THEN 1 ELSE CPA04.COTIZACION END) WHEN 'BIORIGEN' THEN (CASE WHEN CPA04.COTIZACION = 0 THEN 0 ELSE (RENGLONES.IMP_NETO_P) * CASE CPA04.MON_CTE WHEN 1 THEN 1 / CPA04.COTIZACION ELSE 1 END END) END) AS IMPORTE
FROM
    CPA04(NOLOCK)
LEFT JOIN
    (SELECT DISTINCT COD_CONDIC, DESC_CONDI
FROM
    CPA49) AS COND
    ON CPA04.COND_COMPR = COND.COD_CONDIC
LEFT JOIN
    CPA51(NOLOCK)
    ON CPA04.COD_SECTOR = CPA51.COD_SECTOR
LEFT JOIN
    CPA20(NOLOCK)
    ON CPA04.TCOMP_IN_C = CPA20.TCOMP_IN_C AND CPA04.NCOMP_IN_C = CPA20.NCOMP_IN_C
LEFT JOIN
    CPA01(NOLOCK)
    ON CPA04.COD_PROVEE = CPA01.COD_PROVEE
LEFT JOIN
    CPA57(NOLOCK)
    ON CASE WHEN CPA01.PROVINCIA IS NULL THEN CPA20.PROVINCIA ELSE CPA01.PROVINCIA END = CPA57.COD_PROVIN OR CPA20.PROVINCIA = CPA57.COD_PROVIN
LEFT JOIN
    CPA10
    ON 1 = 1
LEFT JOIN
    CPA03 FAMILIA (NOLOCK)
    ON SUBSTRING(CPA04.COD_PROVEE, 1, LONG_FAM_P) = FAMILIA.COD_AGR
LEFT JOIN
    CPA03 GRUPO (NOLOCK)
    ON SUBSTRING(CPA04.COD_PROVEE, 0 + LONG_FAM_P, LONG_GRU_P + 1) = GRUPO.COD_AGR
LEFT JOIN
    CPA70(NOLOCK)
    ON CPA04.COD_GASTO = CPA70.COD_GASTO
INNER JOIN
    (SELECT TCOMP_IN_C, NCOMP_IN_C, N_RENGL_C, COD_DEPOSI, CPA46.COD_ARTICU, '' COD_CONCEP, '' DESC_CONCE, '' IMPUTACION, CANTIDAD, CANTIDAD_2, PRECIO_NET, IMP_NETO_P, PORCE_DCTO, CPA46.COD_CLASIF, GVA81.DESCRIP AS DESCRIP_CLASIF, CPA46.ID_MEDIDA_STOCK, CPA46.ID_MEDIDA_STOCK_2, CN_TANGO, CUENTA.COD_CUENTA
FROM
    CPA46
LEFT JOIN
    GVA81
    ON CPA46.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    ACT_CNA38
    ON 1 = 1
LEFT JOIN
    STA11
    ON CPA46.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    articulo_cuenta
    ON sta11.cod_sta11 = articulo_cuenta.cod_sta11
LEFT JOIN
    cuenta
    ON articulo_cuenta.id_cuenta_compras = cuenta.id_cuenta UNION ALL
SELECT
    TCOMP_IN_C, NCOMP_IN_C, N_RENGL_C, '' COD_DEPOSI, '' COD_ARTICU, CPA47.COD_CONCEP, CPA45.DESC_CONCE, CPA45.IMPUTACION, 1 CANTIDAD, 1 CANTIDAD_2, CASE CPA47.IMPORTE_NE WHEN 0 THEN CPA47.IMPORT_PAN ELSE CPA47.IMPORTE_NE END, CASE CPA47.IMP_NETO_P WHEN 0 THEN CPA47.IMPORT_PAN ELSE CPA47.IMP_NETO_P END, 0 PORCE_DCTO, CPA47.COD_CLASIF, GVA81.DESCRIP AS DESCRIP_CLASIF, NULL, NULL, CN_TANGO, CUENTA.COD_CUENTA
FROM
    CPA47
INNER JOIN
    CPA45
    ON CPA45.COD_CONCEP = CPA47.COD_CONCEP
LEFT JOIN
    GVA81
    ON CPA47.COD_CLASIF = GVA81.COD_CLASIF
LEFT JOIN
    ACT_CNA38
    ON 1 = 1
LEFT JOIN
    CONCEPTO_CP
    ON CPA45.COD_CPA45 = CONCEPTO_CP.COD_CPA45
LEFT JOIN
    CUENTA
    ON CONCEPTO_CP.ID_CUENTA = CUENTA.ID_CUENTA) AS RENGLONES
    ON RENGLONES.TCOMP_IN_C = CPA04.TCOMP_IN_C AND RENGLONES.NCOMP_IN_C = CPA04.NCOMP_IN_C
LEFT JOIN
    STA11(NOLOCK)
    ON RENGLONES.COD_ARTICU = STA11.COD_ARTICU
LEFT JOIN
    STA16
    ON 1 = 1
LEFT JOIN
    STA29 FAMILIA_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 1, LONG_FAM_A) = FAMILIA_ART.COD_AGR
LEFT JOIN
    STA29 GRUPO_ART (NOLOCK)
    ON SUBSTRING(STA11.COD_ARTICU, 0, LONG_FAM_A + LONG_GRU_A + 1) = GRUPO_ART.COD_AGR
WHERE
    (CPA04.Estado <> 'ANU') AND (CPA04.TComp_In_C <> 'OP') AND (CPA04.Tipo_Asien <> '**')
GROUP BY
    CPA04.FECHA_EMIS, CPA04.T_COMP, CPA04.N_COMP, COND.DESC_CONDI, CPA51.DESC_SECTO, CPA04.COD_PROVEE, CASE CPA04.COD_PROVEE WHEN '000000' THEN CASE CPA20.RAZON_SOCI WHEN '' THEN 'OCASIONAL' ELSE CPA20.RAZON_SOCI END ELSE CPA01.NOM_PROVEE END, CPA57.NOM_PROVIN, FAMILIA.NOM_AGR, GRUPO.NOM_AGR, CPA70.DESC_GASTO, RENGLONES.COD_ARTICU, STA11.DESCRIPCIO, FAMILIA_ART.NOM_AGR, GRUPO_ART.NOM_AGR, RENGLONES.COD_CONCEP, RENGLONES.DESC_CONCE

GO

-- Vista: CPA05_RANKING_ACREEDORES_COMPRAS
SELECT 
    CPA01.COD_PROVEE AS COD_PROVEE,
    tmp.ANO,
    tmp.MES,
    tmp.DIA,
    CPA01.NOM_PROVEE AS NOM_PROVEE,
    SUM(tmp.IMPORTETOTAL) AS TOTAL
FROM
(
    SELECT 
        CPA04.COD_PROVEE,
        YEAR(CPA54.FECHA_VTO) AS ANO,
        CASE MONTH(CPA54.FECHA_VTO)
            WHEN 1 THEN '01 Enero'
            WHEN 2 THEN '02 Febrero'
            WHEN 3 THEN '03 Marzo'
            WHEN 4 THEN '04 Abril'
            WHEN 5 THEN '05 Mayo'
            WHEN 6 THEN '06 Junio'
            WHEN 7 THEN '07 Julio'
            WHEN 8 THEN '08 Agosto'
            WHEN 9 THEN '09 Septiembre'
            WHEN 10 THEN '10 Octubre'
            WHEN 11 THEN '11 Noviembre'
            WHEN 12 THEN '12 Diciembre'
        END AS MES,
        DAY(CPA54.FECHA_VTO) AS DIA,
        CPA54.FECHA_VTO,
        CPA54.IMPORT_VTO + ISNULL(
            (
                SELECT 
                    SUM(
                        (CASE 
                            WHEN CPA21.CRE_DEB = 'D' THEN 1
                            WHEN CPA21.CRE_DEB = 'C' THEN -1
                            WHEN CPA05.T_COMP_CAN = 'O/P' THEN -1
                            ELSE 0
                         END) * CPA05.IMPORT_CAN
                    )
                FROM CPA05
                LEFT JOIN CPA21
                    ON CPA21.T_COMP = CPA05.T_COMP_CAN
                WHERE CPA05.COD_PROVEE = CPA54.COD_PROVEE
                  AND CPA05.T_COMP_FAC = CPA54.T_COMP
                  AND CPA05.N_COMP_FAC = CPA54.N_COMP
                  AND CPA05.FECHA_VTO = CPA54.FECHA_VTO
            ), 0
        ) AS IMPORTETOTAL,
        CPA54.IMPORT_VTO,
        CPA54.MON_CTE
    FROM CPA04
    INNER JOIN CPA54
        ON CPA04.COD_PROVEE = CPA54.COD_PROVEE
       AND CPA54.N_COMP = CPA04.N_COMP
       AND CPA54.T_COMP = CPA04.T_COMP
    WHERE CPA04.ESTADO = 'PEN'
      AND CPA54.ESTADO_VTO <> 'PAG'
) AS tmp
INNER JOIN CPA01
    ON CPA01.COD_PROVEE = tmp.COD_PROVEE
INNER JOIN CPA57
    ON CPA01.PROVINCIA = CPA57.COD_PROVIN
LEFT JOIN CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
GROUP BY
    CPA01.COD_PROVEE, CPA01.NOM_PROVEE, tmp.ANO, tmp.MES, tmp.DIA;

GO

-- Vista: CPA05_PAGOS_A_REALIZAR_COMPRAS
SELECT TMP.FECHA_VTO AS FECHA_VTO, T_COMP AS T_COMP, N_COMP AS N_COMP, ANO, MES, DIA, CPA01.COD_PROVEE AS COD_PROVEE, CPA01.NOM_PROVEE AS NOM_PROVEE, CPA01.CONTACTO AS CONTACTO, CPA01.TELEFONO_1 AS TELEFONO_1, SUM(IMPORTETOTAL) AS TOTAL
FROM
    (SELECT CPA04.T_COMP, CPA04.N_COMP, CPA04.FECHA_CONT, CPA54.FECHA_VTO, YEAR(CPA54.FECHA_VTO) AS ANO, CASE WHEN MONTH(CPA54.FECHA_VTO) = '1' THEN '01 Enero' WHEN MONTH(CPA54.FECHA_VTO) = '2' THEN '02 Febrero' WHEN MONTH(CPA54.FECHA_VTO) = '3' THEN '03 Marzo' WHEN MONTH(CPA54.FECHA_VTO) = '4' THEN '04 Abril' WHEN MONTH(CPA54.FECHA_VTO) = '5' THEN '05 Mayo' WHEN MONTH(CPA54.FECHA_VTO) = '6' THEN '06 Junio' WHEN MONTH(CPA54.FECHA_VTO) = '7' THEN '07 Julio' WHEN MONTH(CPA54.FECHA_VTO) = '8' THEN '08 Agosto' WHEN MONTH(CPA54.FECHA_VTO) = '9' THEN '09 Septiembre' WHEN MONTH(CPA54.FECHA_VTO) = '10' THEN '10 Octubre' WHEN MONTH(CPA54.FECHA_VTO) = '11' THEN '11 Noviembre' WHEN MONTH(CPA54.FECHA_VTO) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA54.FECHA_VTO) AS DIA, CPA04.COD_PROVEE, CASE WHEN CPA04.NRO_SUCURS <> 0 THEN CPA04.NRO_SUCURS ELSE (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) END AS NRO_SUCURS, CPA54.IMPORT_VTO + ISNULL((SELECT SUM(CASE CPA21.CRE_DEB WHEN 'D' THEN +(CPA05.IMPORT_CAN) ELSE -(CPA05.IMPORT_CAN) END) AS IMPUTACIONES
FROM
    CPA05
LEFT JOIN
    CPA21
    ON CPA21.T_COMP = CPA05.T_COMP_CAN
WHERE
    CPA05.COD_PROVEE = CPA54.COD_PROVEE AND CPA05.T_COMP_FAC = CPA54.T_COMP AND CPA05.N_COMP_FAC = CPA54.N_COMP AND CPA05.FECHA_VTO = CPA54.FECHA_VTO), 0) AS IMPORTETOTAL, CPA04.COD_CLASIF, DESCRIP
FROM
    CPA04
INNER JOIN
    CPA54
    ON CPA04.COD_PROVEE = CPA54.COD_PROVEE AND CPA54.N_COMP = CPA04.N_COMP AND CPA54.T_COMP = CPA04.T_COMP
LEFT JOIN
    GVA81
    ON CPA04.COD_CLASIF = GVA81.COD_CLASIF
WHERE
    CPA04.ESTADO = 'PEN' AND CPA54.ESTADO_VTO <> 'PAG') AS TMP
LEFT JOIN
    CPA01
    ON CPA01.COD_PROVEE = TMP.COD_PROVEE
LEFT JOIN
    CPA57
    ON CPA01.PROVINCIA = CPA57.COD_PROVIN
LEFT JOIN
    SUCURSAL
    ON TMP.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
GROUP BY
    TMP.FECHA_VTO, ANO, MES, DIA, T_COMP, N_COMP, CPA01.COD_PROVEE, CPA01.NOM_PROVEE, CPA01.CONTACTO, CPA01.TELEFONO_1

GO

-- Vista: CPA05_PAGOS_REALIZADOS_COMPRAS
SELECT TMP.COD_PROVEE AS COD_PROVEE, ANO, MES, DIA, CPA01.NOM_PROVEE AS NOM_PROVEE, CASE WHEN TMP.ESTADO = 'CTA' THEN TMP.FECHA_CONT ELSE CPA05.F_COMP_CAN END AS FECHA_PAGO, SUM(CASE WHEN TMP.ESTADO = 'CTA' THEN OP.IMPORTE_OP ELSE CPA05.IMPORT_CAN END) AS TOTAL
FROM
    (SELECT T_COMP, N_COMP, FECHA_CONT, COD_PROVEE, YEAR(FECHA_CONT) AS ANO, CASE WHEN MONTH(FECHA_CONT) = '1' THEN '01 Enero' WHEN MONTH(FECHA_CONT) = '2' THEN '02 Febrero' WHEN MONTH(FECHA_CONT) = '3' THEN '03 Marzo' WHEN MONTH(FECHA_CONT) = '4' THEN '04 Abril' WHEN MONTH(FECHA_CONT) = '5' THEN '05 Mayo' WHEN MONTH(FECHA_CONT) = '6' THEN '06 Junio' WHEN MONTH(FECHA_CONT) = '7' THEN '07 Julio' WHEN MONTH(FECHA_CONT) = '8' THEN '08 Agosto' WHEN MONTH(FECHA_CONT) = '9' THEN '09 Septiembre' WHEN MONTH(FECHA_CONT) = '10' THEN '10 Octubre' WHEN MONTH(FECHA_CONT) = '11' THEN '11 Noviembre' WHEN MONTH(FECHA_CONT) = '12' THEN '12 Diciembre' END AS MES, DAY(FECHA_CONT) AS DIA, ESTADO, CASE WHEN CPA04.NRO_SUCURS <> 0 THEN CPA04.NRO_SUCURS ELSE (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) END AS NRO_SUCURS, TCOMP_IN_C, NCOMP_IN_C, IMPORTE_TO, COD_CLASIF
FROM
    CPA04) AS TMP
LEFT JOIN
    CPA05
    ON TMP.T_COMP = CPA05.T_COMP_FAC AND TMP.N_COMP = CPA05.N_COMP_FAC AND TMP.COD_PROVEE = CPA05.COD_PROVEE
LEFT JOIN
    (SELECT cpa04.tcomp_in_c, cpa04.ncomp_in_c, cpa04.t_comp, cpa04.n_comp, cpa04.cod_clasif, cpa04.cod_provee, cpa04.importe_to - ISNULL(SUM(cpa05.import_can), 0) AS importe_op
FROM
    cpa04
LEFT JOIN
    cpa05
    ON cpa04.t_comp = cpa05.t_comp_can AND cpa04.n_comp = cpa05.n_comp_can AND cpa04.cod_provee = cpa05.cod_provee
WHERE
    cpa04.tcomp_in_c = 'OP'
GROUP BY
    cpa04.tcomp_in_c, cpa04.ncomp_in_c, cpa04.t_comp, cpa04.n_comp, cpa04.cod_provee, cpa04.importe_to, cpa04.cod_clasif) op
    ON (op.tcomp_in_c = tmp.tcomp_in_c AND op.ncomp_in_c = tmp.ncomp_in_c) OR (op.t_comp = cpa05.t_comp_can AND op.n_comp = cpa05.n_comp_can)
LEFT JOIN
    cpa54
    ON cpa54.cod_provee = cpa05.cod_provee AND cpa54.fecha_vto = cpa05.fecha_vto AND cpa54.t_comp = cpa05.t_comp_fac AND cpa54.n_comp = cpa05.n_comp_fac AND cpa54.estado_vto = 'PAG'
LEFT JOIN
    CPA01
    ON CPA01.COD_PROVEE = TMP.COD_PROVEE
LEFT JOIN
    SUCURSAL
    ON SUCURSAL.NRO_SUCURSAL = TMP.NRO_SUCURS
LEFT JOIN
    CPA94
    ON CPA94.T_COMP = CPA54.T_COMP AND CPA94.N_COMP = CPA54.N_COMP AND CPA94.FECHA_VTO = CPA54.FECHA_VTO AND CPA94.COD_PROVEE = CPA54.COD_PROVEE
LEFT JOIN
    CPA93
    ON CPA93.N_PAGO_M = CPA94.N_PAGO_M AND CPA93.ESTADO = 'P'
LEFT JOIN
    GVA81
    ON (TMP.cod_clasif = gva81.cod_clasif OR OP.cod_clasif = gva81.cod_clasif)
WHERE
    ((tmp.t_comp = 'FAC' AND tmp.estado <> '***' AND cpa05.t_comp_can = 'O/P') OR (tmp.t_comp = 'O/P' AND tmp.estado = 'CTA'))
GROUP BY
    TMP.COD_PROVEE, ANO, MES, DIA, CPA01.NOM_PROVEE, CASE WHEN TMP.ESTADO = 'CTA' THEN TMP.FECHA_CONT ELSE CPA05.F_COMP_CAN END

GO

-- Vista: CPA04_DEUDAS_VENCIDAS_COMPRAS
SELECT CPA01.COD_PROVEE AS COD_PROVEE, CPA01.NOM_PROVEE AS NOM_PROVEE, CPA01.CONTACTO AS CONTACTO, CPA01.TELEFONO_1 AS TELEFONO_1, ANO, MES, DIA, SUM(IMPORTETOTAL) AS TOTAL
FROM
    (SELECT CPA04.T_COMP, CPA04.N_COMP, CPA04.FECHA_CONT, CPA54.FECHA_VTO, YEAR(CPA54.FECHA_VTO) AS ANO, CASE WHEN MONTH(CPA54.FECHA_VTO) = '1' THEN '01 Enero' WHEN MONTH(CPA54.FECHA_VTO) = '2' THEN '02 Febrero' WHEN MONTH(CPA54.FECHA_VTO) = '3' THEN '03 Marzo' WHEN MONTH(CPA54.FECHA_VTO) = '4' THEN '04 Abril' WHEN MONTH(CPA54.FECHA_VTO) = '5' THEN '05 Mayo' WHEN MONTH(CPA54.FECHA_VTO) = '6' THEN '06 Junio' WHEN MONTH(CPA54.FECHA_VTO) = '7' THEN '07 Julio' WHEN MONTH(CPA54.FECHA_VTO) = '8' THEN '08 Agosto' WHEN MONTH(CPA54.FECHA_VTO) = '9' THEN '09 Septiembre' WHEN MONTH(CPA54.FECHA_VTO) = '10' THEN '10 Octubre' WHEN MONTH(CPA54.FECHA_VTO) = '11' THEN '11 Noviembre' WHEN MONTH(CPA54.FECHA_VTO) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA54.FECHA_VTO) AS DIA, CPA04.COD_PROVEE, CASE WHEN CPA04.NRO_SUCURS <> 0 THEN CPA04.NRO_SUCURS ELSE (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) END AS NRO_SUCURS, CPA54.IMPORT_VTO + ISNULL((SELECT SUM(CASE WHEN CPA21.CRE_DEB = 'D' THEN (+1) WHEN CPA21.CRE_DEB = 'C' THEN (-1) WHEN CPA05.T_COMP_CAN = 'O/P' THEN (-1) END * (CPA05.IMPORT_CAN)) AS IMPUTACIONES
FROM
    CPA05
LEFT JOIN
    CPA21
    ON CPA21.T_COMP = CPA05.T_COMP_CAN
WHERE
    CPA05.COD_PROVEE = CPA54.COD_PROVEE AND CPA05.T_COMP_FAC = CPA54.T_COMP AND CPA05.N_COMP_FAC = CPA54.N_COMP AND CPA05.FECHA_VTO = CPA54.FECHA_VTO), 0) AS IMPORTETOTAL, CPA54.IMPORT_VTO, MON_CTE, COD_CLASIF
FROM
    CPA04
INNER JOIN
    CPA54
    ON CPA04.COD_PROVEE = CPA54.COD_PROVEE AND CPA54.N_COMP = CPA04.N_COMP AND CPA54.T_COMP = CPA04.T_COMP
WHERE
    CPA04.ESTADO = 'PEN' AND CPA54.ESTADO_VTO <> 'PAG' AND CPA54.FECHA_VTO < CAST(CAST(CAST(GETDATE() AS real) AS int) AS datetime)) AS TMP
LEFT JOIN
    CPA01
    ON CPA01.COD_PROVEE = TMP.COD_PROVEE
LEFT JOIN
    CPA57
    ON CPA01.PROVINCIA = CPA57.COD_PROVIN
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
LEFT JOIN
    SUCURSAL
    ON TMP.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    GVA81
    ON TMP.COD_CLASIF = GVA81.COD_CLASIF
GROUP BY
    CPA01.COD_PROVEE, CPA01.NOM_PROVEE, CPA01.CONTACTO, CPA01.TELEFONO_1, ANO, MES, DIA

GO

-- Vista: CPA04_DEUDAS_A_VENCER_COMPRAS
SELECT CPA01.COD_PROVEE AS COD_PROVEE, NOM_PROVEE AS NOM_PROVEE, CPA01.CONTACTO AS CONTACTO, CPA01.TELEFONO_1 AS TELEFONO_1, ANO, MES, DIA, SUM(IMPORTETOTAL) AS TOTAL
FROM
    (SELECT CPA04.T_COMP, CPA04.N_COMP, CPA04.FECHA_CONT, CPA04.COD_PROVEE, CASE WHEN CPA04.NRO_SUCURS <> 0 THEN CPA04.NRO_SUCURS ELSE (SELECT SUC.NRO_SUCURSAL
FROM
    EMPRESA JOIN SUCURSAL SUC
    ON (EMPRESA.ID_SUCURSAL = SUC.ID_SUCURSAL)) END AS NRO_SUCURS, CPA54.FECHA_VTO, YEAR(CPA54.FECHA_VTO) AS ANO, CASE WHEN MONTH(CPA54.FECHA_VTO) = '1' THEN '01 Enero' WHEN MONTH(CPA54.FECHA_VTO) = '2' THEN '02 Febrero' WHEN MONTH(CPA54.FECHA_VTO) = '3' THEN '03 Marzo' WHEN MONTH(CPA54.FECHA_VTO) = '4' THEN '04 Abril' WHEN MONTH(CPA54.FECHA_VTO) = '5' THEN '05 Mayo' WHEN MONTH(CPA54.FECHA_VTO) = '6' THEN '06 Junio' WHEN MONTH(CPA54.FECHA_VTO) = '7' THEN '07 Julio' WHEN MONTH(CPA54.FECHA_VTO) = '8' THEN '08 Agosto' WHEN MONTH(CPA54.FECHA_VTO) = '9' THEN '09 Septiembre' WHEN MONTH(CPA54.FECHA_VTO) = '10' THEN '10 Octubre' WHEN MONTH(CPA54.FECHA_VTO) = '11' THEN '11 Noviembre' WHEN MONTH(CPA54.FECHA_VTO) = '12' THEN '12 Diciembre' END AS MES, DAY(CPA54.FECHA_VTO) AS DIA, CPA54.IMPORT_VTO + ISNULL((SELECT SUM(CASE WHEN CPA21.CRE_DEB = 'D' THEN (+1) WHEN CPA21.CRE_DEB = 'C' THEN (-1) WHEN CPA05.T_COMP_CAN = 'O/P' THEN (-1) END * (CPA05.IMPORT_CAN)) AS IMPUTACIONES
FROM
    CPA05
LEFT JOIN
    CPA21
    ON CPA21.T_COMP = CPA05.T_COMP_CAN
WHERE
    CPA05.COD_PROVEE = CPA54.COD_PROVEE AND CPA05.T_COMP_FAC = CPA54.T_COMP AND CPA05.N_COMP_FAC = CPA54.N_COMP AND CPA05.FECHA_VTO = CPA54.FECHA_VTO), 0) AS IMPORTETOTAL, CPA54.IMPORT_VTO, MON_CTE, COD_CLASIF
FROM
    CPA04
INNER JOIN
    CPA54
    ON CPA04.COD_PROVEE = CPA54.COD_PROVEE AND CPA54.N_COMP = CPA04.N_COMP AND CPA54.T_COMP = CPA04.T_COMP
WHERE
    CPA04.ESTADO = 'PEN' AND CPA54.ESTADO_VTO <> 'PAG' AND CPA54.FECHA_VTO > CAST(CAST(CAST(GETDATE() AS real) AS int) AS datetime)) AS TMP
LEFT JOIN
    CPA01
    ON TMP.COD_PROVEE = CPA01.COD_PROVEE
LEFT JOIN
    CPA57
    ON CPA01.PROVINCIA = CPA57.COD_PROVIN
LEFT JOIN
    CPA108
    ON CPA57.COD_PAIS = CPA108.COD_PAIS
LEFT JOIN
    SUCURSAL
    ON TMP.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL
LEFT JOIN
    GVA81
    ON TMP.COD_CLASIF = GVA81.COD_CLASIF
GROUP BY
    CPA01.COD_PROVEE, NOM_PROVEE, CPA01.CONTACTO, CPA01.TELEFONO_1, ANO, MES, DIA

GO

-- Vista: CPA01_PROVEEDORES_COMPRAS
SELECT '000000' AS COD_PROVEE, 'OCASIONAL' AS NOM_PROVEE, '' AS N_CUIT, '' AS DOMICILIO, '' AS C_POSTAL, '' AS LOCALIDAD, '' AS COD_RUBRO, '' AS PROVINCIA
FROM
    GVA12 UNION
SELECT
    COD_PROVEE COLLATE Modern_Spanish_CI_AI AS COD_PROVEE, ISNULL(CPA01.NOM_PROVEE, 'OCASIONAL') COLLATE Modern_Spanish_CI_AI AS NOM_PROVEE, N_CUIT COLLATE Modern_Spanish_CI_AI AS N_CUIT, DOMICILIO COLLATE Modern_Spanish_CI_AI AS DOMICILIO, C_POSTAL COLLATE Modern_Spanish_CI_AI AS C_POSTAL, LOCALIDAD COLLATE Modern_Spanish_CI_AI AS LOCALIDAD, COD_RUBRO COLLATE Modern_Spanish_CI_AI AS COD_RUBRO, PROVINCIA COLLATE Modern_Spanish_CI_AI AS PROVINCIA
FROM
    CPA01

GO

-- Vista: GVA14_CLIENTES_VENTAS
SELECT '000000' AS COD_CLIENT, 'OCASIONAL' AS RAZON_SOCI, 'OCASIONAL' AS NOM_COM, '' AS CUIT, '' AS COD_ZONA, '' AS DOMICILIO, '' AS C_POSTAL, '' AS LOCALIDAD, '' AS COD_PROVIN, '' AS COD_RUBRO
FROM
    GVA12 UNION
SELECT
    COD_CLIENT AS COD_CLIENT, CASE COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE NOM_COM END AS NOM_COM, CASE COD_CLIENT WHEN '000000' THEN 'OCASIONAL' ELSE RAZON_SOCI END AS RAZON_SOCI, CUIT AS CUIT, COD_ZONA AS COD_ZONA, DOMICILIO AS DOMICILIO, C_POSTAL AS C_POSTAL, LOCALIDAD AS LOCALIDAD, COD_PROVIN AS COD_PROVIN, COD_RUBRO AS COD_RUBRO
FROM
    GVA14

GO

